<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Ù…Ù† Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ - Ù†Ø³Ø®Ø© Ø§Ù„Ø¶Ø§ÙŠØ¹ Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --accent: #10b981;
      --danger: #ef4444;
      --bg-dark: #0f172a;
    }

    /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù…Ø¸Ù‡Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª */
    * {
      scrollbar-width: none;
      -ms-overflow-style: none;
      -webkit-tap-highlight-color: transparent;
    }

    *::-webkit-scrollbar {
      display: none;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background-color: var(--bg-dark);
      background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
      color: #f8fafc;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      overflow: hidden;
      touch-action: manipulation;
      padding: env(safe-area-inset-top) 1rem env(safe-area-inset-bottom) 1rem;
    }

    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ ÙˆØ¶Ø¹ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø£ÙÙ‚ÙŠ Ù„Ù„Ø¬ÙˆØ§Ù„Ø§Øª ÙÙ‚Ø· */
    #orientation-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-dark);
      z-index: 10000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }

    @media screen and (orientation: landscape) and (pointer: coarse) {
      #orientation-overlay {
        display: flex;
      }
    }

    .glass-panel {
      /*background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 2.5rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);*/
      max-height: 94vh;
      width: 100%;
      max-width: 550px;
      overflow-y: auto;
      position: relative;
      padding: 1.5rem;
      z-index: 10;
    }

    .btn-gradient {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-gradient:active {
      transform: scale(0.96);
    }

    .category-card {
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      padding: 1rem 0.5rem;
      border-radius: 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      text-align: center;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
    }

    .category-card.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.25);
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }

    .rule-card {
      background: rgba(255, 255, 255, 0.03);
      border-right: 5px solid var(--primary);
      padding: 1.25rem;
      border-radius: 1.25rem;
      margin-bottom: 1rem;
      text-align: right;
    }

    .avatar-btn {
      font-size: 1.6rem;
      padding: 0.5rem;
      border-radius: 1rem;
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.2s;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-btn.selected {
      background: var(--primary);
      transform: scale(1.15);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
    }

    #confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -20px;
    }

    .detective-float {
      animation: smoothFloat 10s ease-in-out infinite;
    }

    @keyframes smoothFloat {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
      }

      50% {
        transform: translateY(-30px) rotate(5deg);
      }
    }

    .break-word-custom {
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
      max-width: 100%;
      line-height: 1.4;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 10px;
      background: #1e293b;
      border-radius: 15px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      background: var(--primary);
      border: 4px solid #fff;
      border-radius: 50%;
    }

    .custom-checkbox {
      appearance: none;
      width: 58px;
      height: 30px;
      background-color: #334155;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .custom-checkbox:checked {
      background-color: var(--primary);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
    }

    .custom-checkbox::before {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background-color: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: all 0.3s;
    }

    .custom-checkbox:checked::before {
      transform: translateX(28px);
    }
  </style>
</head>

<body>

  <div id="orientation-overlay">
    <div class="text-6xl mb-6 animate-bounce text-center text-center">ğŸ“±</div>
    <h2 class="text-2xl font-black text-white mb-4 text-center text-center">ÙŠØ±Ø¬Ù‰ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ù…ÙˆØ¯ÙŠ</h2>
    <p class="text-slate-400 font-bold text-center text-center text-center">Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…ØµÙ…Ù…Ø© Ù„Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ù…ÙˆØ¯ÙŠ Ù„Ø¶Ù…Ø§Ù†
      Ø£ÙØ¶Ù„ ØªØ¬Ø±Ø¨Ø©</p>
  </div>

  <div id="confetti-container"></div>

  <div id="app" class="w-full flex justify-center items-center">
    <!-- Ø²Ø± Ø§Ù„ØµÙˆØª -->
    <button onclick="toggleMute()" id="mute-toggle"
      class="fixed top-6 left-6 z-50 p-3 bg-white/10 rounded-full border border-white/10 text-xl shadow-lg hover:bg-white/20 transition-all">
      ğŸ”Š
    </button>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
    <div id="screen-start" class="glass-panel text-center">
      <div class="mb-14 detective-float text-8xl sm:text-9xl text-center text-center text-center">ğŸ•µï¸â€â™‚ï¸</div>
      <h1
        class="text-4xl sm:text-6xl font-black mb-8 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 via-purple-400 to-emerald-400 leading-normal text-center">
        Ù…Ù† Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ</h1>
      <p class="text-slate-400 text-base sm:text-xl mb-14 font-bold opacity-90 px-4 mt-6 leading-relaxed text-center">
        Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„ÙƒØ´Ù "Ø§Ù„Ø¶Ø§ÙŠØ¹" Ø¨ÙŠÙ†ÙƒÙ…!</p>
      <div class="space-y-4">
        <button onclick="showScreen('setup')"
          class="btn-gradient w-full py-6 rounded-3xl text-2xl font-black text-white shadow-2xl text-center">Ø¨Ø¯Ø¡
          Ø§Ù„ØªØ­Ø¯ÙŠ</button>
        <div class="grid grid-cols-2 gap-4 text-center">
          <button onclick="showScreen('leaderboard')"
            class="btn-secondary py-4 rounded-2xl font-bold border border-white/10 text-white shadow-sm text-center text-center">ğŸ†
            Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
          <button onclick="showScreen('rules')"
            class="btn-secondary py-4 rounded-2xl font-bold text-indigo-400 border border-indigo-400/20 shadow-sm text-center text-center">ğŸ“–
            ÙƒÙŠÙ Ù†Ù„Ø¹Ø¨ØŸ</button>
        </div>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <div id="screen-setup" class="glass-panel hidden text-right">
      <h2 class="text-2xl sm:text-3xl font-black mb-6 text-center text-white font-black text-center text-center">âš™ï¸
        Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
      <div class="space-y-6">
        <div>
          <label class="text-slate-300 font-bold block mb-4 text-right">Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ø³ÙˆØ§Ù„Ù:</label>
          <div id="categories-grid" class="grid grid-cols-3 gap-2 text-center text-center text-center"></div>
        </div>

        <div id="custom-words-ui"
          class="bg-indigo-500/10 p-5 rounded-3xl border border-indigo-500/20 hidden text-right text-right">
          <label
            class="text-indigo-300 font-bold block mb-3 text-right text-sm font-black w-full text-right text-right text-right">Ø£Ø¶Ù
            ÙƒÙ„Ù…Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ© Ù„Ù„ÙØ¦Ø© (4 ÙƒÙ„Ù…Ø§Øª ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰):</label>
          <div class="flex gap-2">
            <input type="text" id="custom-word-input"
              class="flex-1 bg-slate-800 border-none rounded-xl p-4 text-white outline-none focus:ring-2 ring-indigo-500 text-sm text-right"
              placeholder="Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø©...">
            <button onclick="addCustomWord()"
              class="bg-indigo-600 px-6 rounded-2xl font-black text-white">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
          <div id="custom-words-list" class="flex flex-wrap gap-2 mt-4 max-h-32 overflow-y-auto justify-end"></div>
        </div>

        <div class="grid grid-cols-1 gap-4 text-right text-right">
          <div class="bg-white/5 p-4 rounded-2xl border border-white/10 text-right shadow-inner text-right">
            <div class="flex justify-between mb-3 flex-row-reverse text-right text-right text-right">
              <label class="text-slate-300 font-bold text-sm text-right">Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</label>
              <span class="text-indigo-400 font-mono font-black text-xl" id="val-players">3</span>
            </div>
            <input type="range" id="input-players" min="3" max="20" value="3" oninput="updateSetupInfo()">
          </div>
          <div class="bg-white/5 p-4 rounded-2xl border border-white/10 text-right shadow-inner text-right text-right">
            <div class="flex justify-between mb-3 flex-row-reverse text-right text-right text-right text-right">
              <label class="text-slate-300 font-bold text-sm text-right">ÙˆÙ‚Øª Ø§Ù„Ù†Ù‚Ø§Ø´</label>
              <span class="text-emerald-400 font-black text-lg" id="val-time-label">Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©</span>
            </div>
            <input type="range" id="input-time" min="30" max="300" step="30" value="60" oninput="updateSetupInfo()">
          </div>
        </div>

        <div class="space-y-3">
          <div id="double-agent-container"
            class="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between transition-all">
            <div class="text-right text-right text-right text-right text-right">
              <h4
                class="font-bold text-sm text-white font-black text-right text-right text-right text-right text-right">
                ğŸ­ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬</h4>
              <p
                class="text-[10px] text-slate-500 font-bold italic text-right text-right text-right text-right text-right">
                Ù…ØªØ§Ø­ Ù„Ù€ 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙØ£ÙƒØ«Ø±</p>
            </div>
            <input type="checkbox" id="check-double-agent" class="custom-checkbox">
          </div>

          <div id="undercover-container"
            class="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between transition-all">
            <div class="text-right text-right text-right text-right text-right text-right">
              <h4
                class="font-bold text-sm text-white font-black text-right text-right text-right text-right text-right text-right text-right">
                ğŸ•µï¸ Ø§Ù„Ù…Ù…ÙˆÙ‡</h4>
              <p
                class="text-[10px] text-slate-500 font-bold italic text-right text-right text-right text-right text-right text-right text-right">
                ÙŠÙ…Ù„Ùƒ ÙƒÙ„Ù…Ø© Ù…Ø´Ø§Ø¨Ù‡Ø© ÙˆÙŠØ¶Ù„Ù„ Ø§Ù„Ø¬Ù…ÙŠØ¹!</p>
            </div>
            <input type="checkbox" id="check-undercover" class="custom-checkbox">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 pt-4 text-center text-center">
          <button onclick="showScreen('start')"
            class="py-5 rounded-3xl btn-secondary font-bold text-lg border-2 border-white/5 text-white text-center">Ø±Ø¬ÙˆØ¹</button>
          <button onclick="checkAndNext()"
            class="py-5 rounded-3xl btn-gradient font-black text-white text-lg shadow-xl text-center">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ -->
    <div id="screen-names" class="glass-panel hidden text-right text-right text-right">
      <h2
        class="text-2xl sm:text-3xl font-black mb-8 text-center text-white text-right font-black text-center text-center text-center">
        ØªØ¬Ù‡ÙŠØ² ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ† ğŸ”</h2>
      <div id="names-container"
        class="space-y-4 mb-8 max-h-[50vh] overflow-y-auto px-1 text-right text-right text-right text-right"></div>
      <button onclick="startGame()"
        class="btn-gradient w-full py-6 rounded-3xl font-black text-white text-xl shadow-2xl text-center text-center">Ø§Ù†Ø·Ù„Ø§Ù‚!
        ğŸš€</button>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± -->
    <div id="screen-reveal" class="glass-panel hidden text-center">
      <div class="text-7xl sm:text-8xl mb-6 text-center text-center text-center text-center text-center">ğŸ“±</div>
      <p
        class="text-slate-400 mb-2 text-xl font-bold text-center text-center text-center text-center text-center text-center">
        Ù…Ø±Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ù‚Ù‚:</p>
      <h2 id="reveal-player-name"
        class="text-4xl sm:text-6xl font-black mb-10 text-indigo-400 text-center font-black text-center text-center text-center text-center">
      </h2>
      <div id="reveal-box"
        class="hidden p-8 bg-indigo-500/10 border-4 border-dashed border-indigo-500/20 rounded-3xl mb-10 animate-pulse shadow-inner text-center text-center text-center text-center">
        <p id="reveal-role-text" class="text-2xl sm:text-3xl font-bold mb-4 text-center text-center text-center"></p>
        <div id="reveal-img-placeholder"
          class="text-8xl sm:text-9xl mb-6 text-center text-center text-center text-center text-center text-center">
        </div>
        <p id="reveal-secret-word"
          class="text-4xl sm:text-5xl font-black text-white tracking-widest uppercase text-center break-word-custom text-center text-center text-center text-center">
        </p>
      </div>
      <button id="btn-reveal-action" onclick="toggleReveal()"
        class="btn-gradient w-full py-7 rounded-3xl font-black text-2xl text-white shadow-2xl text-center font-black text-center text-center text-center text-center">Ø¥Ø¸Ù‡Ø§Ø±
        Ø§Ù„Ø³Ø§Ù„ÙØ©</button>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ -->
    <div id="screen-game" class="glass-panel hidden text-center text-center text-center">
      <div class="flex justify-center mb-10 text-center text-center text-center text-center text-center">
        <div
          class="relative w-56 h-56 sm:w-72 sm:h-72 flex items-center justify-center text-center text-center text-center text-center text-center text-center">
          <svg class="absolute inset-0 w-full h-full -rotate-90 text-center text-center text-center"
            viewBox="0 0 200 200">
            <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>
            <circle id="timer-progress" cx="100" cy="100" r="90" fill="none" stroke="url(#timer-grad)" stroke-width="12"
              stroke-dasharray="565.48" stroke-dashoffset="0" stroke-linecap="round"
              class="transition-all duration-1000"></circle>
            <defs>
              <linearGradient id="timer-grad">
                <stop offset="0%" stop-color="#6366f1" />
                <stop offset="100%" stop-color="#10b981" />
              </linearGradient>
            </defs>
          </svg>
          <div id="game-timer"
            class="text-6xl sm:text-8xl font-black font-mono tracking-tighter text-white text-center text-center text-center text-center text-center text-center">
            00:00</div>
        </div>
      </div>
      <p
        class="text-2xl sm:text-3xl text-slate-200 mb-12 font-bold px-4 text-center text-white text-center text-center text-center">
        ØªÙ†Ø§Ù‚Ø´ÙˆØ§ Ø¨Ø°ÙƒØ§Ø¡.. Ù„Ø§ ØªÙƒØ´ÙÙˆØ§ Ø§Ù„Ø³Ø§Ù„ÙØ© Ù„Ù„Ø¶Ø§ÙŠØ¹!</p>
      <div class="grid grid-cols-2 gap-4 text-center text-center text-center text-center">
        <button onclick="endGameEarly()"
          class="py-5 bg-red-500/10 text-red-400 border-2 border-red-500/20 rounded-3xl font-black text-lg text-center font-black text-center text-center">Ø¥Ù†Ù‡Ø§Ø¡
          Ø§Ù„ÙˆÙ‚Øª</button>
        <button onclick="pauseTimer()" id="btn-pause"
          class="py-5 btn-secondary rounded-3xl font-black text-lg border-2 border-white/5 text-white text-center font-black text-center text-center">Ø¥ÙŠÙ‚Ø§Ù
          Ù…Ø¤Ù‚Øª</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØµÙˆÙŠØª -->
    <div id="screen-voting" class="glass-panel hidden text-center text-center text-center text-center">
      <h2
        class="text-3xl sm:text-5xl font-black mb-4 text-white text-center font-black text-center text-center text-center text-center text-center">
        Ù…Ù† Ø§Ù„Ø¶Ø§ÙŠØ¹ØŸ âš–ï¸</h2>
      <p
        class="text-slate-400 mb-8 text-lg font-semibold underline decoration-indigo-500 text-center text-center text-center text-center text-center text-center">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…ØªÙ‡Ù… Ù…Ø¨Ø§Ø´Ø±Ø©</p>
      <div id="voting-grid"
        class="grid grid-cols-2 gap-4 mb-8 max-h-[50vh] overflow-y-auto px-2 text-center text-white text-center text-center text-center text-center">
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ† -->
    <div id="screen-guess"
      class="glass-panel hidden text-center text-center text-center text-center text-center text-center text-center">
      <h2
        class="text-3xl sm:text-4xl font-black mb-6 text-red-400 text-center font-black text-center text-center text-center text-center text-center text-center">
        Ù„Ù‚Ø¯ ÙƒØ´ÙÙˆÙƒ! ğŸ¯</h2>
      <p
        class="text-slate-300 mb-10 text-xl font-bold leading-relaxed text-center text-white text-center text-center text-center text-center text-center text-center text-center">
        Ø®Ù…Ù† Ø§Ù„Ø³Ø§Ù„ÙØ© Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©!</p>
      <div id="guess-options"
        class="grid grid-cols-1 gap-4 mb-8 text-center text-white text-center text-center text-center text-center text-center text-center">
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
    <div id="screen-final"
      class="glass-panel hidden text-center overflow-y-auto text-center text-center text-center text-center text-center text-center">
      <div id="final-status-emoji"
        class="text-8xl sm:text-9xl mb-6 text-center text-center text-center text-center text-center text-center text-center">
        ğŸ†</div>
      <h2 id="final-result-title"
        class="text-3xl sm:text-5xl font-black mb-6 text-center text-white font-black text-center text-center text-center text-center text-center text-center text-center">
      </h2>

      <div
        class="bg-slate-800/60 p-8 rounded-[2.5rem] mb-8 border border-white/10 shadow-2xl text-center text-center text-center text-center text-center text-center text-center">
        <p
          class="text-slate-400 mb-3 font-bold text-sm uppercase tracking-widest text-center text-center text-center text-center text-center text-center text-center text-center">
          Ø§Ù„Ø³Ø§Ù„ÙØ© ÙƒØ§Ù†Øª:</p>
        <div id="final-word-emoji"
          class="text-7xl sm:text-8xl mb-3 text-center text-center text-center text-center text-center text-center text-center text-center text-center">
        </div>
        <p id="final-secret-word"
          class="text-5xl sm:text-7xl font-black text-emerald-400 mb-4 tracking-wider break-word-custom text-center text-center text-center text-center text-center text-center text-center text-center">
        </p>
        <p id="topic-description"
          class="text-lg sm:text-xl text-indigo-100 opacity-80 italic text-center text-center text-center text-center text-center text-center text-center text-center text-center">
        </p>
      </div>

      <div class="mb-10 text-right text-right text-right text-right text-right text-right text-right text-right">
        <h3
          class="text-2xl sm:text-3xl font-black mb-6 text-center text-white font-black text-center text-right text-right text-right text-right text-right text-right">
          ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø±</h3>
        <div id="final-leaderboard" class="space-y-3 text-right text-right text-right text-right"></div>
      </div>

      <div class="grid grid-cols-1 gap-4 text-center text-center text-center text-center text-center text-center">
        <button onclick="restartSameGame()"
          class="btn-gradient py-6 rounded-[2rem] font-black text-white text-2xl shadow-2xl text-center font-black text-center text-center text-center">Ø¬ÙˆÙ„Ø©
          Ø¬Ø¯ÙŠØ¯Ø© ğŸ”</button>
        <button onclick="openCategoryModal()"
          class="btn-secondary py-5 rounded-2xl font-bold text-indigo-300 text-lg border border-indigo-500/20 shadow-md text-white text-center font-black text-center text-center">ØªØºÙŠÙŠØ±
          Ø§Ù„ÙØ¦Ø© ÙÙ‚Ø· âš™ï¸</button>
        <button onclick="showScreen('start')"
          class="py-3 text-slate-500 underline text-base font-bold text-center text-center text-center text-center">Ø§Ù„Ø¹ÙˆØ¯Ø©
          Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© -->
    <div id="screen-leaderboard"
      class="glass-panel hidden text-center text-right text-right text-right text-right text-right">
      <h2
        class="text-3xl font-black mb-10 text-center text-white text-right font-black text-center text-right text-right text-right text-right text-right">
        ğŸ† Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø³ÙˆØ§Ù„Ù</h2>
      <p
        class="text-slate-500 text-xs mb-4 text-center text-right text-right text-right text-right text-right text-right">
        (Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡)</p>
      <div id="leaderboard-list"
        class="space-y-4 mb-10 max-h-[60vh] overflow-y-auto px-2 text-right text-center text-right text-right text-right text-right text-right">
      </div>
      <div id="leaderboard-buttons" class="flex justify-center gap-4 text-center text-center text-center text-center">
        <button onclick="showScreen('start')" id="btn-close-lb"
          class="flex-1 py-5 btn-secondary rounded-3xl font-black border border-white/10 text-white min-w-[140px] text-center font-black text-center text-center">Ø¥ØºÙ„Ø§Ù‚</button>
        <button id="btn-reset-points-trigger" onclick="confirmReset()"
          class="flex-1 py-5 bg-red-600/20 text-red-500 rounded-3xl font-black border border-red-500/20 text-sm hidden min-w-[140px] text-center font-black text-center text-center">ØªØµÙÙŠØ±
          Ø§Ù„Ù†Ù‚Ø§Ø·</button>
      </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† -->
    <div id="screen-rules"
      class="glass-panel hidden text-right text-right text-right text-right text-right text-right text-right text-right text-right">
      <h2
        class="text-3xl sm:text-4xl font-black mb-10 text-center text-indigo-400 border-b-4 border-indigo-500/10 pb-6 text-center font-black text-right text-center text-right text-center text-right text-center text-right text-center">
        ğŸ“œ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø³Ø§Ù„ÙØ© Ø§Ù„Ø´Ø§Ù…Ù„</h2>

      <div class="space-y-6 text-right text-right text-right text-right text-right text-right">
        <div class="rule-card text-right">
          <h4
            class="font-black text-indigo-400 mb-3 flex items-center justify-start gap-3 text-xl text-right text-right text-right text-right text-right text-right">
            <span class="order-first">â“</span> Ù…Ø§ Ù‡ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ</h4>
          <p
            class="text-base leading-relaxed text-slate-300 font-semibold italic text-right text-right text-right text-right text-right text-right text-right text-right">
            Ù„Ø¹Ø¨Ø© Ø°ÙƒØ§Ø¡ ÙˆØªÙ…ÙˆÙŠÙ‡ Ø¬Ù…Ø§Ø¹ÙŠØ©. ÙÙŠ ÙƒÙ„ Ø¬ÙˆÙ„Ø©ØŒ ØªÙˆØ¬Ø¯ "Ø³Ø§Ù„ÙØ©" ÙŠØ¹Ø±ÙÙ‡Ø§ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø¥Ù„Ø§ <span
              class="highlight-text font-black text-white text-right text-right text-right text-right text-right text-right text-right text-right">Ø´Ø®Øµ
              ÙˆØ§Ø­Ø¯</span> ÙŠØ³Ù…Ù‰ "Ø§Ù„Ø¶Ø§ÙŠØ¹".</p>
        </div>

        <div class="rule-card text-right">
          <h4
            class="font-black text-indigo-400 mb-3 flex items-center justify-start gap-3 text-xl font-black text-right text-right text-right text-right text-right text-right text-right text-right text-right">
            <span class="order-first">ğŸ­</span> Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ´Ø±ÙˆØ· Ø§Ù„ÙÙˆØ²</h4>
          <ul
            class="text-sm space-y-4 font-bold text-slate-300 text-right text-right text-right text-right text-right text-right text-right text-right text-right">
            <li class="text-right">ğŸ•µï¸ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ†: ÙŠÙÙˆØ²ÙˆÙ† Ø¥Ø°Ø§ ÙƒØ´ÙÙˆØ§ Ø§Ù„Ø¶Ø§ÙŠØ¹ØŒ ÙˆÙØ´Ù„ ÙÙŠ ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø³Ø§Ù„ÙØ©.</li>
            <li class="text-right">ğŸŒ«ï¸ Ø§Ù„Ø¶Ø§ÙŠØ¹: ÙŠÙÙˆØ² Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙƒØ´Ù Ø£Ùˆ Ø¥Ø°Ø§ Ù†Ø¬Ø­ ÙÙŠ ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø³Ø§Ù„ÙØ© ØµØ­.</li>
            <li class="text-right">ğŸ­ Ø§Ù„Ø¹Ù…ÙŠÙ„: ÙŠÙÙˆØ² Ø¥Ø°Ø§ ÙØ§Ø² Ø§Ù„Ø¶Ø§ÙŠØ¹ Ø¨Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ Ø³Ø±Ø§Ù‹.</li>
            <li class="text-right">ğŸ¤« Ø§Ù„Ù…Ù…ÙˆÙ‡: ÙŠÙ…Ù„Ùƒ ÙƒÙ„Ù…Ø© Ù‚Ø±ÙŠØ¨Ø© ÙˆÙŠÙÙˆØ² Ø¥Ø°Ø§ Ø¨Ù‚ÙŠ Ù…ØªØ®ÙÙŠØ§Ù‹.</li>
          </ul>
        </div>

        <div class="rule-card text-right">
          <h4
            class="font-black text-indigo-400 mb-3 flex items-center justify-start gap-3 text-xl font-black text-right text-right text-right text-right text-right text-right text-right text-right text-right text-right">
            <span class="order-first">ğŸ“Š</span> Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·ÙˆØ±</h4>
          <div
            class="text-xs space-y-3 font-bold text-right leading-relaxed text-right text-right text-right text-right text-right text-right text-right">
            <div class="p-3 bg-emerald-500/10 rounded-xl border border-emerald-500/20 text-right text-right text-right">
              <p class="text-emerald-400 mb-1 text-right text-right text-right text-right">ğŸ•µï¸ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ†:</p>
              <p class="text-slate-300 text-right text-right text-right text-right">Ø§Ù„ÙÙˆØ²: <span
                  class="text-white text-right text-right">+1 Ù†Ù‚Ø·Ø©</span> | Ø§Ù„Ø®Ø³Ø§Ø±Ø©: <span
                  class="text-white text-right text-right">0 Ù†Ù‚Ø·Ø©</span></p>
            </div>
            <div
              class="p-3 bg-indigo-500/10 rounded-xl border border-indigo-500/20 text-right text-right text-right text-right">
              <p class="text-indigo-400 mb-1 text-right text-right text-right text-right text-right">ğŸŒ«ï¸ Ø§Ù„Ø¶Ø§ÙŠØ¹ / ğŸ­
                Ø§Ù„Ø¹Ù…ÙŠÙ„ / ğŸ¤« Ø§Ù„Ù…Ù…ÙˆÙ‡:</p>
              <p class="text-slate-300 text-right text-right text-right text-right text-right">Ø§Ù„ÙÙˆØ²: <span
                  class="text-white text-right text-right text-right">+2 Ù†Ù‚Ø·Ø©</span> | Ø§Ù„Ø®Ø³Ø§Ø±Ø©: <span
                  class="text-white text-right text-right text-right">0 Ù†Ù‚Ø·Ø©</span></p>
            </div>
          </div>
        </div>
      </div>
      <button onclick="showScreen('start')"
        class="btn-gradient w-full py-6 rounded-3xl mt-10 font-black text-white shadow-2xl text-2xl text-center font-black text-center text-center text-center">ØªÙ…ØŒ
        Ù„Ù†Ù„Ø¹Ø¨! ğŸ”¥</button>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
  <div id="modal-stats"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[500] p-6 backdrop-blur-md text-center text-center text-center text-center text-center text-center text-center">
    <div
      class="glass-panel max-w-sm w-full text-center text-center text-center text-center text-center text-center text-center text-center">
      <div id="player-stat-avatar"
        class="text-6xl mb-4 text-center text-center text-center text-center text-center text-center"></div>
      <h3 id="player-stat-name"
        class="text-2xl font-black text-white mb-4 text-center font-black text-center text-center text-center text-center text-center text-center">
      </h3>

      <div
        class="bg-white/5 p-4 rounded-3xl border border-white/10 mb-6 text-center text-center text-center text-center text-center text-center">
        <p class="text-slate-400 text-xs mb-2 font-bold text-center text-center text-center text-center text-center">
          Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø§Ø·</p>
        <div class="grid grid-cols-2 gap-y-4 gap-x-2 text-center text-center text-center text-center text-center">
          <div class="text-center border-b border-l border-white/5 pb-2 text-center text-center text-center">
            <p class="text-indigo-400 text-lg font-black text-center text-center" id="stat-total-games">0</p>
            <p class="text-[10px] text-slate-500 uppercase text-center text-center">Ù„Ø¹Ø¨Ø©</p>
          </div>
          <div class="text-center border-b border-white/5 pb-2 text-center text-center text-center">
            <p class="text-yellow-400 text-lg font-black text-center text-center" id="stat-total-points">0</p>
            <p class="text-[10px] text-slate-500 uppercase text-center text-center">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
          </div>
          <div class="text-center border-l border-white/5 pt-2 text-center text-center text-center">
            <p class="text-emerald-400 text-lg font-black text-center text-center" id="stat-total-wins">0</p>
            <p class="text-[10px] text-slate-500 uppercase text-center text-center">ÙÙˆØ²</p>
          </div>
          <div class="text-center pt-2 text-center text-center text-center">
            <p class="text-red-400 text-lg font-black text-center text-center" id="stat-total-losses">0</p>
            <p class="text-[10px] text-slate-500 uppercase text-center text-center">Ø®Ø³Ø§Ø±Ø©</p>
          </div>
        </div>
      </div>

      <p class="text-slate-400 text-[10px] mb-3 text-right font-bold text-right text-right">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±:</p>
      <div class="grid grid-cols-2 gap-4 mb-8 text-right text-right text-right text-right">
        <div class="bg-emerald-500/10 p-3 rounded-2xl border border-emerald-500/20 text-right text-right text-right">
          <p class="text-[10px] text-emerald-400 font-bold mb-1 text-right text-right text-right">ğŸ•µï¸ Ù…Ø­Ù‚Ù‚</p>
          <div class="flex justify-between text-xs font-black text-right text-right text-right"><span>ÙÙˆØ²: <span
                id="stat-det-w">0</span></span><span>Ø®Ø³Ø§Ø±Ø©: <span id="stat-det-l">0</span></span></div>
        </div>
        <div class="bg-indigo-500/10 p-3 rounded-2xl border border-indigo-500/20 text-right text-right text-right">
          <p class="text-[10px] text-indigo-400 font-bold mb-1 text-right text-right text-right">ğŸŒ«ï¸ Ø¶Ø§ÙŠØ¹</p>
          <div class="flex justify-between text-xs font-black text-right text-right text-right text-right"><span>ÙÙˆØ²:
              <span id="stat-out-w">0</span></span><span>Ø®Ø³Ø§Ø±Ø©: <span id="stat-out-l">0</span></span></div>
        </div>
        <div class="bg-orange-500/10 p-3 rounded-2xl border border-orange-500/20 text-right text-right text-right">
          <p class="text-[10px] text-orange-400 font-bold mb-1 text-right text-right text-right text-right">ğŸ­ Ø¹Ù…ÙŠÙ„</p>
          <div class="flex justify-between text-xs font-black text-right text-right text-right text-right"><span>ÙÙˆØ²:
              <span id="stat-agt-w">0</span></span><span>Ø®Ø³Ø§Ø±Ø©: <span id="stat-agt-l">0</span></span></div>
        </div>
        <div
          class="bg-yellow-500/10 p-3 rounded-2xl border border-yellow-500/20 text-right text-right text-right text-right">
          <p class="text-[10px] text-yellow-400 font-bold mb-1 text-right text-right text-right text-right text-right">
            ğŸ¤« Ù…Ù…ÙˆÙ‡</p>
          <div class="flex justify-between text-xs font-black text-right text-right text-right text-right text-right">
            <span>ÙÙˆØ²: <span id="stat-und-w">0</span></span><span>Ø®Ø³Ø§Ø±Ø©: <span id="stat-und-l">0</span></span></div>
        </div>
      </div>
      <button onclick="closeStatsModal()"
        class="w-full py-4 btn-secondary rounded-2xl font-black text-white text-center text-center text-center text-center">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØªÙ†Ø¨ÙŠÙ‡ -->
  <div id="modal-alert"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[200] p-6 backdrop-blur-md text-center text-center text-center text-center text-center">
    <div class="glass-panel max-w-sm w-full text-center text-center text-center text-center text-center">
      <h3
        class="text-2xl font-black mb-4 text-yellow-400 text-center font-black text-center text-center text-center text-center text-center text-center">
        ØªÙ†Ø¨ÙŠÙ‡! âš ï¸</h3>
      <p id="alert-message"
        class="text-slate-300 font-bold mb-8 text-center text-white text-center text-center text-center text-center text-center">
      </p>
      <button onclick="closeAlert()"
        class="w-full py-4 btn-gradient rounded-3xl font-black text-white text-xl text-center font-black text-center text-center text-center text-center">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>

  <div id="modal-confirm"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[100] p-6 backdrop-blur-md text-center text-center text-center text-center text-center text-center">
    <div
      class="glass-panel max-w-sm w-full text-center text-center text-center text-center text-center text-center text-center text-center">
      <h3
        class="text-3xl font-black mb-6 text-red-500 text-center font-black text-center text-center text-center text-center text-center text-center">
        ØªØ£ÙƒÙŠØ¯! âš ï¸</h3>
      <p
        class="mb-10 text-slate-400 text-lg font-bold text-center text-white font-black text-center text-center text-center text-center text-center text-center">
        Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ</p>
      <div
        class="flex gap-4 text-center text-center text-center text-center text-center text-center text-center text-center">
        <button onclick="closeModal()"
          class="flex-1 py-5 btn-secondary rounded-3xl font-bold text-xl text-white text-center font-black text-center text-center text-center text-center">ØªØ±Ø§Ø¬Ø¹</button>
        <button onclick="resetPoints()"
          class="flex-1 py-5 bg-red-600 rounded-3xl font-black text-white shadow-2xl text-xl font-black text-white text-center text-center text-center text-center text-center">Ù†Ø¹Ù…ØŒ
          ØµÙÙ‘Ø±</button>
      </div>
    </div>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© ØªØºÙŠÙŠØ± Ø§Ù„ÙØ¦Ø© (Modal) -->
  <div id="modal-category"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[100] p-6 backdrop-blur-md text-center text-center text-center text-center">
    <div
      class="glass-panel max-w-sm w-full shadow-2xl text-center font-black text-center text-center text-center text-center text-center">
      <h3
        class="text-2xl font-black mb-8 text-white underline decoration-indigo-500 font-black text-center text-center text-center text-center">
        ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø© âš™ï¸</h3>
      <div id="modal-categories-grid"
        class="grid grid-cols-2 gap-4 mb-10 text-center text-center text-center text-center text-center text-center text-center">
      </div>
      <button onclick="closeCategoryModal()"
        class="w-full py-5 btn-gradient rounded-3xl font-black text-white text-xl text-center font-black text-center text-center text-center text-center text-center">ØªØ£ÙƒÙŠØ¯
        ÙˆØ¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script>
    // --- 1. Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ¹Ø±ÙŠÙØ§Øª (ÙŠØ¬Ø¨ ØªØ¹Ø±ÙŠÙÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©) ---
    const wordBank = {
      "Ø·Ø¹Ø§Ù…": [{ word: "Ø¨ÙŠØªØ²Ø§", emoji: "ğŸ•", desc: "Ø£ÙƒÙ„Ø© Ø¥ÙŠØ·Ø§Ù„ÙŠØ© Ø¯Ø§Ø¦Ø±ÙŠØ© Ø¨ØµÙ„ØµØ© ÙˆØ¬Ø¨Ù†Ø©.", related: "ÙØ·ÙŠØ±Ø©" }, { word: "ÙƒØ¨Ø³Ø©", emoji: "ğŸ›", desc: "Ø±Ø² ÙˆÙ„Ø­Ù…ØŒ Ø£ÙƒÙ„Ø© Ø®Ù„ÙŠØ¬ÙŠØ© Ù…Ø´Ù‡ÙˆØ±Ø©.", related: "Ù…Ù†Ø¯ÙŠ" }, { word: "Ø¨Ø±Ø¬Ø±", emoji: "ğŸ”", desc: "Ù„Ø­Ù… Ù…Ø´ÙˆÙŠ Ø¯Ø§Ø®Ù„ Ø®Ø¨Ø² Ù…Ø¹ Ø¬Ø¨Ù†Ø©.", related: "Ø³Ø§Ù†Ø¯ÙˆØªØ´" }, { word: "Ø´Ø§ÙˆØ±Ù…Ø§", emoji: "ğŸŒ¯", desc: "Ù„Ø­Ù… Ù…Ù‚Ø·Ø¹ Ù…Ù„ÙÙˆÙ ÙÙŠ Ø®Ø¨Ø² ØµØ§Ø¬.", related: "ÙÙ„Ø§ÙÙ„" }, { word: "Ø¨Ø§Ø³ØªØ§", emoji: "ğŸ", desc: "Ù…ÙƒØ±ÙˆÙ†Ø© Ø¥ÙŠØ·Ø§Ù„ÙŠØ© Ø¨ØµÙˆØµØ§Øª Ù…Ù„ÙˆÙ†Ø©.", related: "Ù„Ø§Ø²Ø§Ù†ÙŠØ§" }, { word: "Ø³ÙˆØ´ÙŠ", emoji: "ğŸ£", desc: "Ø±Ø² ÙˆØ³Ù…Ùƒ Ù…Ù„ÙÙˆÙ ÙŠØ§Ø¨Ø§Ù†ÙŠ.", related: "Ø±ÙˆØ¨ÙŠØ§Ù†" }, { word: "ÙƒÙ†Ø§ÙØ©", emoji: "ğŸ®", desc: "Ø­Ù„ÙˆÙ‰ Ø´Ø±Ù‚ÙŠØ© Ø¨Ø§Ù„Ø¬Ø¨Ù†Ø© Ø£Ùˆ Ø§Ù„Ù‚Ø´Ø·Ø©.", related: "Ø¨Ø³Ø¨ÙˆØ³Ø©" }, { word: "Ø¬Ø±ÙŠØ´", emoji: "ğŸ¥£", desc: "Ø£ÙƒÙ„Ø© Ø´Ø¹Ø¨ÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ Ù…Ø´Ù‡ÙˆØ±Ø©.", related: "Ø³Ù„ÙŠÙ‚" }],
      "Ø£Ø¯ÙˆØ§Øª": [{ word: "Ø´Ø§Ø­Ù†", emoji: "ğŸ”Œ", desc: "ÙŠÙ†Ù‚Ø° Ø¬ÙˆØ§Ù„Ùƒ Ù„Ù…Ø§ ØªØ®Ù„Øµ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©.", related: "ØªÙˆØµÙŠÙ„Ø©" }, { word: "Ù…ÙƒÙŠÙ", emoji: "â„ï¸", desc: "ÙŠØ¨Ø±Ø¯ Ø§Ù„Ø¬Ùˆ ÙÙŠ Ø§Ù„ØµÙŠÙ Ø§Ù„Ø­Ø§Ø±Ù‚.", related: "Ù…Ø±ÙˆØ­Ø©" }, { word: "Ø³Ø§Ø¹Ø©", emoji: "âŒš", desc: "ØªÙ†Ù„Ø¨Ø³ ÙÙŠ Ø§Ù„Ù…Ø¹ØµÙ… Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ÙˆÙ‚Øª.", related: "Ø³ÙˆØ§Ø±" }, { word: "Ù†Ø¸Ø§Ø±Ø©", emoji: "ğŸ‘“", desc: "ØªØ³Ø§Ø¹Ø¯Ùƒ ØªØ´ÙˆÙ Ø¨ÙˆØ¶ÙˆØ­.", related: "Ø¹Ø¯Ø³Ø§Øª" }, { word: "Ù…Ø·Ø±Ù‚Ø©", emoji: "ğŸ”¨", desc: "Ø£Ø¯Ø§Ø© Ø¨Ù†Ø§Ø¡ ØªÙØ³ØªØ®Ø¯Ù… Ù„Ø¯Ù‚ Ø§Ù„Ù…Ø³Ø§Ù…ÙŠØ±.", related: "Ù…ÙÙƒ" }, { word: "Ù…Ù‚Øµ", emoji: "âœ‚ï¸", desc: "Ø£Ø¯Ø§Ø© Ù„Ù‚Øµ Ø§Ù„ÙˆØ±Ù‚ ÙˆØ§Ù„Ù‚Ù…Ø§Ø´.", related: "Ø³ÙƒÙŠÙ†" }],
      "Ù…Ø§Ø±ÙƒØ§Øª": [{ word: "Ø£Ø¨Ù„", emoji: "ğŸ", desc: "Ø´Ø±ÙƒØ© ØªÙ‚Ù†ÙŠØ© Ù…Ø´Ù‡ÙˆØ±Ø© Ø¨Ø§Ù„Ø¢ÙŠÙÙˆÙ† ÙˆØ´Ø¹Ø§Ø± Ø§Ù„ØªÙØ§Ø­Ø©.", related: "Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬" }, { word: "Ù†Ø§ÙŠÙƒÙŠ", emoji: "âœ”ï¸", desc: "Ù…Ø§Ø±ÙƒØ© Ø±ÙŠØ§Ø¶ÙŠØ© Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø£Ø­Ø°ÙŠØ© ÙˆØ§Ù„Ù…Ù„Ø§Ø¨Ø³.", related: "Ø£Ø¯ÙŠØ¯Ø§Ø³" }, { word: "Ù…Ø±Ø³ÙŠØ¯Ø³", emoji: "ğŸš—", desc: "Ø³ÙŠØ§Ø±Ø§Øª Ø£Ù„Ù…Ø§Ù†ÙŠØ© ÙØ®Ù…Ø© ÙˆØ±Ù…Ø² Ù„Ù„Ø±ÙØ§Ù‡ÙŠØ© ÙˆØ§Ù„Ù‚ÙˆØ©.", related: "Ø¨ÙŠ Ø¥Ù…" }, { word: "Ø¨ÙŠØ¨Ø³ÙŠ", emoji: "ğŸ¥¤", desc: "Ù…Ø´Ø±ÙˆØ¨ ØºØ§Ø²ÙŠ Ø¹Ø§Ù„Ù…ÙŠ Ù„ÙˆÙ†Ù‡ Ø£Ø³ÙˆØ¯.", related: "ÙƒÙˆÙƒØ§ÙƒÙˆÙ„Ø§" }],
      "Ø­ÙŠÙˆØ§Ù†Ø§Øª": [{ word: "Ø®Ø±ÙˆÙ", emoji: "ğŸ‘", desc: "Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù…ÙØ¶Ù„ ÙÙŠ Ø§Ù„Ø¹ÙŠØ¯.", related: "Ù…Ø§Ø¹Ø²" }, { word: "Ø£Ø³Ø¯", emoji: "ğŸ¦", desc: "Ù…Ù„Ùƒ Ø§Ù„ØºØ§Ø¨Ø©ØŒ Ø­ÙŠÙˆØ§Ù† Ù…ÙØªØ±Ø³ ÙˆÙ‚ÙˆÙŠ.", related: "Ù†Ù…Ø±" }, { word: "Ø¬Ù…Ù„", emoji: "ğŸª", desc: "Ø³ÙÙŠÙ†Ø© Ø§Ù„ØµØ­Ø±Ø§Ø¡ Ø§Ù„ØµØ¨ÙˆØ±Ø©.", related: "Ø®ÙŠÙ„" }, { word: "Ø¯Ù„ÙÙŠÙ†", emoji: "ğŸ¬", desc: "Ø­ÙŠÙˆØ§Ù† Ø¨Ø­Ø±ÙŠ Ø°ÙƒÙŠ ÙˆØµØ¯ÙŠÙ‚ Ù„Ù„Ø¨Ø´Ø±.", related: "Ø­ÙˆØª" }],
      "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§": [{ word: "Ø¬ÙˆØ§Ù„", emoji: "ğŸ“±", desc: "Ø¬Ù‡Ø§Ø² ÙÙŠ Ø¬ÙŠØ¨Ùƒ ÙŠÙˆØµÙ„Ùƒ Ø¨ÙƒÙ„ Ø§Ù„Ø¹Ø§Ù„Ù….", related: "Ø§ÙŠØ¨Ø§Ø¯" }, { word: "Ø­Ø§Ø³ÙˆØ¨", emoji: "ğŸ’»", desc: "Ø¬Ù‡Ø§Ø² Ù„Ù„Ø¯Ø±Ø§Ø³Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù…Ù„.", related: "Ù„Ø§Ø¨ØªÙˆØ¨" }, { word: "Ø¥Ù†ØªØ±Ù†Øª", emoji: "ğŸŒ", desc: "Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØªÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©.", related: "ÙˆØ§ÙŠ ÙØ§ÙŠ" }, { word: "Ø±ÙˆØ¨ÙˆØª", emoji: "ğŸ¤–", desc: "Ø¢Ù„Ø© Ù…Ø¨Ø±Ù…Ø¬Ø© Ù„ØªÙ‚ÙˆÙ… Ø¨Ù…Ù‡Ø§Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù†.", related: "Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ" }],
      "Ø£Ù„Ø¹Ø§Ø¨": [{ word: "Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†", emoji: "ğŸ®", desc: "Ø¬Ù‡Ø§Ø² Ø£Ù„Ø¹Ø§Ø¨ Ù…Ù† Ø´Ø±ÙƒØ© Ø³ÙˆÙ†ÙŠ.", related: "Ø§ÙƒØ³ Ø¨ÙˆÙƒØ³" }, { word: "ÙÙŠÙØ§", emoji: "âš½", desc: "Ù„Ø¹Ø¨Ø© ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… Ø§Ù„Ø£Ø´Ù‡Ø± Ø±Ù‚Ù…ÙŠØ§Ù‹.", related: "Ø±ÙˆÙƒÙŠØª Ù„ÙŠØº" }],
      "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": [{ word: "Ù‚Ù‡ÙˆØ©", emoji: "â˜•", desc: "Ù…Ø´Ø±ÙˆØ¨ Ø§Ù„ØµØ¨Ø§Ø­ Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø¯Ù„ Ø§Ù„Ù…Ø²Ø§Ø¬.", related: "Ø´Ø§ÙŠ" }, { word: "Ø­Ù…Ø¶ÙŠØ§Øª", emoji: "ğŸŠ", desc: "Ù…Ø´Ø±ÙˆØ¨ ØºØ§Ø²ÙŠ Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø§Ù„Ù„ÙˆÙ†.", related: "Ù…ÙŠØ±Ù†Ø¯Ø§" }],
      "Ø£Ù…Ø§ÙƒÙ†": [{ word: "Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©", emoji: "ğŸ•‹", desc: "Ù‚Ø¨Ù„Ø© Ø§Ù„Ù…Ø³Ù„Ù…ÙŠÙ† ÙˆØ£Ù‚Ø¯Ø³ Ù…ÙƒØ§Ù†.", related: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" }, { word: "Ø¨Ø±Ø¬ Ø¥ÙŠÙÙ„", emoji: "ğŸ—¼", desc: "Ø£Ø´Ù‡Ø± Ù…Ø¹Ù„Ù… Ø­Ø¯ÙŠØ¯ÙŠ ÙÙŠ Ø¨Ø§Ø±ÙŠØ³.", related: "Ø¨Ø±Ø¬ Ø®Ù„ÙŠÙØ©" }, { word: "Ø§Ù„Ù‡Ø±Ù…", emoji: "ğŸ“", desc: "Ø¨Ù†Ø§Ø¡ Ø­Ø¬Ø±ÙŠ Ù‚Ø¯ÙŠÙ… Ø¬Ø¯Ø§Ù‹.", related: "Ø£Ø¨ÙˆØ§Ù„Ù‡ÙˆÙ„" }],
      "Ø¯ÙˆÙ„": [{ word: "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©", emoji: "ğŸ‡¸ğŸ‡¦", desc: "Ø¯ÙˆÙ„Ø© Ø®Ù„ÙŠØ¬ÙŠØ© Ø¹Ø§ØµÙ…ØªÙ‡Ø§ Ø§Ù„Ø±ÙŠØ§Ø¶.", related: "Ø§Ù„ÙƒÙˆÙŠØª" }, { word: "Ù…ØµØ±", emoji: "ğŸ‡ªğŸ‡¬", desc: "Ø¯ÙˆÙ„Ø© Ø§Ù„Ù†ÙŠÙ„ ÙˆØ§Ù„Ø­Ø¶Ø§Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.", related: "Ø§Ù„Ø£Ø±Ø¯Ù†" }, { word: "Ø§Ù„ÙŠØ§Ø¨Ø§Ù†", emoji: "ğŸ‡¯ğŸ‡µ", desc: "ÙƒÙˆÙƒØ¨ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ ÙˆØ§Ù„Ø£Ù†Ù…ÙŠ.", related: "ÙƒÙˆØ±ÙŠØ§" }],
      "Ø¹Ø·ÙˆØ±": [{ word: "Ø¨Ø®ÙˆØ±", emoji: "ğŸ’¨", desc: "Ø±Ø§Ø¦Ø­Ø© Ø´Ø±Ù‚ÙŠØ© Ù†Ø§ØªØ¬Ø© Ø¹Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§Ù‚.", related: "Ù…Ø³Ùƒ" }, { word: "Ø¯Ù‡Ù† Ø¹ÙˆØ¯", emoji: "ğŸªµ", desc: "Ø²ÙŠØª Ø¹Ø·Ø±ÙŠ Ø«Ù…ÙŠÙ† ÙˆÙ‚ÙˆÙŠ.", related: "ÙˆØ±Ø¯" }],
      "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©": []
    };

    // --- Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª ---
    function formatTimeLabel(seconds) {
      if (seconds === 30) return "30 Ø«Ø§Ù†ÙŠØ©";
      if (seconds === 60) return "Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©";
      if (seconds === 120) return "Ø¯Ù‚ÙŠÙ‚ØªØ§Ù†";
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return secs === 0 ? `${mins} Ø¯Ù‚Ø§Ø¦Ù‚` : `${mins} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ${secs} Ø«Ø§Ù†ÙŠØ©`;
    }

    const avatars = ["ğŸ•µï¸", "ğŸ‘¤", "ğŸ‘®", "ğŸ§‘â€ğŸš€", "ğŸ§™", "ğŸ§›", "ğŸ§Ÿ", "ğŸ¦", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¤–", "ğŸ¤¡", "ğŸ‘º", "ğŸ˜ˆ", "ğŸ¦‰", "ğŸ¦’", "ğŸ¦ˆ"];
    const funnyTitles = ["Ø§Ù„Ø¶Ø§ÙŠØ¹ Ø§Ù„Ù…Ø¨ØªØ¯ÙŠØ¡ ğŸ˜¶", "Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ğŸ”", "Ø±Ø§Ø¹ÙŠ Ø§Ù„ÙØ²Ø¹Ø© ğŸ¤", "ÙƒØ§Ø´Ù Ø§Ù„Ø³ÙˆØ§Ù„Ù ğŸ”", "Ø§Ù„Ù…Ø±Ø§ÙˆØº Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ ğŸ¤º", "Ø§Ù„Ø°ÙŠØ¨ ğŸº", "Ù…Ù„Ùƒ Ø§Ù„ØªÙ…ÙˆÙŠÙ‡ ğŸ­", "Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠ ğŸ•µï¸â€â™‚ï¸", "Ø§Ù„Ø¨Ø±ÙˆÙÙŠØ³ÙˆØ± ğŸ‘¨â€ğŸ«", "Ø£Ø³Ø·ÙˆØ±Ø© Ø§Ù„Ø³ÙˆØ§Ù„Ù ğŸ†"];
    const roleNamesMap = { 'in': 'ğŸ•µï¸ Ù…Ø­Ù‚Ù‚', 'out': 'ğŸŒ«ï¸ Ø§Ù„Ø¶Ø§ÙŠØ¹', 'agent': 'ğŸ­ Ø¹Ù…ÙŠÙ„ Ù…Ø²Ø¯ÙˆØ¬', 'undercover': 'ğŸ¤« Ø§Ù„Ù…Ù…ÙˆÙ‡' };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙˆØ§Øª ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playTone(freq, duration, type = 'sine', vol = 0.1) {
      if (state.isMuted) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(vol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
      osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    const sounds = {
      tick: () => playTone(800, 0.05, 'sine', 0.03),
      win: () => { playTone(523, 0.1); setTimeout(() => playTone(659, 0.1), 100); setTimeout(() => playTone(783, 0.3), 200); },
      lose: () => playTone(150, 0.6, 'sawtooth', 0.15)
    };

    // --- Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ---
    let state = {
      players: [], currentRoles: [], secretData: null, timer: 60, initialTimer: 60, interval: null,
      revealIndex: 0, isPaused: false, doubleAgentActive: false, undercoverActive: false,
      outPlayerIds: [], agentPlayerId: null, undercoverPlayerId: null, selectedCategory: "Ø·Ø¹Ø§Ù…",
      customWords: [], isMuted: false, lastWinner: null
    };

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù„Ø¹Ø¨Ø© ---
    function toggleMute() {
      state.isMuted = !state.isMuted;
      const btn = document.getElementById('mute-toggle');
      if (btn) btn.innerText = state.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
    }

    function showScreen(screenId) {
      document.querySelectorAll('#app > div').forEach(div => div.classList.add('hidden'));
      const s = document.getElementById(`screen-${screenId}`);
      if (s) s.classList.remove('hidden');
      if (screenId === 'setup') renderCategories('categories-grid');
      if (screenId === 'leaderboard') { updateLeaderboardUI('leaderboard-list'); checkResetButtonVisibility(); }
      if (screenId === 'final') updateFinalResultsUI();
    }

    function renderCategories(gridId) {
      const grid = document.getElementById(gridId);
      if (!grid) return; grid.innerHTML = '';
      const categoryIcons = { "Ø·Ø¹Ø§Ù…": "ğŸ”", "Ø£Ø¯ÙˆØ§Øª": "ğŸ› ï¸", "Ù…Ø§Ø±ÙƒØ§Øª": "ğŸ·ï¸", "Ø­ÙŠÙˆØ§Ù†Ø§Øª": "ğŸ¾", "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§": "ğŸ’»", "Ø£Ù„Ø¹Ø§Ø¨": "ğŸ®", "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": "â˜•", "Ø£Ù…Ø§ÙƒÙ†": "ğŸ•‹", "Ø¯ÙˆÙ„": "ğŸŒ", "Ø¹Ø·ÙˆØ±": "ğŸ§´", "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©": "âœï¸" };
      Object.keys(wordBank).forEach(cat => {
        if (gridId === 'modal-categories-grid' && cat === "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©" && state.customWords.length < 4) return;
        const isActive = state.selectedCategory === cat;
        const emoji = categoryIcons[cat] || 'ğŸ·ï¸';
        grid.innerHTML += `<div onclick="selectCategory('${cat}', '${gridId}')" class="category-card ${isActive ? 'active' : ''}"><span class="text-xl text-center">${emoji}</span><span class="text-xs text-white font-bold text-center">${cat}</span></div>`;
      });
    }

    function selectCategory(cat, gridId) {
      state.selectedCategory = cat; renderCategories(gridId);
      sounds.tick();
      if (gridId === 'categories-grid') {
        const ui = document.getElementById('custom-words-ui');
        if (ui) ui.classList.toggle('hidden', cat !== "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©");
      }
    }

    function addCustomWord() {
      const input = document.getElementById('custom-word-input');
      const word = input?.value.trim();
      if (word) {
        if (state.customWords.some(w => w.word.toLowerCase() === word.toLowerCase())) {
          document.getElementById('alert-message').innerText = "Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„!";
          document.getElementById('modal-alert').classList.remove('hidden'); document.getElementById('modal-alert').classList.add('flex');
          return;
        }
        state.customWords.push({ word, emoji: "âœï¸", desc: "Ø³Ø§Ù„ÙØ© Ù…Ø¶Ø§ÙØ©.", related: "" });
        input.value = ''; renderCustomWords(); renderCategories('categories-grid');
      }
    }

    function renderCustomWords() {
      const list = document.getElementById('custom-words-list');
      if (!list) return; list.innerHTML = '';
      state.customWords.forEach((w, i) => {
        list.innerHTML += `<span class="bg-indigo-500/20 px-3 py-1 rounded-full text-xs flex items-center gap-1 border border-indigo-500/20 text-white">${w.word} <button onclick="state.customWords.splice(${i},1);renderCustomWords();">Ã—</button></span>`;
      });
      wordBank["ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©"] = state.customWords;
    }

    function updateSetupInfo() {
      const pVal = document.getElementById('input-players')?.value;
      const tVal = parseInt(document.getElementById('input-time')?.value);
      if (!pVal || isNaN(tVal)) return;
      document.getElementById('val-players').innerText = pVal;
      document.getElementById('val-time-label').innerText = formatTimeLabel(tVal);
      const agentContainer = document.getElementById('double-agent-container');
      if (agentContainer) {
        const avail = parseInt(pVal) >= 5;
        agentContainer.classList.toggle('opacity-30', !avail);
        agentContainer.classList.toggle('pointer-events-none', !avail);
        if (!avail) document.getElementById('check-double-agent').checked = false;
      }
    }

    function checkAndNext() {
      if (state.selectedCategory === "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©" && state.customWords.length < 4) {
        document.getElementById('alert-message').innerText = "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ 4 ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø¯Ø¡!";
        document.getElementById('modal-alert').classList.remove('hidden'); document.getElementById('modal-alert').classList.add('flex');
        return;
      }
      initPlayerNames();
    }

    function closeAlert() { document.getElementById('modal-alert').classList.add('hidden'); }

    function initPlayerNames() {
      const count = parseInt(document.getElementById('input-players').value);
      const container = document.getElementById('names-container');
      if (!container) return; container.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      for (let i = 0; i < count; i++) {
        const p = saved[i] || { name: `Ø§Ù„Ù…Ø­Ù‚Ù‚ ${i + 1}`, avatar: avatars[i % avatars.length] };
        container.innerHTML += `<div class="bg-white/5 p-4 rounded-3xl border border-white/10 shadow-inner"><div class="flex gap-3 mb-3 flex-row-reverse text-right"><input type="text" id="name-${i}" value="${p.name}" class="player-input flex-1 bg-slate-800 border-none rounded-2xl p-4 text-white font-bold outline-none focus:ring-2 ring-indigo-500 text-lg text-right" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨"><input type="hidden" id="avatar-${i}" value="${p.avatar}"></div><div class="flex flex-wrap gap-2 justify-center">${avatars.map(a => `<button onclick="setAvatar(${i}, '${a}')" id="av-${i}-${a}" class="avatar-btn ${a === p.avatar ? 'selected' : ''}">${a}</button>`).join('')}</div></div>`;
      }
      showScreen('names');
    }

    function setAvatar(playerIdx, avatar) {
      document.querySelectorAll(`#names-container > div:nth-child(${playerIdx + 1}) .avatar-btn`).forEach(b => b.classList.remove('selected'));
      document.getElementById(`av-${playerIdx}-${avatar}`).classList.add('selected');
      document.getElementById(`avatar-${playerIdx}`).value = avatar;
    }

    function startGame() {
      const countInput = document.getElementById('input-players');
      const count = parseInt(countInput.value);
      state.players = [];
      const savedData = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      for (let i = 0; i < count; i++) {
        const name = document.getElementById(`name-${i}`).value.trim() || `Ø§Ù„Ù…Ø­Ù‚Ù‚ ${i + 1}`;
        const avatar = document.getElementById(`avatar-${i}`).value;
        const existing = savedData[i]; // Ù…ØµÙ„Ø­: Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ù‚Ø¹Ø¯ (Index) Ù„Ø¹Ø¯Ù… Ù…Ø³Ø­ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
        const emptyStats = { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } };
        state.players.push({
          id: i,
          name,
          avatar,
          points: existing ? (existing.points || 0) : 0,
          stats: (existing && existing.stats) ? existing.stats : emptyStats
        });
      }
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(state.players));
      state.timer = parseInt(document.getElementById('input-time').value);
      state.initialTimer = state.timer;
      state.doubleAgentActive = document.getElementById('check-double-agent').checked;
      state.undercoverActive = document.getElementById('check-undercover').checked;
      setupRoles();
      state.revealIndex = 0;
      startRevealSequence();
    }

    function setupRoles() {
      let pool = wordBank[state.selectedCategory] || wordBank["Ø·Ø¹Ø§Ù…"];
      state.secretData = pool[Math.floor(Math.random() * pool.length)];
      let ids = state.players.map(p => p.id).sort(() => 0.5 - Math.random());
      const numOut = state.players.length > 8 ? 2 : 1;
      state.outPlayerIds = ids.splice(0, numOut);
      state.agentPlayerId = (state.doubleAgentActive && ids.length > 0) ? ids.splice(0, 1)[0] : null;
      state.undercoverPlayerId = (state.undercoverActive && ids.length > 0) ? ids.splice(0, 1)[0] : null;
      state.currentRoles = state.players.map(p => {
        let r = 'in';
        if (state.outPlayerIds.includes(p.id)) r = 'out';
        else if (p.id === state.agentPlayerId) r = 'agent';
        else if (p.id === state.undercoverPlayerId) r = 'undercover';
        return { id: p.id, role: r };
      });
    }

    function startRevealSequence() {
      if (state.revealIndex >= state.players.length) { showScreen('game'); startTimer(); return; }
      const p = state.players[state.revealIndex];
      document.getElementById('reveal-player-name').innerText = `${p.avatar} ${p.name}`;
      document.getElementById('reveal-box').classList.add('hidden');
      document.getElementById('btn-reveal-action').innerText = 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø³Ø§Ù„ÙØ©';
      showScreen('reveal');
    }

    function toggleReveal() {
      const box = document.getElementById('reveal-box');
      if (box && box.classList.contains('hidden')) {
        const roleData = state.currentRoles.find(r => r.id === state.players[state.revealIndex].id);
        const txt = document.getElementById('reveal-role-text');
        const word = document.getElementById('reveal-secret-word');
        const img = document.getElementById('reveal-img-placeholder');
        if (roleData.role === 'in') { txt.innerText = "Ø£Ù†Øª ØªØ¹Ø±Ù Ø§Ù„Ø³Ø§Ù„ÙØ©!"; word.innerText = state.secretData.word; img.innerText = state.secretData.emoji; txt.className = "text-2xl mb-4 text-emerald-400 font-bold text-center"; }
        else if (roleData.role === 'agent') { txt.innerText = "Ø£Ù†Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬! Ø§Ø­Ù…Ù Ø§Ù„Ø¶Ø§ÙŠØ¹:"; word.innerText = state.secretData.word; img.innerText = "ğŸ­"; txt.className = "text-2xl mb-4 text-orange-400 font-bold text-center"; }
        else if (roleData.role === 'undercover') {
          let rel = (state.selectedCategory === "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©") ? (state.customWords.filter(w => w.word !== state.secretData.word)[0]?.word || "Ø³Ø§Ù„ÙØ© Ù‚Ø±ÙŠØ¨Ø©") : (state.secretData.related || "Ù…Ø´Ø§Ø¨Ù‡Ø©");
          txt.innerText = "Ø£Ù†Øª Ø§Ù„Ù…Ù…ÙˆÙ‡! ÙƒÙ„Ù…ØªÙƒ Ù‡ÙŠ:"; word.innerText = rel; img.innerText = "ğŸ¤«"; txt.className = "text-2xl mb-4 text-yellow-400 font-bold text-center";
        } else { txt.innerText = "Ø£Ù†Øª Ø§Ù„Ø¶Ø§ÙŠØ¹!"; word.innerText = "ØŸØŸØŸØŸØŸ"; img.innerText = "ğŸ•µï¸â€â™‚ï¸"; txt.className = "text-2xl mb-4 text-red-500 font-bold text-center text-center"; }
        box.classList.remove('hidden'); document.getElementById('btn-reveal-action').innerText = 'ÙÙ‡Ù…ØªØŒ Ø§Ù„ØªØ§Ù„ÙŠ';
      } else { state.revealIndex++; startRevealSequence(); }
    }

    function startTimer() {
      const display = document.getElementById('game-timer');
      const progress = document.getElementById('timer-progress');
      const circumference = 565.48;
      if (progress) { progress.style.strokeDasharray = circumference; progress.style.strokeDashoffset = 0; }
      state.isPaused = false;
      state.timer = state.initialTimer;
      state.interval = setInterval(() => {
        if (state.isPaused) return;
        state.timer--;
        if (progress) progress.style.strokeDashoffset = circumference * (1 - (state.timer / state.initialTimer));
        const m = Math.floor(state.timer / 60), s = state.timer % 60;
        if (display) display.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        if (state.timer <= 5 && state.timer > 0) sounds.tick();
        if (state.timer <= 0) { clearInterval(state.interval); startVoting(); }
      }, 1000);
    }

    function pauseTimer() { state.isPaused = !state.isPaused; document.getElementById('btn-pause').innerText = state.isPaused ? "Ø§Ø³ØªØ¦Ù†Ø§Ù" : "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª"; }
    function endGameEarly() { clearInterval(state.interval); startVoting(); }

    function startVoting() {
      const grid = document.getElementById('voting-grid');
      if (!grid) return; grid.innerHTML = '';
      state.players.forEach(p => {
        grid.innerHTML += `<button onclick="selectVote(${p.id})" class="p-4 sm:p-6 bg-white/5 border-2 border-white/10 rounded-[2.5rem] flex flex-col items-center gap-3 active:bg-indigo-500/20 transition-all shadow-lg text-center"><span class="text-5xl text-center">${p.avatar}</span><span class="font-black text-xs sm:text-sm text-center text-white">${p.name}</span></button>`;
      });
      showScreen('voting');
    }

    function selectVote(id) {
      const isOut = state.outPlayerIds.includes(id) || id === state.undercoverPlayerId;
      if (isOut) startGuessingPhase();
      else showFinalResults('out_win', "Ø§Ù„Ø¶Ø§ÙŠØ¹ Ø®Ø¯Ø¹ÙƒÙ…! ğŸŒ«ï¸");
    }

    function startGuessingPhase() {
      const container = document.getElementById('guess-options');
      if (!container) return; container.innerHTML = '';
      let pool = wordBank[state.selectedCategory] || wordBank["Ø·Ø¹Ø§Ù…"];
      let distractors = pool.filter(w => w.word !== state.secretData.word);
      if (distractors.length < 3) {
        const all = Object.values(wordBank).flat().filter(w => w.word !== state.secretData.word);
        while (distractors.length < 3) { let r = all[Math.floor(Math.random() * all.length)]; if (!distractors.find(d => d.word === r.word)) distractors.push(r); }
      }
      let shuffled = distractors.sort(() => 0.5 - Math.random()).slice(0, 3);
      let options = [...shuffled, state.secretData].sort(() => 0.5 - Math.random());
      options.forEach(opt => {
        container.innerHTML += `<button onclick="checkGuess('${opt.word}')" class="w-full py-5 bg-white/5 rounded-3xl text-xl sm:text-2xl font-black active:bg-indigo-500/20 transition-all shadow-xl border-2 border-white/5 text-white break-word-custom">${opt.word} ${opt.emoji}</button>`;
      });
      showScreen('guess');
    }

    function checkGuess(word) {
      if (word === state.secretData.word) showFinalResults('out_win', "ØªØ®Ù…ÙŠÙ† Ø°ÙƒÙŠ! Ø§Ù„Ø¶Ø§ÙŠØ¹ ÙØ§Ø² ğŸ§ ");
      else showFinalResults('group_win', "Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ† ÙŠÙ†ØªØµØ±ÙˆÙ†! âš–ï¸");
    }

    function showFinalResults(type, title) {
      state.lastWinner = type === 'group_win' ? 'group' : 'out';
      document.getElementById('final-result-title').innerText = title;
      document.getElementById('final-status-emoji').innerText = type === 'group_win' ? 'ğŸ†' : 'ğŸ˜ˆ';
      document.getElementById('final-secret-word').innerText = state.secretData.word;
      document.getElementById('final-word-emoji').innerText = state.secretData.emoji;
      document.getElementById('topic-description').innerText = state.secretData.desc || "";

      if (type === 'group_win') { sounds.win(); createConfetti(); } else { sounds.lose(); }
      awardPoints(state.lastWinner);
      showScreen('final');
    }

    function awardPoints(winner) {
      let saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      saved = saved.map(p => {
        const roleData = state.currentRoles.find(r => r.id === p.id);
        if (!roleData) return p;
        if (!p.stats) p.stats = { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } };
        const isOutRole = state.outPlayerIds.includes(p.id) || p.id === state.agentPlayerId || p.id === state.undercoverPlayerId;

        if (winner === 'group') {
          if (!isOutRole) { p.points = (p.points || 0) + 1; p.stats.det.w++; }
          else { if (roleData.role === 'out') p.stats.out.l++; if (roleData.role === 'agent') p.stats.agt.l++; if (roleData.role === 'undercover') p.stats.und.l++; }
        } else {
          if (isOutRole) { p.points = (p.points || 0) + 2; if (roleData.role === 'out') p.stats.out.w++; if (roleData.role === 'agent') p.stats.agt.w++; if (roleData.role === 'undercover') p.stats.und.w++; }
          else { p.stats.det.l++; }
        }
        return p;
      });
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(saved));
      state.players = saved;
    }

    function updateFinalResultsUI() {
      const list = document.getElementById('final-leaderboard');
      if (!list) return; list.innerHTML = '';
      state.players.forEach(p => {
        const roleData = state.currentRoles.find(r => r.id === p.id);
        const isOutSide = (roleData.role === 'out' || roleData.role === 'agent' || roleData.role === 'undercover');
        const didWin = (state.lastWinner === 'group' && !isOutSide) || (state.lastWinner === 'out' && isOutSide);
        const statusColorClass = didWin ? 'bg-emerald-500/20 border-emerald-500/40 text-emerald-100' : 'bg-red-500/20 border-red-500/40 text-red-100';
        const roleLabel = roleNamesMap[roleData.role] || 'Ù…Ø­Ù‚Ù‚';

        list.innerHTML += `<div class="flex items-center justify-between p-4 rounded-2xl border ${statusColorClass} mb-2 shadow-inner"><div class="flex items-center gap-4 text-right text-right"><span class="text-3xl text-center text-center">${p.avatar}</span><div class="flex flex-col text-right text-right text-right"><span class="font-black text-white text-base text-right text-right text-right">${p.name}</span><span class="text-[9px] font-bold uppercase text-right text-right opacity-80">${roleLabel}</span></div></div><span class="bg-black/20 px-4 py-1 rounded-full font-mono text-xs font-black text-center text-center text-center text-center">${p.points}</span></div>`;
      });
    }

    function updateLeaderboardUI(containerId) {
      const list = document.getElementById(containerId);
      if (!list) return;
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const sorted = [...saved].sort((a, b) => b.points - a.points);
      list.innerHTML = '';
      sorted.forEach((p, idx) => {
        const titleIndex = Math.min(Math.floor(p.points / 2), funnyTitles.length - 1);
        list.innerHTML += `<div onclick="openStatsModal(${p.id})" class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/10 mb-2 shadow-inner hover:bg-white/10 transition-all cursor-pointer text-right text-right text-right"><div class="flex items-center gap-4 text-right text-center text-center text-center text-center text-center">${p.avatar}</span><div class="flex flex-col text-right text-right text-right text-right text-right text-right"><span class="font-black text-base ${idx === 0 ? 'text-yellow-400' : ''} text-white text-right text-right text-right text-right text-right text-right">${idx + 1}. ${p.name}</span><span class="text-[10px] text-indigo-400 font-bold text-right text-right text-right text-right text-right text-right">${funnyTitles[titleIndex]}</span></div></div><span class="bg-indigo-500/20 px-4 py-1 rounded-full font-mono text-sm font-black text-indigo-200 text-center text-center text-center text-center text-center">${p.points}</span></div>`;
      });
    }

    function openStatsModal(playerId) {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const p = saved[playerId]; // Ù…ØµÙ„Ø­: Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ù‚Ø¹Ø¯ Ù…Ø¨Ø§Ø´Ø±Ø©
      if (!p) return;

      document.getElementById('player-stat-avatar').innerText = p.avatar;
      document.getElementById('player-stat-name').innerText = p.name;

      const s = p.stats || { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } };
      const totalWins = (s.det?.w || 0) + (s.out?.w || 0) + (s.agt?.w || 0) + (s.und?.w || 0);
      const totalLosses = (s.det?.l || 0) + (s.out?.l || 0) + (s.agt?.l || 0) + (s.und?.l || 0);
      const totalGames = totalWins + totalLosses;

      document.getElementById('stat-total-games').innerText = totalGames;
      document.getElementById('stat-total-wins').innerText = totalWins;
      document.getElementById('stat-total-losses').innerText = totalLosses;
      document.getElementById('stat-total-points').innerText = p.points || 0;

      document.getElementById('stat-det-w').innerText = s.det?.w || 0; document.getElementById('stat-det-l').innerText = s.det?.l || 0;
      document.getElementById('stat-out-w').innerText = s.out?.w || 0; document.getElementById('stat-out-l').innerText = s.out?.l || 0;
      document.getElementById('stat-agt-w').innerText = s.agt?.w || 0; document.getElementById('stat-agt-l').innerText = s.agt?.l || 0;
      document.getElementById('stat-und-w').innerText = s.und?.w || 0; document.getElementById('stat-und-l').innerText = s.und?.l || 0;

      const modal = document.getElementById('modal-stats');
      modal.classList.remove('hidden'); modal.classList.add('flex');
    }

    function closeStatsModal() { document.getElementById('modal-stats').classList.add('hidden'); }
    function confirmReset() { const m = document.getElementById('modal-confirm'); if (m) { m.classList.remove('hidden'); m.classList.add('flex'); } }
    function closeModal() { document.querySelectorAll('.fixed').forEach(m => { m.classList.add('hidden'); m.classList.remove('flex'); }); }

    function resetPoints() {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const resetData = saved.map(p => ({ ...p, points: 0, stats: { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } } }));
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(resetData));
      state.players = resetData;
      closeModal(); updateLeaderboardUI('leaderboard-list'); checkResetButtonVisibility();
    }

    function checkResetButtonVisibility() {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const hasData = saved.some(p => (p.points || 0) > 0 || (p.stats && (p.stats.det?.w > 0 || p.stats.out?.w > 0)));
      const trigger = document.getElementById('btn-reset-points-trigger');
      if (trigger) trigger.classList.toggle('hidden', !hasData);
    }

    function openCategoryModal() {
      const m = document.getElementById('modal-category');
      if (m) { m.classList.remove('hidden'); m.classList.add('flex'); renderCategories('modal-categories-grid'); }
    }

    function closeCategoryModal() {
      const m = document.getElementById('modal-category');
      if (m) { m.classList.add('hidden'); m.classList.remove('flex'); }
    }

    function restartSameGame() { setupRoles(); state.revealIndex = 0; startRevealSequence(); }

    function createConfetti() {
      const container = document.getElementById('confetti-container');
      if (!container) return;
      const colors = ['#6366f1', '#10b981', '#ef4444', '#fbbf24', '#f472b6'];
      for (let i = 0; i < 120; i++) {
        const c = document.createElement('div'); c.className = 'confetti-piece';
        const size = Math.random() * 12 + 6; c.style.width = `${size}px`; c.style.height = `${size}px`;
        c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        c.style.left = `${Math.random() * 100}vw`; c.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
        container.appendChild(c);
        c.animate([{ transform: 'translateY(0) rotate(0deg)', opacity: 1 }, { transform: `translateY(110vh) rotate(1080deg) translateX(${(Math.random() - 0.5) * 400}px)`, opacity: 0 }], { duration: 3000 + Math.random() * 2000, easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)' });
        setTimeout(() => c.remove(), 5000);
      }
    }

    window.addEventListener('DOMContentLoaded', () => { updateSetupInfo(); renderCustomWords(); checkResetButtonVisibility(); });
  </script>
</body>

</html>
