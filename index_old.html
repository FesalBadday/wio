<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

  <title>ูู ุจุฑุง ุงูุณุงููุฉุ - ุงููุณุฎุฉ ุงูุฐูุจูุฉ</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1;
      --accent: #10b981;
      --danger: #ef4444;
      --bg-dark: #0f172a;
    }

    /* ุฅุฎูุงุก ุดุฑูุท ุงูุชูุฑูุฑ */
    * {
      scrollbar-width: none;
      -ms-overflow-style: none;
      -webkit-tap-highlight-color: transparent;
    }

    *::-webkit-scrollbar {
      display: none;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background-color: var(--bg-dark);
      background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
      color: #f8fafc;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      overflow: hidden;
      touch-action: manipulation;
      transition: all 0.3s ease;
      padding: env(safe-area-inset-top) 1rem env(safe-area-inset-bottom) 1rem;
    }

    /* ูุฆุฉ ุงููููุถ ุงูุฃุญูุฑ ุนูุฏ ุงูุฎุทุฃ */
    body.wrong-flash-active {
      background: #450a0a !important;
    }

    /* ุฃููููุดู ุงูุงูุชุฒุงุฒ ุนูุฏ ุงูุฎุทุฃ */
    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      20% {
        transform: translateX(-12px) rotate(-1deg);
      }

      40% {
        transform: translateX(12px) rotate(1deg);
      }

      60% {
        transform: translateX(-12px) rotate(-1deg);
      }

      80% {
        transform: translateX(12px) rotate(1deg);
      }
    }

    .shake-effect {
      animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
    }

    /* --- ุฃููุงุท ุงูุจุทุงูุฉ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ (Card Flip CSS) --- */
    .card-scene {
      perspective: 1000px;
      width: 100%;
      max-width: 320px;
      height: 420px;
      margin: 0 auto 2rem auto;
      cursor: pointer;
      position: relative;
      /* ุถูุงู ุงูุงุณุชูุฑุงุฑ */
      z-index: 10;
    }

    .card-object {
      width: 100%;
      height: 100%;
      position: relative;
      transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
      transform-style: preserve-3d;
    }

    .card-object.is-flipped {
      transform: rotateY(180deg);
    }

    .card-face {
      position: absolute;
      top: 0;
      /* ููู ุฌุฏุงู: ุชุซุจูุช ุงููุฌู ูู ุงูุฃุนูู */
      left: 0;
      /* ููู ุฌุฏุงู: ุชุซุจูุช ุงููุฌู ูู ุงููุณุงุฑ */
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      border-radius: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
      overflow: hidden;
    }

    .card-face-front {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      border: 2px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    .card-face-back {
      background: rgba(30, 41, 59, 0.95);
      border: 2px solid rgba(99, 102, 241, 0.3);
      transform: rotateY(180deg);
      padding: 1.5rem;
    }

    /* ุฃููููุดู ุงูุนูู ูู ุงููุถุงุก */
    @keyframes space-float {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
        opacity: 0.1;
      }

      50% {
        transform: translateY(-15px) rotate(5deg);
        opacity: 0.4;
      }
    }

    .space-floater {
      position: absolute;
      font-weight: 900;
      animation: space-float 6s ease-in-out infinite;
      user-select: none;
    }

    /* --- ุฃููููุดู ุชุณุงูุท ุงูุฅูููุฌู --- */
    @keyframes fall {
      0% {
        transform: translateY(-10vh) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
      }
    }

    .emoji-drop {
      position: absolute;
      top: -50px;
      animation-name: fall;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
      z-index: 9999;
      pointer-events: none;
    }

    /* ---------------------------------------------------- */

    #orientation-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-dark);
      z-index: 10000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }

    @media screen and (orientation: landscape) and (pointer: coarse) {
      #orientation-overlay {
        display: flex;
      }
    }

    .glass-panel {
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 2.5rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
      max-height: 94vh;
      width: 100%;
      max-width: 550px;
      overflow-y: auto;
      position: relative;
      padding: 1.5rem;
      z-index: 10;
      transition: border-color 0.3s ease;
    }

    .btn-gradient {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-gradient:active {
      transform: scale(0.96);
    }

    .category-card {
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      padding: 1rem 0.5rem;
      border-radius: 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      text-align: center;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
    }

    .category-card.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.25);
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }

    .rule-card {
      background: rgba(255, 255, 255, 0.03);
      border-right: 5px solid var(--primary);
      padding: 1.25rem;
      border-radius: 1.25rem;
      margin-bottom: 1rem;
      text-align: right;
    }

    .avatar-btn {
      font-size: 1.6rem;
      padding: 0.5rem;
      border-radius: 1rem;
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.2s;
      width: 52px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .avatar-btn.selected {
      background: var(--primary);
      transform: scale(1.15);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
    }

    #confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 9999;
      overflow: hidden;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -20px;
    }

    .detective-float {
      animation: smoothFloat 10s ease-in-out infinite;
    }

    @keyframes smoothFloat {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
      }

      50% {
        transform: translateY(-30px) rotate(5deg);
      }
    }

    .break-word-custom {
      overflow-wrap: break-word;
      word-wrap: break-word;
      word-break: break-word;
      max-width: 100%;
      line-height: 1.4;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 10px;
      background: #1e293b;
      border-radius: 15px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      background: var(--primary);
      border: 4px solid #fff;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.6);
    }

    .custom-checkbox {
      appearance: none;
      width: 58px;
      height: 30px;
      background-color: #334155;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .custom-checkbox:checked {
      background-color: var(--primary);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
    }

    .custom-checkbox::before {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background-color: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: all 0.3s;
    }

    .custom-checkbox:checked::before {
      transform: translateX(28px);
    }
  </style>
</head>

<body>

  <div id="orientation-overlay">
    <div class="text-6xl mb-6 animate-bounce text-center">๐ฑ</div>
    <h2 class="text-2xl font-black text-white mb-4 text-center">ูุฑุฌู ุชุฏููุฑ ุงูุฌูุงุฒ ูููุถุน ุงูุนุงููุฏู</h2>
    <p class="text-slate-400 font-bold text-center">ุงููุนุจุฉ ูุตููุฉ ููุนูู ูู ุงููุถุน ุงูุนุงููุฏู ูุถูุงู ุฃูุถู ุชุฌุฑุจุฉ</p>
  </div>

  <div id="confetti-container"></div>

  <!-- ุฃุฒุฑุงุฑ ุงูุชุญูู (ุฎุงุฑุฌ #app ูุชุธู ุซุงุจุชุฉ) -->
  <div id="global-controls" class="fixed top-6 left-6 z-50 flex gap-3">
    <button onclick="toggleMute()" id="mute-toggle"
      class="p-3 bg-white/10 rounded-full border border-white/10 text-xl shadow-lg hover:bg-white/20 transition-all active:scale-95">
      ๐
    </button>
    <button onclick="toggleVibration()" id="vibrate-toggle"
      class="p-3 bg-white/10 rounded-full border border-white/10 text-xl shadow-lg hover:bg-white/20 transition-all active:scale-95">
      ๐ณ
    </button>
  </div>

  <div id="app" class="w-full flex justify-center items-center p-4">
    <!-- Start Screen -->
    <div id="screen-start" class="glass-panel text-center">
      <div class="mb-14 detective-float text-8xl sm:text-9xl text-center">๐ต๏ธโโ๏ธ</div>
      <h1
        class="text-4xl sm:text-6xl font-black mb-8 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 via-purple-400 to-emerald-400 leading-normal">
        ูู ุจุฑุง ุงูุณุงููุฉุ</h1>
      <p class="text-slate-400 text-base sm:text-xl mb-14 font-bold opacity-90 px-4 mt-6 leading-relaxed text-center">
        ุงููุนุจุฉ ุงูุฑุณููุฉ ููุดู "ุงูุถุงูุน" ุจูููู!</p>
      <div class="space-y-4 text-center">
        <button onclick="showScreen('setup')"
          class="btn-gradient w-full py-6 rounded-3xl text-2xl font-black text-white shadow-2xl">ุจุฏุก
          ุงูุชุญุฏู</button>
        <div class="grid grid-cols-2 gap-4 text-center">
          <button onclick="showScreen('leaderboard')"
            class="btn-secondary py-4 rounded-2xl font-bold border border-white/10 text-white shadow-sm">๐
            ุงูุตุฏุงุฑุฉ</button>
          <button onclick="showScreen('rules')"
            class="btn-secondary py-4 rounded-2xl font-bold text-indigo-400 border border-indigo-400/20 shadow-sm">๐
            ููู ููุนุจุ</button>
        </div>
      </div>
    </div>

    <!-- Setup Screen -->
    <div id="screen-setup" class="glass-panel hidden text-right">
      <h2 class="text-2xl sm:text-3xl font-black mb-6 text-center text-white">โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุฌูุณุฉ</h2>
      <div class="space-y-6">
        <div>
          <label class="text-slate-300 font-bold block mb-4 text-right">ุงุฎุชุฑ ูุฆุฉ ุงูุณูุงูู:</label>
          <div id="categories-grid" class="grid grid-cols-3 gap-2 text-center"></div>
        </div>

        <div id="custom-words-ui"
          class="bg-indigo-500/10 p-5 rounded-3xl border border-indigo-500/20 hidden text-right">
          <label class="text-indigo-300 font-bold block mb-3 text-right text-sm">ุฃุถู ูููุงุชู ุงูุฎุงุตุฉ ูููุฆุฉ (4 ูููุงุช ูุญุฏ
            ุฃุฏูู):</label>
          <div class="flex gap-2">
            <input type="text" id="custom-word-input"
              class="flex-1 bg-slate-800 border-none rounded-xl p-4 text-white outline-none focus:ring-2 ring-indigo-500 text-sm text-right"
              placeholder="ูููุฉ ุณุฑูุฉ...">
            <button onclick="addCustomWord()"
              class="bg-indigo-600 px-6 rounded-2xl font-black text-white text-sm">ุฅุถุงูุฉ</button>
          </div>
          <div id="custom-words-list" class="flex flex-wrap gap-2 mt-4 max-h-32 overflow-y-auto justify-end text-right">
          </div>
        </div>

        <!-- ูุธุงู ุงูุชุตููุช ุงููุทูุฑ -->
        <div class="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between transition-all">
          <div class="text-right">
            <h4 class="font-bold text-sm text-white">โ๏ธ ูุธุงู ุงูุชุตููุช</h4>
            <p class="text-[10px] text-slate-500 italic">ุทุฑููุฉ ูุดู ุงูุถุงูุน</p>
          </div>
          <div class="flex bg-slate-900/50 p-1 rounded-xl border border-white/5">
            <button id="btn-vote-group" onclick="setVotingMode('group')"
              class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-indigo-600 text-white shadow-lg">ุฌูุงุนู</button>
            <button id="btn-vote-individual" onclick="setVotingMode('individual')"
              class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white">ูุฑุฏู</button>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 text-right">
          <div class="bg-white/5 p-4 rounded-2xl border border-white/10 text-right shadow-inner">
            <div class="flex justify-between mb-3 flex-row-reverse">
              <label class="text-slate-300 font-bold text-sm text-right">ุนุฏุฏ ุงููุงุนุจูู</label>
              <span class="text-indigo-400 font-mono font-black text-xl" id="val-players">3</span>
            </div>
            <input type="range" id="input-players" min="3" max="15" value="3" oninput="updateSetupInfo()">
          </div>
          <div class="bg-white/5 p-4 rounded-2xl border border-white/10 text-right shadow-inner">
            <div class="flex justify-between mb-3 flex-row-reverse">
              <label class="text-slate-300 font-bold text-sm text-right">ููุช ุงูููุงุด</label>
              <span class="text-emerald-400 font-black text-lg" id="val-time-label">ุฏูููุฉ ูุงุญุฏุฉ</span>
            </div>
            <input type="range" id="input-time" min="30" max="300" step="30" value="60" oninput="updateSetupInfo()">
          </div>
        </div>

        <div class="space-y-3">
          <!-- ุฎูุงุฑ ุงูุชุญุฏู ุงูุฃุนูู (Blind Mode) -->
          <div id="blind-mode-container"
            class="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-white">๐ ุงูุชุญุฏู ุงูุฃุนูู</h4>
              <p class="text-[10px] text-slate-500 italic">ูุฏ ูุง ูููู ููุงู ุถุงูุน!</p>
            </div>
            <input type="checkbox" id="check-blind-mode" class="custom-checkbox">
          </div>

          <!-- ุฎูุงุฑ ุชูุนูู ุงูุชุฎููู ููุถุงูุน -->
          <div id="guessing-container"
            class="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-white">๐ฏ ูุฑุตุฉ ุงูุชุฎููู</h4>
              <p class="text-[10px] text-slate-500 italic">ูู ูุญู ููุถุงูุน ุงูุชุฎูููุ</p>
            </div>
            <input type="checkbox" id="check-guessing" class="custom-checkbox" checked onchange="toggleSmartSettings()">
          </div>

          <!-- ุฎูุงุฑ ุงูุฎูุงุฑุงุช ุงูุฐููุฉ (ูุธูุฑ ููุท ุนูุฏ ุชูุนูู ุงูุชุฎููู) -->
          <div id="smart-distractors-container"
            class="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-white">๐ง ุฎูุงุฑุงุช ุฐููุฉ</h4>
              <p class="text-[10px] text-slate-500 italic">ุฎูุงุฑุงุช ุชุฎููู ูุชุฑุงุจุทุฉ</p>
            </div>
            <!-- ุงูุงูุชุฑุงุถู ุบูุฑ ููุนู (ุจุฏูู checked) -->
            <input type="checkbox" id="check-smart-distractors" class="custom-checkbox">
          </div>

          <div id="double-agent-container"
            class="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-white">๐ญ ุงูุนููู ุงููุฒุฏูุฌ</h4>
              <p class="text-[10px] text-slate-500 italic">ูุชุงุญ ูู 5 ูุงุนุจูู ูุฃูุซุฑ</p>
            </div>
            <input type="checkbox" id="check-double-agent" class="custom-checkbox">
          </div>

          <div id="undercover-container"
            class="p-4 bg-white/5 rounded-2xl border border-white/10 flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-white">๐ต๏ธ ุงููููู</h4>
              <p class="text-[10px] text-slate-500 italic">ูููู ูููุฉ ูุดุงุจูุฉ</p>
            </div>
            <input type="checkbox" id="check-undercover" class="custom-checkbox">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 pt-4 text-center">
          <button onclick="showScreen('start')"
            class="py-5 rounded-3xl btn-secondary font-bold text-lg text-white">ุฑุฌูุน</button>
          <button onclick="checkAndNext()"
            class="py-5 rounded-3xl btn-gradient font-black text-white text-lg shadow-xl">ุงูุชุงูู</button>
        </div>
      </div>
    </div>

    <!-- Names Screen -->
    <div id="screen-names" class="glass-panel hidden text-right">
      <h2 class="text-2xl sm:text-3xl font-black mb-8 text-center text-white">ุชุฌููุฒ ูุฑูู ุงููุญูููู ๐</h2>
      <div id="names-container" class="space-y-4 mb-8 max-h-[50vh] overflow-y-auto px-1"></div>
      <button onclick="startGame()"
        class="btn-gradient w-full py-6 rounded-3xl font-black text-white text-xl shadow-2xl">ุงูุทูุงู! ๐</button>
    </div>

    <!-- Reveal Screen -->
    <div id="screen-reveal" class="glass-panel hidden text-center">
      <div class="text-7xl sm:text-8xl mb-6">๐ฑ</div>
      <p class="text-slate-400 mb-2 text-xl font-bold">ูุฑุฑ ุงูุฌูุงุฒ ุฅูู ุงููุญูู:</p>
      <h2 id="reveal-player-name" class="text-4xl sm:text-6xl font-black mb-10 text-indigo-400"></h2>

      <!-- ููุทูุฉ ุงูุจุทุงูุฉ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ (3D Card) -->
      <div class="card-scene" onclick="flipCard()">
        <div class="card-object" id="role-card">
          <!-- ุงููุฌู ุงูุฃูุงูู (5 ุนูุงูุงุช ุงุณุชููุงู ุนุงุฆูุฉ) -->
          <div class="card-face card-face-front relative">
            <!-- 1. ุงููุณุท (ุงูุฃูุจุฑ) -->
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -60%); z-index: 0;">
              <span class="font-black text-white"
                style="font-size: 10rem; display: block; animation: space-float 8s ease-in-out infinite; opacity: 0.1;">?</span>
            </div>

            <!-- 2. ุฒุงููุฉ ุนูููุฉ ูุณุงุฑ -->
            <span class="space-floater text-6xl text-indigo-500/30"
              style="top: 2rem; left: 2rem; animation-delay: 1s;">?</span>

            <!-- 3. ุฒุงููุฉ ุนูููุฉ ูููู -->
            <span class="space-floater text-6xl text-purple-500/30"
              style="top: 2rem; right: 2rem; animation-delay: 2s;">?</span>

            <!-- 4. ุฒุงููุฉ ุณูููุฉ ูุณุงุฑ -->
            <span class="space-floater text-6xl text-pink-500/30"
              style="bottom: 6rem; left: 2rem; animation-delay: 3s;">?</span>

            <!-- 5. ุฒุงููุฉ ุณูููุฉ ูููู -->
            <span class="space-floater text-6xl text-emerald-500/30"
              style="bottom: 6rem; right: 2rem; animation-delay: 4s;">?</span>

            <p class="text-slate-400 mt-auto mb-10 font-bold animate-pulse z-10">ุงุถุบุท ูููุดู</p>
          </div>
          <!-- ุงููุฌู ุงูุฎููู (ุงููุนูููุงุช) -->
          <div class="card-face card-face-back flex flex-col items-center justify-center">
            <p id="reveal-role-text" class="text-xl sm:text-2xl font-bold mb-4"></p>
            <div id="reveal-img-placeholder" class="text-7xl sm:text-8xl mb-4"></div>
            <p id="reveal-secret-word"
              class="text-3xl sm:text-4xl font-black text-white tracking-widest uppercase break-word-custom"></p>
            <p id="reveal-word-desc" class="text-base sm:text-lg text-slate-400 mt-4 italic font-bold"></p>
          </div>
        </div>
      </div>

      <button id="btn-reveal-action" onclick="toggleReveal()"
        class="btn-gradient w-full py-7 rounded-3xl font-black text-2xl text-white shadow-2xl">ูุดู ุงูุฏูุฑ</button>
    </div>

    <!-- Game Screen -->
    <div id="screen-game" class="glass-panel hidden text-center">
      <div class="flex justify-center mb-10">
        <div class="relative w-56 h-56 sm:w-72 sm:h-72 flex items-center justify-center">
          <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 200 200">
            <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="12"></circle>
            <circle id="timer-progress" cx="100" cy="100" r="90" fill="none" stroke="url(#timer-grad)" stroke-width="12"
              stroke-dasharray="565.48" stroke-dashoffset="0" stroke-linecap="round"
              class="transition-all duration-1000"></circle>
            <defs>
              <linearGradient id="timer-grad">
                <stop offset="0%" stop-color="#6366f1" />
                <stop offset="100%" stop-color="#10b981" />
              </linearGradient>
            </defs>
          </svg>
          <div id="game-timer" class="text-6xl sm:text-8xl font-black font-mono tracking-tighter text-white">00:00
          </div>
        </div>
      </div>
      <p class="text-2xl sm:text-3xl text-slate-200 mb-12 font-bold px-4">ุชูุงูุดูุง ุจุฐูุงุก.. ูุง ุชูุดููุง ุงูุณุงููุฉ ููุถุงูุน!
      </p>

      <!-- ุฒุฑ ุงูููุน -->
      <button id="btn-panic" onclick="triggerPanic()"
        class="hidden w-full py-4 bg-orange-600/20 border-2 border-orange-500 text-orange-400 rounded-2xl font-black text-xl animate-pulse shadow-[0_0_20px_rgba(249,115,22,0.3)] hover:bg-orange-600/30 transition-all mb-4">๐จ
        ุฃูุง ุนุฑูุชูุง!</button>

      <div class="grid grid-cols-2 gap-4">
        <button onclick="endGameEarly()"
          class="py-5 bg-red-500/10 text-red-400 border-2 border-red-500/20 rounded-3xl font-black text-lg">ุฅููุงุก
          ุงูููุช</button>
        <button onclick="pauseTimer()" id="btn-pause"
          class="py-5 btn-secondary rounded-3xl font-black text-lg border-2 border-white/5 text-white">ุฅููุงู
          ูุคูุช</button>
      </div>
    </div>

    <!-- Voting Screen -->
    <div id="screen-voting" class="glass-panel hidden text-center">
      <h2 class="text-3xl sm:text-5xl font-black mb-4 text-white">ูู ุงูุถุงูุนุ โ๏ธ</h2>
      <div id="voter-indicator" class="text-indigo-400 font-bold mb-4 hidden text-xl"></div>
      <p id="voting-instruction" class="text-slate-400 mb-8 text-lg font-semibold underline decoration-indigo-500">
        ุงุถุบุท ุนูู ุตูุฑุฉ ุงูุดุฎุต ุงููุชูู ูุจุงุดุฑุฉ</p>
      <div id="voting-grid" class="grid grid-cols-2 gap-4 mb-8 max-h-[50vh] overflow-y-auto px-2 text-white"></div>
    </div>

    <!-- Guess Screen -->
    <div id="screen-guess" class="glass-panel hidden text-center">
      <h2 id="guess-title" class="text-3xl sm:text-4xl font-black mb-6 text-red-400">ููุฏ ูุดููู! ๐ฏ</h2>

      <!-- ุนุฏุงุฏ ุงูุชุฎููู ุงูุฌุฏูุฏ (ูุธูุฑ ููุท ูู ุงูููุน) -->
      <div id="guess-timer-container" class="hidden mb-6 flex justify-center w-full">
        <div
          class="w-20 h-20 rounded-full border-4 border-orange-500 flex items-center justify-center bg-orange-900/50 shadow-[0_0_25px_rgba(249,115,22,0.4)]">
          <span id="guess-timer" class="text-3xl font-black text-white tabular-nums">30</span>
        </div>
      </div>

      <p id="guess-subtitle" class="text-slate-300 mb-10 text-xl font-bold leading-relaxed">ุฎูู ุงูุณุงููุฉ ูู ุงูุฎูุงุฑุงุช
        ุงูุชุงููุฉ!</p>
      <div id="guess-options" class="grid grid-cols-1 gap-4 mb-8"></div>
    </div>

    <!-- Final Result Screen -->
    <div id="screen-final" class="glass-panel hidden text-center overflow-y-auto">
      <div id="final-status-emoji" class="text-8xl sm:text-9xl mb-6">๐</div>
      <h2 id="final-result-title" class="text-3xl sm:text-5xl font-black mb-6 text-white"></h2>

      <div class="bg-slate-800/60 p-8 rounded-[2.5rem] mb-8 border border-white/10 shadow-2xl">
        <p class="text-slate-400 mb-3 font-bold text-sm uppercase tracking-widest">ุงูุณุงููุฉ ูุงูุช:</p>
        <div id="final-word-emoji" class="text-7xl sm:text-8xl mb-3"></div>
        <p id="final-secret-word"
          class="text-5xl sm:text-7xl font-black text-emerald-400 mb-4 tracking-wider break-word-custom"></p>
        <p id="topic-description" class="text-lg sm:text-xl text-indigo-100 opacity-80 italic"></p>
      </div>

      <div class="mb-10 text-right">
        <h3 class="text-2xl sm:text-3xl font-black mb-6 text-center text-white">๐ ูุชุงุฆุฌ ุงูุฌููุฉ ูุงูุฃุฏูุงุฑ</h3>
        <div id="final-leaderboard" class="space-y-3 text-right"></div>
      </div>

      <div class="grid grid-cols-1 gap-4 text-center">
        <button onclick="restartSameGame()"
          class="btn-gradient py-6 rounded-[2rem] font-black text-white text-2xl shadow-2xl">ุฌููุฉ ุฌุฏูุฏุฉ ๐</button>
        <button onclick="openCategoryModal()"
          class="btn-secondary py-5 rounded-2xl font-bold text-indigo-300 text-lg border border-indigo-500/20 shadow-md text-white">ุชุบููุฑ
          ุงููุฆุฉ ููุท โ๏ธ</button>
        <button onclick="showScreen('start')" class="py-3 text-slate-500 underline text-base font-bold">ุงูุนูุฏุฉ
          ููุฑุฆูุณูุฉ</button>
      </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="screen-leaderboard" class="glass-panel hidden text-center text-right">
      <h2 class="text-3xl font-black mb-10 text-center text-white">๐ ุฃุจุทุงู ุงูุณูุงูู</h2>
      <p class="text-slate-500 text-xs mb-4 text-center">(ุงุถุบุท ุนูู ุงุณู ุงููุงุนุจ ููุดุงูุฏุฉ ุฅุญุตุงุฆูุงุชู)</p>
      <div id="leaderboard-list" class="space-y-4 mb-10 max-h-[60vh] overflow-y-auto px-2 text-right"></div>
      <div id="leaderboard-buttons" class="flex justify-center gap-4 text-center">
        <button onclick="showScreen('start')" id="btn-close-lb"
          class="flex-1 py-5 btn-secondary rounded-3xl font-black border border-white/10 text-white min-w-[140px]">ุฅุบูุงู</button>
        <button id="btn-reset-points-trigger" onclick="confirmReset()"
          class="flex-1 py-5 bg-red-600/20 text-red-500 rounded-3xl font-black border border-red-500/20 text-sm hidden min-w-[140px]">ุชุตููุฑ
          ุงูููุงุท</button>
      </div>
    </div>

    <!-- Rules Screen -->
    <div id="screen-rules" class="glass-panel hidden text-right">
      <h2
        class="text-3xl sm:text-4xl font-black mb-10 text-center text-indigo-400 border-b-4 border-indigo-500/10 pb-6">
        ๐ ุฏููู ุงูุณุงููุฉ ุงูุดุงูู</h2>
      <div class="space-y-6 text-right">
        <div class="rule-card text-right">
          <h4 class="font-black text-indigo-400 mb-3 flex items-center justify-start gap-3 text-xl"><span
              class="order-first">โ</span> ูุง ูู ูุฐู ุงููุนุจุฉุ</h4>
          <p class="text-base leading-relaxed text-slate-300 font-semibold italic">ูุนุจุฉ ุฐูุงุก ูุชูููู ุฌูุงุนูุฉ. ูู ูู ุฌููุฉุ
            ุชูุฌุฏ "ุณุงููุฉ" ูุนุฑููุง ุงูุฌููุน ุฅูุง <span class="highlight-text font-black text-white">ุดุฎุต ูุงุญุฏ</span> ูุณูู
            "ุงูุถุงูุน".</p>
        </div>
        <div class="rule-card text-right">
          <h4 class="font-black text-indigo-400 mb-3 flex items-center justify-start gap-3 text-xl font-black"><span
              class="order-first">๐ญ</span> ุงูุฃุฏูุงุฑ ูุดุฑูุท ุงูููุฒ</h4>
          <ul class="text-sm space-y-4 font-bold text-slate-300">
            <li>๐ต๏ธ ุงููุญูููู: ูููุฒูู ุฅุฐุง ูุดููุง ุงูุถุงูุนุ ููุดู ูู ุชุฎููู ุงูุณุงููุฉ.</li>
            <li>๐ซ๏ธ ุงูุถุงูุน: ูููุฒ ุฅุฐุง ูู ูููุดู ุฃู ุฅุฐุง ูุฌุญ ูู ุชุฎููู ุงูุณุงููุฉ ุตุญ.</li>
            <li>๐ญ ุงูุนููู: ูููุฒ ุฅุฐุง ูุงุฒ ุงูุถุงูุน ุจูุณุงุนุฏุชู ุณุฑุงู.</li>
            <li>๐คซ ุงููููู: ูููู ูููุฉ ูุฑูุจุฉ ููููุฒ ุฅุฐุง ุจูู ูุชุฎููุงู.</li>
          </ul>
        </div>
        <div class="rule-card text-right">
          <h4 class="font-black text-indigo-400 mb-3 flex items-center justify-start gap-3 text-xl font-black"><span
              class="order-first">โ๏ธ</span> ูุธุงู ุงูุชุตููุช</h4>
          <ul class="text-sm space-y-4 font-bold text-slate-300">
            <li>๐ณ๏ธ <span class="text-white">ุชุตููุช ุฌูุงุนู:</span> ูุชูู ุงูุฌููุน ุนูู ุดุฎุต ูุงุญุฏ.</li>
            <li>๐ค <span class="text-white">ุชุตููุช ูุฑุฏู:</span> ูุตูุช ูู ูุงุนุจ ุณุฑุงูุ ูุชุญุณุจ ุงูุฃุบูุจูุฉ.</li>
          </ul>
        </div>
        <div class="rule-card text-right">
          <h4 class="font-black text-indigo-400 mb-3 flex items-center justify-start gap-3 text-xl font-black"><span
              class="order-first">๐</span> ูุธุงู ุงูููุงุท ุงููุทูุฑ</h4>
          <div class="text-xs space-y-3 font-bold text-right leading-relaxed">
            <div class="p-3 bg-emerald-500/10 rounded-xl border border-emerald-500/20 text-right">
              <p class="text-emerald-400 mb-1">๐ต๏ธ ุงููุญูููู:</p>
              <p class="text-slate-300">ุงูููุฒ: <span class="text-white">+1 ููุทุฉ</span> | ุงูุฎุณุงุฑุฉ: <span
                  class="text-white">0 ููุทุฉ</span></p>
            </div>
            <div class="p-3 bg-indigo-500/10 rounded-xl border border-indigo-500/20 text-right">
              <p class="text-indigo-400 mb-1">๐ซ๏ธ ุงูุถุงูุน / ๐ญ ุงูุนููู / ๐คซ ุงููููู:</p>
              <p class="text-slate-300">ุงูููุฒ: <span class="text-white">+2 ููุทุฉ</span> | ุงูุฎุณุงุฑุฉ: <span
                  class="text-white">0 ููุทุฉ</span></p>
            </div>
            <div class="p-3 bg-orange-500/10 rounded-xl border border-orange-500/20 text-right mt-2">
              <p class="text-orange-400 mb-1">๐จ ุฒุฑ "ุฃูุง ุนุฑูุชูุง!" (ููุถุงูุน):</p>
              <p class="text-slate-300">ุชุฎููู ุตุญูุญ: <span class="text-white">+4 ููุถุงูุน / +2 ูููุฑูู</span> (ููุฒ ุณุงุญู)</p>
              <p class="text-slate-300">ุชุฎููู ุฎุงุทุฆ: <span class="text-white">ุงููุญูููู +2 ููุทุฉ</span> (ุนูุงุจ)</p>
            </div>
            <!-- ุดุฑุญ ุงูุชุญุฏู ุงูุฃุนูู -->
            <div class="p-3 bg-purple-500/10 rounded-xl border border-purple-500/20 text-right mt-2">
              <p class="text-purple-400 mb-1">๐ ุงูุชุญุฏู ุงูุฃุนูู:</p>
              <p class="text-slate-300">ูุฏ ูุง ูููู ููุงู ุถุงูุน ุฃู ุงููู ุถุงูุน! <span class="text-white">ุงููู ููุณุจ ููุทุฉ
                  ูุงุญุฏุฉ!</span></p>
            </div>
          </div>
        </div>
      </div>
      <button onclick="showScreen('start')"
        class="btn-gradient w-full py-6 rounded-3xl mt-10 font-black text-white shadow-2xl text-2xl text-center">ุชูุ
        ูููุนุจ! ๐ฅ</button>
    </div>
  </div>

  <!-- Modals -->
  <div id="modal-stats"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[500] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full text-center">
      <div id="player-stat-avatar" class="text-6xl mb-4 text-center"></div>
      <h3 id="player-stat-name" class="text-2xl font-black text-white mb-4 text-center"></h3>

      <div class="bg-white/5 p-4 rounded-3xl mb-6 text-center">
        <p class="text-slate-400 text-xs mb-2 font-bold">ุฅุฌูุงูู ุงููุดุงุท</p>
        <div class="grid grid-cols-2 gap-y-4 gap-x-2 text-center">
          <div class="text-center border-b border-l border-white/5 pb-2">
            <p class="text-indigo-400 text-lg font-black" id="stat-total-games">0</p>
            <p class="text-[10px] text-slate-500 uppercase">ูุนุจุฉ</p>
          </div>
          <div class="text-center border-b border-white/5 pb-2">
            <p class="text-yellow-400 text-lg font-black" id="stat-total-points">0</p>
            <p class="text-[10px] text-slate-500 uppercase">ูุฌููุน ุงูููุงุท</p>
          </div>
          <div class="text-center border-l border-white/5 pt-2">
            <p class="text-emerald-400 text-lg font-black" id="stat-total-wins">0</p>
            <p class="text-[10px] text-slate-500 uppercase">ููุฒ</p>
          </div>
          <div class="text-center pt-2">
            <p class="text-red-400 text-lg font-black" id="stat-total-losses">0</p>
            <p class="text-[10px] text-slate-500 uppercase">ุฎุณุงุฑุฉ</p>
          </div>
        </div>
      </div>

      <p class="text-slate-400 text-[10px] mb-3 text-right font-bold">ุชูุงุตูู ุงูุฃุฏูุงุฑ:</p>
      <div class="grid grid-cols-2 gap-4 mb-8 text-right">
        <div class="bg-emerald-500/10 p-3 rounded-2xl border border-emerald-500/20 text-right">
          <p class="text-[10px] text-emerald-400 font-bold mb-1">๐ต๏ธ ูุญูู</p>
          <div class="flex justify-between text-xs font-black"><span>ููุฒ: <span
                id="stat-det-w">0</span></span><span>ุฎุณุงุฑุฉ: <span id="stat-det-l">0</span></span></div>
        </div>
        <div class="bg-indigo-500/10 p-3 rounded-2xl border border-indigo-500/20 text-right">
          <p class="text-[10px] text-indigo-400 font-bold mb-1">๐ซ๏ธ ุถุงูุน</p>
          <div class="flex justify-between text-xs font-black"><span>ููุฒ: <span
                id="stat-out-w">0</span></span><span>ุฎุณุงุฑุฉ: <span id="stat-out-l">0</span></span></div>
        </div>
        <div class="bg-orange-500/10 p-3 rounded-2xl border border-orange-500/20 text-right">
          <p class="text-[10px] text-orange-400 font-bold mb-1">๐ญ ุนููู</p>
          <div class="flex justify-between text-xs font-black"><span>ููุฒ: <span
                id="stat-agt-w">0</span></span><span>ุฎุณุงุฑุฉ: <span id="stat-agt-l">0</span></span></div>
        </div>
        <div class="bg-yellow-500/10 p-3 rounded-2xl border border-yellow-500/20 text-right">
          <p class="text-[10px] text-yellow-400 font-bold mb-1">๐คซ ูููู</p>
          <div class="flex justify-between text-xs font-black"><span>ููุฒ: <span
                id="stat-und-w">0</span></span><span>ุฎุณุงุฑุฉ: <span id="stat-und-l">0</span></span></div>
        </div>
      </div>
      <button onclick="closeStatsModal()"
        class="w-full py-4 btn-secondary rounded-2xl font-black text-white">ุฅุบูุงู</button>
    </div>
  </div>

  <div id="modal-alert"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[200] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full text-center">
      <h3 class="text-2xl font-black mb-4 text-yellow-400">ุชูุจูู! โ๏ธ</h3>
      <p id="alert-message" class="text-slate-300 font-bold mb-8"></p>
      <button onclick="closeAlert()"
        class="w-full py-4 btn-gradient rounded-3xl font-black text-white text-xl">ููุงูู</button>
    </div>
  </div>

  <div id="modal-confirm"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[100] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full text-center">
      <h3 class="text-3xl font-black mb-6 text-red-500">ุชุฃููุฏ! โ๏ธ</h3>
      <p class="mb-10 text-slate-400 text-lg font-bold">ูู ุชุฑูุฏ ุชุตููุฑ ุฌููุน ุงูููุงุท ูุงูุฅุญุตุงุฆูุงุช ููุงุฆูุงูุ</p>
      <div class="flex gap-4">
        <button onclick="closeModal()"
          class="flex-1 py-5 btn-secondary rounded-3xl font-bold text-xl text-white">ุชุฑุงุฌุน</button>
        <button onclick="resetPoints()"
          class="flex-1 py-5 bg-red-600 rounded-3xl font-black text-white shadow-2xl text-xl">ูุนูุ ุตููุฑ</button>
      </div>
    </div>
  </div>

  <!-- Category Switch Modal -->
  <div id="modal-category"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[2000] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full shadow-2xl text-center font-black">
      <h3 class="text-2xl font-black mb-8 text-white underline decoration-indigo-500">ุชุจุฏูู ุงููุฆุฉ โ๏ธ</h3>
      <div id="modal-categories-grid" class="grid grid-cols-2 gap-4 mb-10 text-center"></div>
      <button onclick="closeCategoryModal()"
        class="w-full py-5 btn-gradient rounded-3xl font-black text-white text-xl">ุชุฃููุฏ ูุฅุบูุงู</button>
    </div>
  </div>

  <script>
    // --- 0. ุงูุชุนุฑููุงุช ุงูุฃุณุงุณูุฉ ูุงูุชูุงุจุน ุงููุณุงุนุฏุฉ ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function formatTimeLabel(seconds) {
      if (seconds === 30) return "30 ุซุงููุฉ";
      if (seconds === 60) return "ุฏูููุฉ ูุงุญุฏุฉ";
      if (seconds === 120) return "ุฏูููุชุงู";
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return secs === 0 ? `${mins} ุฏูุงุฆู` : `${mins} ุฏูููุฉ ู${secs} ุซุงููุฉ`;
    }

    function closeModal() {
      ['modal-stats', 'modal-alert', 'modal-confirm', 'modal-category'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
    }

    function closeStatsModal() {
      document.getElementById('modal-stats').classList.add('hidden');
    }

    function checkResetButtonVisibility() {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const hasData = saved.some(p => (p.points || 0) > 0 || (p.stats && ((p.stats.det?.w || 0) > 0 || (p.stats.out?.w || 0) > 0)));
      const trigger = document.getElementById('btn-reset-points-trigger');
      if (trigger) trigger.classList.toggle('hidden', !hasData);
    }

    function closeAlert() {
      document.getElementById('modal-alert').classList.add('hidden');
    }

    // ุฏุงูุฉ ุชุนููู ุงูุฃูุงุชุงุฑ
    function setAvatar(playerIdx, avatar) {
      document.querySelectorAll(`#names-container > div:nth-child(${playerIdx + 1}) .avatar-btn`).forEach(b => b.classList.remove('selected'));
      const btn = document.getElementById(`av-${playerIdx}-${avatar}`);
      if (btn) btn.classList.add('selected');
      const hiddenInp = document.getElementById(`avatar-${playerIdx}`);
      if (hiddenInp) hiddenInp.value = avatar;
    }

    // Vibration function
    function triggerVibrate(pattern) {
      if (state.isVibrationEnabled && navigator.vibrate) {
        navigator.vibrate(pattern);
      }
    }

    // Toggle Vibration function
    function toggleVibration() {
      state.isVibrationEnabled = !state.isVibrationEnabled;
      const btn = document.getElementById('vibrate-toggle');
      if (state.isVibrationEnabled) {
        btn.innerText = '๐ณ';
        triggerVibrate(50); // Feedback
      } else {
        btn.innerText = '๐ด';
      }
    }

    function playTone(freq, duration, type = 'sine', vol = 0.1) {
      if (typeof state !== 'undefined' && state.isMuted) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
      gain.gain.setValueAtTime(vol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
      osc.start(); osc.stop(audioCtx.currentTime + duration);
    }

    // ุตูุช "ููุด" ูููุจ ุงูุจุทุงูุฉ
    function playFlipSound() {
      if (state.isMuted) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'triangle';

      // ุงูุฒูุงู ุณุฑูุน ููุชุฑุฏุฏ ูู ุนุงูู ูููุฎูุถ
      osc.frequency.setValueAtTime(400, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);

      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.2);
    }

    // ุตูุช ูุถุญู (Funny Sound)
    function playFunnySound() {
      if (state.isMuted) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.type = 'sawtooth';

      // ุชุฑุฏุฏ ูุชุฐุจุฐุจ (Wobbly)
      osc.frequency.setValueAtTime(300, audioCtx.currentTime);
      osc.frequency.linearRampToValueAtTime(150, audioCtx.currentTime + 0.2);
      osc.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.4);
      osc.frequency.linearRampToValueAtTime(150, audioCtx.currentTime + 0.6);

      gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
      gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.6);

      osc.start();
      osc.stop(audioCtx.currentTime + 0.6);
    }

    const sounds = {
      tick: () => { playTone(800, 0.05, 'sine', 0.03); triggerVibrate(15); },
      win: () => { playTone(523, 0.1); setTimeout(() => playTone(659, 0.1), 100); setTimeout(() => playTone(783, 0.3), 200); triggerVibrate([100, 50, 100, 50, 100]); },
      lose: () => { playTone(150, 0.6, 'sawtooth', 0.15); triggerVibrate([200, 100, 200]); },
      wrong: () => { playTone(100, 0.5, 'square', 0.2); triggerVibrate(300); },
      flip: () => { playFlipSound(); triggerVibrate(40); },
      funny: () => { playFunnySound(); triggerVibrate([50, 50, 50, 50, 50]); }
    };

    const wordBank = {
      "ุทุนุงู": [{ word: "ุจูุชุฒุง", emoji: "๐", desc: "ุฃููุฉ ุฅูุทุงููุฉ ุฏุงุฆุฑูุฉ ุจุตูุตุฉ ูุฌุจูุฉ.", related: "ูุทูุฑุฉ" }, { word: "ูุจุณุฉ", emoji: "๐", desc: "ุฑุฒ ููุญูุ ุฃููุฉ ุฎููุฌูุฉ ูุดููุฑุฉ.", related: "ููุฏู" }, { word: "ุจุฑุฌุฑ", emoji: "๐", desc: "ูุญู ูุดูู ุฏุงุฎู ุฎุจุฒ ูุน ุฌุจูุฉ.", related: "ุณุงูุฏูุชุด" }, { word: "ุดุงูุฑูุง", emoji: "๐ฏ", desc: "ูุญู ููุทุน ููููู ูู ุฎุจุฒ ุตุงุฌ.", related: "ููุงูู" }, { word: "ุจุงุณุชุง", emoji: "๐", desc: "ููุฑููุฉ ุฅูุทุงููุฉ ุจุตูุตุงุช ููููุฉ.", related: "ูุงุฒุงููุง" }, { word: "ุณูุดู", emoji: "๐ฃ", desc: "ุฑุฒ ูุณูู ููููู ูุงุจุงูู.", related: "ุฑูุจูุงู" }, { word: "ููุงูุฉ", emoji: "๐ฎ", desc: "ุญููู ุดุฑููุฉ ุจุงูุฌุจูุฉ ุฃู ุงููุดุทุฉ.", related: "ุจุณุจูุณุฉ" }, { word: "ุฌุฑูุด", emoji: "๐ฅฃ", desc: "ุฃููุฉ ุดุนุจูุฉ ุจูุถุงุก ูุดููุฑุฉ.", related: "ุณููู" }, { word: "ูุทูุฑุฉ", emoji: "๐ฅ", desc: "ุนุฌููุฉ ูุญุดูุฉ ูุฎุจูุฒุฉ ูู ุงููุฑู.", related: "ุจูุชุฒุง" }, { word: "ููุฏู", emoji: "๐ฒ", desc: "ูุญู ูุทูู ูู ุญูุฑุฉ ุชุญุช ุงูุฃุฑุถ.", related: "ูุจุณุฉ" }, { word: "ุณุงูุฏูุชุด", emoji: "๐ฅช", desc: "ุทุนุงู ููุถุน ุจูู ุดุฑูุญุชูู ูู ุงูุฎุจุฒ.", related: "ุจุฑุฌุฑ" }, { word: "ููุงูู", emoji: "๐ง", desc: "ุฃูุฑุงุต ููููุฉ ูู ุงูุญูุต.", related: "ุดุงูุฑูุง" }, { word: "ูุงุฒุงููุง", emoji: "๐ฅ", desc: "ุทุจูุงุช ุนุฌูู ูุน ุงููุญู ูุงูุจุงุดููู.", related: "ุจุงุณุชุง" }, { word: "ุฑูุจูุงู", emoji: "๐ค", desc: "ูุฃูููุงุช ุจุญุฑูุฉ ูุฐูุฐุฉ.", related: "ุณูุดู" }, { word: "ุจุณุจูุณุฉ", emoji: "๐ฅฎ", desc: "ุญููู ุณููุฏ ูุงุนูุฉ ููุญูุงุฉ.", related: "ููุงูุฉ" }, { word: "ุณููู", emoji: "๐ฅ", desc: "ุฑุฒ ูุทุจูุฎ ุจุงูุญููุจ.", related: "ุฌุฑูุด" }],
      "ุฃุฏูุงุช": [{ word: "ุดุงุญู", emoji: "๐", desc: "ูููุฐ ุฌูุงูู ููุง ุชุฎูุต ุงูุจุทุงุฑูุฉ.", related: "ุชูุตููุฉ" }, { word: "ูููู", emoji: "โ๏ธ", desc: "ูุจุฑุฏ ุงูุฌู ูู ุงูุตูู ุงูุญุงุฑู.", related: "ูุฑูุญุฉ" }, { word: "ุณุงุนุฉ", emoji: "โ", desc: "ุชููุจุณ ูู ุงููุนุตู ููุนุฑูุฉ ุงูููุช.", related: "ุณูุงุฑ" }, { word: "ูุธุงุฑุฉ", emoji: "๐", desc: "ุชุณุงุนุฏู ุชุดูู ุจูุถูุญ.", related: "ุนุฏุณุงุช" }, { word: "ูุทุฑูุฉ", emoji: "๐จ", desc: "ุฃุฏุงุฉ ุจูุงุก ุชูุณุชุฎุฏู ูุฏู ุงููุณุงููุฑ.", related: "ููู" }, { word: "ููุต", emoji: "โ๏ธ", desc: "ุฃุฏุงุฉ ููุต ุงููุฑู.", related: "ุณููู" }, { word: "ุชูุตููุฉ", emoji: "๐", desc: "ุฃุฏุงุฉ ูุชูุตูู ุงูููุฑุจุงุก.", related: "ุดุงุญู" }, { word: "ูุฑูุญุฉ", emoji: "๐", desc: "ุฃุฏุงุฉ ุชุญุฑู ุงูููุงุก.", related: "mููู" }],
      "ูุงุฑูุงุช": [{ word: "ุฃุจู", emoji: "๐", desc: "ุดุฑูุฉ ุชูููุฉ ูุดููุฑุฉ ุจุงูุขูููู.", related: "ุณุงูุณููุฌ" }, { word: "ูุงููู", emoji: "โ๏ธ", desc: "ูุงุฑูุฉ ุฑูุงุถูุฉ ุนุงูููุฉ.", related: "ุฃุฏูุฏุงุณ" }, { word: "ูุฑุณูุฏุณ", emoji: "๐", desc: "ุณูุงุฑุงุช ุฃููุงููุฉ ูุฎูุฉ.", related: "ุจู ุฅู" }, { word: "ุจูุจุณู", emoji: "๐ฅค", desc: "ูุดุฑูุจ ุบุงุฒู ุนุงููู.", related: "ูููุงูููุง" }, { word: "ุณุงูุณููุฌ", emoji: "๐ฑ", desc: "ุดุฑูุฉ ููุฑูุฉ ููุงูุณุฉ ูุฃุจู.", related: "ุฃุจู" }, { word: "ุฃุฏูุฏุงุณ", emoji: "๐", desc: "ูุงุฑูุฉ ุฑูุงุถูุฉ ุฃููุงููุฉ.", related: "ูุงููู" }, { word: "ุจู ุฅู", emoji: "๐", desc: "ุณูุงุฑุงุช ุฃููุงููุฉ ุฑูุงุถูุฉ.", related: "ูุฑุณูุฏุณ" }, { word: "ูููุงูููุง", emoji: "๐ฅค", desc: "ูุดุฑูุจ ุบุงุฒู ุฃุญูุฑ.", related: "ุจูุจุณู" }],
      "ุญููุงูุงุช": [{ word: "ุฎุฑูู", emoji: "๐", desc: "ุญููุงู ุงููุฒุฑุนุฉ ุงูููุถู ูู ุงูุนูุฏ.", related: "ูุงุนุฒ" }, { word: "ุฃุณุฏ", emoji: "๐ฆ", desc: "ููู ุงูุบุงุจุฉ.", related: "ููุฑ" }, { word: "ุฌูู", emoji: "๐ช", desc: "ุณูููุฉ ุงูุตุญุฑุงุก.", related: "ูุงูุฉ" }, { word: "ุฏูููู", emoji: "๐ฌ", desc: "ุญููุงู ุจุญุฑู ุฐูู.", related: "ุญูุช" }, { word: "ูุงุนุฒ", emoji: "๐", desc: "ุญููุงู ูุดุจู ุงูุฎุฑูู.", related: "ุฎุฑูู" }, { word: "ููุฑ", emoji: "๐ฏ", desc: "ูุท ูุจูุฑ ูุฎุทุท.", related: "ุฃุณุฏ" }, { word: "ูุงูุฉ", emoji: "๐ซ", desc: "ุฃูุซู ุงูุฌูู.", related: "ุฌูู" }, { word: "ุญูุช", emoji: "๐", desc: "ุฃุถุฎู ุญููุงู ุจุญุฑู.", related: "ุฏูููู" }],
      "ุชูููููุฌูุง": [{ word: "ุฌูุงู", emoji: "๐ฑ", desc: "ุฌูุงุฒ ูู ุฌูุจู ููุตูู ุจุงูุนุงูู.", related: "ุงูุจุงุฏ" }, { word: "ุญุงุณูุจ", emoji: "๐ป", desc: "ุฌูุงุฒ ููุฏุฑุงุณุฉ ูุงูุนูู.", related: "ูุงุจุชูุจ" }, { word: "ุฅูุชุฑูุช", emoji: "๐", desc: "ุงูุดุจูุฉ ุงูุนุงูููุฉ.", related: "ูุงู ูุงู" }, { word: "ุฑูุจูุช", emoji: "๐ค", desc: "ุขูุฉ ูุจุฑูุฌุฉ.", related: "ุฐูุงุก ุงุตุทูุงุนู" }],
      "ุฃูุนุงุจ": [{ word: "ุจูุงูุณุชูุดู", emoji: "๐ฎ", desc: "ุฌูุงุฒ ุฃูุนุงุจ ุณููู.", related: "ุงูุณ ุจููุณ" }, { word: "ูููุง", emoji: "โฝ", desc: "ูุนุจุฉ ูุฑุฉ ุงููุฏู.", related: "ุจูุณ" }, { word: "ุดุทุฑูุฌ", emoji: "โ๏ธ", desc: "ูุนุจุฉ ุฐูุงุก.", related: "ุถุงูุฉ" }, { word: "ุงูุณ ุจููุณ", emoji: "โ", desc: "ุฌูุงุฒ ุฃูุนุงุจ ูุงููุฑูุณููุช.", related: "ุจูุงูุณุชูุดู" }],
      "ูุดุฑูุจุงุช": [{ word: "ูููุฉ", emoji: "โ", desc: "ูุดุฑูุจ ูุนุฏู ุงููุฒุงุฌ.", related: "ุดุงู" }, { word: "ุญูุถูุงุช", emoji: "๐", desc: "ูุดุฑูุจ ุบุงุฒู ุจุฑุชูุงูู.", related: "ููุฑูุฏุง" }, { word: "ุดุงู", emoji: "๐ต", desc: "ูุดุฑูุจ ุณุงุฎู ุดุนุจู.", related: "ูููุฉ" }],
      "ุฃูุงูู": [{ word: "ููุฉ", emoji: "๐", desc: "ูุจูุฉ ุงููุณูููู.", related: "ุงููุฏููุฉ" }, { word: "ุจุงุฑูุณ", emoji: "๐ผ", desc: "ูุฏููุฉ ุงูุนุทูุฑ.", related: "ููุฏู" }, { word: "ุงููุฏููุฉ", emoji: "๐", desc: "ูุฏููุฉ ุงูุฑุณูู.", related: "ููุฉ" }],
      "ุฏูู": [{ word: "ุงูุณุนูุฏูุฉ", emoji: "๐ธ๐ฆ", desc: "ุฏููุฉ ุฎููุฌูุฉ.", related: "ุงููููุช" }, { word: "ูุตุฑ", emoji: "๐ช๐ฌ", desc: "ุฃุฑุถ ุงูููุงูุฉ.", related: "ุงูุณูุฏุงู" }],
      "ุนุทูุฑ": [{ word: "ุจุฎูุฑ", emoji: "๐จ", desc: "ุฑุงุฆุญุฉ ุดุฑููุฉ.", related: "ูุณู" }, { word: "ุฏูู ุนูุฏ", emoji: "๐ชต", desc: "ุฒูุช ุนุทุฑู ุซููู.", related: "ูุฑุฏ" }],
      "ูููุงุช ุฎุงุตุฉ": []
    };

    const avatars = ["๐ต๏ธ", "๐ค", "๐ฎ", "๐งโ๐", "๐ง", "๐ฆ", "๐ฆ", "๐ผ", "๐ค", "๐ฆ", "๐ฆ"];
    const funnyTitles = ["ุงูุถุงูุน ุงููุจุชุฏูุก", "ุงููุญูู ุงููุชุฏุฑุจ", "ููู ุงูุชูููู", "ูููุงู ุงูุณุงููุฉ", "ุฃุณุทูุฑุฉ ุงูุณูุงูู"];
    const roleNamesMap = { 'in': '๐ต๏ธ ูุญูู', 'out': '๐ซ๏ธ ุงูุถุงูุน', 'agent': '๐ญ ุนููู', 'undercover': '๐คซ ุงููููู' };

    let state = {
      players: [], currentRoles: [], secretData: null, timer: 60, initialTimer: 60, interval: null,
      revealIndex: 0, isPaused: false, doubleAgentActive: false, undercoverActive: false, guessingEnabled: true,
      outPlayerIds: [], agentPlayerId: null, undercoverPlayerId: null, selectedCategory: "ุทุนุงู",
      customWords: [], isMuted: false, lastWinner: null,
      votingMode: 'group', voterIndex: 0, votesAccumulated: {}, panicMode: false,
      smartDistractors: false, blindModeActive: false, blindRoundType: null, isVibrationEnabled: true
    };

    // --- 2. ูุธุงุฆู ุงูุชุญูู ูุงูุนุฑุถ ---

    function toggleMute() {
      state.isMuted = !state.isMuted;
      document.getElementById('mute-toggle').innerText = state.isMuted ? '๐' : '๐';
    }

    // ุฏุงูุฉ ูุฅุธูุงุฑ ูุฅุฎูุงุก ุฎูุงุฑ "ุงูุฎูุงุฑุงุช ุงูุฐููุฉ" ุจูุงุกู ุนูู ุฎูุงุฑ ุงูุชุฎููู
    function toggleSmartSettings() {
      const guessingEnabled = document.getElementById('check-guessing').checked;
      const smartContainer = document.getElementById('smart-distractors-container');
      if (smartContainer) {
        if (guessingEnabled) {
          smartContainer.classList.remove('hidden');
          smartContainer.classList.add('flex');
        } else {
          smartContainer.classList.add('hidden');
          smartContainer.classList.remove('flex');
        }
      }
    }

    function showScreen(screenId) {
      document.querySelectorAll('#app > div').forEach(div => div.classList.add('hidden'));
      const target = document.getElementById(`screen-${screenId}`);
      if (target) {
        target.classList.remove('hidden');
        target.scrollTop = 0; // The Fix: Scroll to top
        window.scrollTo(0, 0); // Safety net
      }
      if (screenId === 'setup') renderCategories('categories-grid');
      if (screenId === 'leaderboard') { updateLeaderboardUI('leaderboard-list'); checkResetButtonVisibility(); }
      if (screenId === 'final') updateFinalResultsUI();
    }

    function renderCategories(gridId) {
      const grid = document.getElementById(gridId);
      if (!grid) return; grid.innerHTML = '';
      const icons = { "ุทุนุงู": "๐", "ุฃุฏูุงุช": "๐๏ธ", "ูุงุฑูุงุช": "๐ท๏ธ", "ุญููุงูุงุช": "๐พ", "ุชูููููุฌูุง": "๐ป", "ุฃูุนุงุจ": "๐ฎ", "ูุดุฑูุจุงุช": "โ", "ุฃูุงูู": "๐", "ุฏูู": "๐", "ุนุทูุฑ": "๐งด", "ูููุงุช ุฎุงุตุฉ": "โ๏ธ", "ุนุดูุงุฆู": "๐ฒ" };

      // ุฅุถุงูุฉ ุฎูุงุฑ ุนุดูุงุฆู ูู ุงูุจุฏุงูุฉ
      grid.innerHTML += `<div onclick="selectCategory('ุนุดูุงุฆู', '${gridId}')" class="category-card ${state.selectedCategory === 'ุนุดูุงุฆู' ? 'active' : ''}"><span>๐ฒ</span><span class="text-xs text-white">ุนุดูุงุฆู</span></div>`;

      Object.keys(wordBank).forEach(cat => {
        if (gridId === 'modal-categories-grid' && cat === "ูููุงุช ุฎุงุตุฉ" && state.customWords.length < 4) return;
        const isActive = state.selectedCategory === cat;
        const emoji = icons[cat] || '๐ท๏ธ';
        grid.innerHTML += `<div onclick="selectCategory('${cat}', '${gridId}')" class="category-card ${isActive ? 'active' : ''}"><span>${emoji}</span><span class="text-xs text-white font-bold text-center">${cat}</span></div>`;
      });
    }

    function selectCategory(cat, gridId) {
      state.selectedCategory = cat;
      renderCategories(gridId);
      sounds.tick();
      if (gridId === 'categories-grid') {
        const ui = document.getElementById('custom-words-ui');
        if (ui) ui.classList.toggle('hidden', cat !== "ูููุงุช ุฎุงุตุฉ");
      }
    }

    function addCustomWord() {
      const input = document.getElementById('custom-word-input');
      const word = input.value.trim();
      if (word) {
        if (state.customWords.some(w => w.word.toLowerCase() === word.toLowerCase())) {
          document.getElementById('alert-message').innerText = "ูุฐู ุงููููุฉ ูุถุงูุฉ ุจุงููุนู!";
          document.getElementById('modal-alert').classList.remove('hidden');
          document.getElementById('modal-alert').classList.add('flex');
          return;
        }
        state.customWords.push({ word, emoji: "โ๏ธ", desc: "ุณุงููุฉ ุฎุงุตุฉ." });
        input.value = ''; renderCustomWords(); renderCategories('categories-grid');
      }
    }

    function renderCustomWords() {
      const list = document.getElementById('custom-words-list');
      if (!list) return;
      list.innerHTML = '';
      state.customWords.forEach((w, i) => {
        list.innerHTML += `<span class="bg-indigo-500/20 px-2 py-1 rounded-full text-[10px] text-white">${w.word} <button onclick="state.customWords.splice(${i},1);renderCustomWords();">ร</button></span>`;
      });
      wordBank["ูููุงุช ุฎุงุตุฉ"] = state.customWords;
    }

    // --- 3. ูุธุงุฆู ุงูุฅุนุฏุงุฏ ูุงููุงุนุจูู ---

    function setVotingMode(mode) {
      state.votingMode = mode;
      const groupBtn = document.getElementById('btn-vote-group');
      const indivBtn = document.getElementById('btn-vote-individual');

      if (mode === 'group') {
        groupBtn.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-indigo-600 text-white shadow-lg";
        indivBtn.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white";
      } else {
        indivBtn.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-indigo-600 text-white shadow-lg";
        groupBtn.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-white";
      }
      sounds.tick();
    }

    function updateSetupInfo() {
      const pVal = document.getElementById('input-players').value;
      const tVal = document.getElementById('input-time').value;
      if (!pVal || isNaN(tVal)) return;
      document.getElementById('val-players').innerText = pVal;
      document.getElementById('val-time-label').innerText = formatTimeLabel(tVal);
      const agentContainer = document.getElementById('double-agent-container');
      const undercoverContainer = document.getElementById('undercover-container');
      const avail = parseInt(pVal) >= 5;
      if (agentContainer) agentContainer.classList.toggle('opacity-30', !avail);
      if (undercoverContainer) undercoverContainer.classList.toggle('opacity-30', !avail);
      if (!avail) {
        document.getElementById('check-double-agent').checked = false;
        document.getElementById('check-undercover').checked = false;
      }
      // ุงูุชุฃูุฏ ูู ุญุงูุฉ ุฎูุงุฑ ุงูุชุฎููู ุนูุฏ ุงูุชุญุฏูุซ
      toggleSmartSettings();
    }

    function checkAndNext() {
      if (state.selectedCategory === "ูููุงุช ุฎุงุตุฉ" && state.customWords.length < 4) return showAlert("ุฃุถู 4 ูููุงุช ุนูู ุงูุฃูู!");
      initPlayerNames();
    }

    function initPlayerNames() {
      const count = parseInt(document.getElementById('input-players').value);
      const container = document.getElementById('names-container');
      if (!container) return;
      container.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      for (let i = 0; i < count; i++) {
        const p = saved[i] || { name: `ุงููุญูู ${i + 1}`, avatar: avatars[i % avatars.length] };
        container.innerHTML += `<div class="bg-white/5 p-4 rounded-3xl border border-white/10 shadow-inner text-right"><div class="flex gap-3 mb-3 flex-row-reverse text-right"><input type="text" id="name-${i}" value="${p.name}" class="player-input flex-1 bg-slate-800 border-none rounded-2xl p-3 text-white font-bold outline-none focus:ring-2 ring-indigo-500 text-right"><input type="hidden" id="avatar-${i}" value="${p.avatar}"></div><div class="flex flex-wrap gap-2 justify-center">${avatars.map(a => `<button onclick="setAvatar(${i}, '${a}')" id="av-${i}-${a}" class="avatar-btn ${a === p.avatar ? 'selected' : ''}">${a}</button>`).join('')}</div></div>`;
      }
      showScreen('names');
    }

    function startGame() {
      const count = parseInt(document.getElementById('input-players').value);
      state.players = [];
      const savedData = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      for (let i = 0; i < count; i++) {
        const nameInp = document.getElementById(`name-${i}`);
        const name = nameInp ? nameInp.value.trim() : `ูุงุนุจ ${i + 1}`;
        const avatar = document.getElementById(`avatar-${i}`).value;
        const existing = savedData[i];
        const emptyStats = { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } };
        state.players.push({
          id: i,
          name,
          avatar,
          points: existing ? (existing.points || 0) : 0,
          stats: existing?.stats || { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } }
        });
      }
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(state.players));
      state.timer = parseInt(document.getElementById('input-time').value);
      state.initialTimer = state.timer;
      state.doubleAgentActive = document.getElementById('check-double-agent').checked;
      state.undercoverActive = document.getElementById('check-undercover') ? document.getElementById('check-undercover').checked : false;
      // Get guessing setting
      state.guessingEnabled = document.getElementById('check-guessing').checked;
      // Get smart distractors setting
      state.smartDistractors = document.getElementById('check-smart-distractors') ? document.getElementById('check-smart-distractors').checked : false;
      // Get blind mode
      state.blindModeActive = document.getElementById('check-blind-mode') ? document.getElementById('check-blind-mode').checked : false;

      setupRoles();
      state.revealIndex = 0;
      state.panicMode = false;

      // Check visibility of panic button based on settings
      const panicBtn = document.getElementById('btn-panic');
      if (panicBtn) {
        if (state.guessingEnabled && state.smartDistractors) {
          panicBtn.classList.remove('hidden');
        } else {
          panicBtn.classList.add('hidden');
        }
      }

      startRevealSequence();
    }

    function setupRoles() {
      // ุงุฎุชูุงุฑ ูุฆุฉ ูุนููุฉ ุฅุฐุง ูุงู ุงูุงุฎุชูุงุฑ ุนุดูุงุฆู
      let actualCategory = state.selectedCategory;
      if (actualCategory === "ุนุดูุงุฆู") {
        let keys = Object.keys(wordBank).filter(k => k !== "ูููุงุช ุฎุงุตุฉ");
        if (state.customWords.length >= 4) {
          keys.push("ูููุงุช ุฎุงุตุฉ");
        }
        actualCategory = keys[Math.floor(Math.random() * keys.length)];
      }
      state.currentRoundCategory = actualCategory; // ุญูุธ ุงููุฆุฉ ุงูุญุงููุฉ ููุงุณุชุฎุฏุงู

      let pool = wordBank[actualCategory] || wordBank["ุทุนุงู"];
      state.secretData = pool[Math.floor(Math.random() * pool.length)];
      let ids = state.players.map(p => p.id).sort(() => 0.5 - Math.random());

      // ุงูููุทู ุงูุงูุชุฑุงุถู
      let outID = ids.splice(0, 1)[0];
      state.outPlayerIds = [outID];
      state.agentPlayerId = (state.doubleAgentActive && ids.length > 0) ? ids.splice(0, 1)[0] : null;
      state.undercoverPlayerId = (state.undercoverActive && ids.length > 0) ? ids.splice(0, 1)[0] : null;

      // ุชุทุจูู ููุทู ุงูุชุญุฏู ุงูุฃุนูู (35% ูุฑุตุฉ)
      if (state.blindModeActive && Math.random() < 0.5) {
        // ุฅุฑุฌุงุน ุงูุถุงูุน ููููู ูุญููุงู
        state.outPlayerIds = [];
        state.agentPlayerId = null;
        state.undercoverPlayerId = null;

        // ูู ุญุงูุฉ "ุงููู ุถุงูุน" (50% ูู ุญุงูุงุช ุงูุชุญุฏู ุงูุฃุนูู)
        if (Math.random() < 0.5) {
          state.blindRoundType = 'all_out'; // ุงููู ุถุงูุน
          // ูุนุทู ุงูุฌููุน ุฏูุฑ "out" ูุงุญูุงู
        } else {
          state.blindRoundType = 'all_in'; // ุงููู ูุญูู
        }
      } else {
        state.blindRoundType = null;
      }

      state.currentRoles = state.players.map(p => {
        let role = 'in';
        if (state.blindRoundType === 'all_out') {
          role = 'out';
        } else if (state.blindRoundType === 'all_in') {
          role = 'in';
        } else {
          if (p.id === (state.outPlayerIds.length > 0 ? state.outPlayerIds[0] : -1)) role = 'out';
          else if (p.id === state.agentPlayerId) role = 'agent';
          else if (p.id === state.undercoverPlayerId) role = 'undercover';
        }
        return { id: p.id, role: role };
      });
    }

    function startRevealSequence() {
      if (state.revealIndex >= state.players.length) return showScreen('game'), startTimer();
      const p = state.players[state.revealIndex];
      document.getElementById('reveal-player-name').innerText = `${p.avatar} ${p.name}`;
      // Reset card
      const cardObj = document.getElementById('role-card');
      if (cardObj) cardObj.classList.remove('is-flipped');

      document.getElementById('btn-reveal-action').innerText = 'ุฅุธูุงุฑ ุงูุณุงููุฉ';
      document.getElementById('btn-reveal-action').onclick = toggleReveal;

      // Populate back of card with hidden data
      populateCardBack(p);

      showScreen('reveal');
    }

    function populateCardBack(player) {
      const roleData = state.currentRoles.find(r => r.id === player.id);
      const txt = document.getElementById('reveal-role-text');
      const word = document.getElementById('reveal-secret-word');
      const img = document.getElementById('reveal-img-placeholder');
      const descPlaceholder = document.getElementById('reveal-word-desc');

      if (roleData.role === 'in') {
        txt.innerText = "ุฃูุช ุชุนุฑู ุงูุณุงููุฉ!"; word.innerText = state.secretData.word;
        img.innerText = state.secretData.emoji; descPlaceholder.innerText = state.secretData.desc || "";
        txt.className = "text-xl font-bold mb-4 text-emerald-400";
      }
      else if (roleData.role === 'agent') {
        txt.innerText = "ุฃูุช ุงูุนููู ุงููุฒุฏูุฌ! ุงุญูู ุงูุถุงูุน:"; word.innerText = state.secretData.word;
        img.innerText = "๐ญ"; descPlaceholder.innerText = state.secretData.desc || "";
        txt.className = "text-xl font-bold mb-4 text-orange-400";
      }
      else if (roleData.role === 'undercover') {
        let undercoverObj;
        if (state.currentRoundCategory === "ูููุงุช ุฎุงุตุฉ") {
          undercoverObj = state.customWords.find(w => w.word !== state.secretData.word);
        } else {
          undercoverObj = (wordBank[state.currentRoundCategory] || []).find(w => w.word === state.secretData.related);
        }
        let relWord = undercoverObj ? undercoverObj.word : (state.secretData.related || "ุณุงููุฉ ูุฑูุจุฉ");
        let relDesc = undercoverObj ? undercoverObj.desc : "ูููุฉ ูุฑูุจุฉ ุชุถูู ุจูุง ุงููุญูููู.";
        txt.innerText = "ุฃูุช ุงููููู! ูููุชู ูู:"; word.innerText = relWord;
        img.innerText = "๐คซ"; descPlaceholder.innerText = relDesc;
        txt.className = "text-xl font-bold mb-4 text-yellow-400";
      }
      else {
        txt.innerText = "ุฃูุช ุงูุถุงูุน!"; word.innerText = "ุุุุุ"; img.innerText = "๐ต๏ธโโ๏ธ"; descPlaceholder.innerText = "ุุุุุ";
        txt.className = "text-xl font-bold mb-4 text-red-500";
      }
    }

    // New function to handle card flip
    function flipCard() {
      const cardObj = document.getElementById('role-card');
      const btn = document.getElementById('btn-reveal-action');

      if (!cardObj.classList.contains('is-flipped')) {
        // Flip it
        cardObj.classList.add('is-flipped');
        sounds.flip(); // Play sound
        btn.innerText = "ุงูุชุงูู";
      } else {
        // Already flipped, so clicking card acts like clicking next
        // But typically user clicks the button. We can allow card click to advance too?
        // Let's keep card click just for flipping/re-checking, button for next.
      }
    }

    // Modified toggleReveal to handle the button click flow
    function toggleReveal() {
      const cardObj = document.getElementById('role-card');
      const btn = document.getElementById('btn-reveal-action');

      if (!cardObj.classList.contains('is-flipped')) {
        // Flip
        cardObj.classList.add('is-flipped');
        sounds.flip();
        btn.innerText = "ุงูุชุงูู";
      } else {
        // Next player - with delay fix for glitch
        cardObj.classList.remove('is-flipped');
        sounds.flip();

        setTimeout(() => {
          state.revealIndex++;
          startRevealSequence();
        }, 250);
      }
    }

    function startTimer() {
      state.isPaused = false;
      clearInterval(state.interval);
      state.interval = setInterval(() => {
        if (state.isPaused) return;
        state.timer--;
        const circumference = 565.48;
        const progressEl = document.getElementById('timer-progress');
        if (progressEl) progressEl.style.strokeDashoffset = circumference * (1 - (state.timer / state.initialTimer));
        const m = Math.floor(state.timer / 60), s = state.timer % 60;
        const timerEl = document.getElementById('game-timer');
        if (timerEl) timerEl.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        if (state.timer <= 5 && state.timer > 0) sounds.tick();
        if (state.timer <= 0) { clearInterval(state.interval); startVoting(); }
      }, 1000);
    }

    // --- ูุธุงุฆู ุงูุชุตููุช ุงููุญุฏุซุฉ ---

    function startVoting() {
      state.voterIndex = 0;
      state.votesAccumulated = {};
      state.players.forEach(p => state.votesAccumulated[p.id] = 0);
      updateVotingGrid();
      showScreen('voting');
    }

    function updateVotingGrid() {
      const grid = document.getElementById('voting-grid');
      const voterIndicator = document.getElementById('voter-indicator');
      const instruction = document.getElementById('voting-instruction');
      grid.innerHTML = '';

      if (state.votingMode === 'individual') {
        const currentVoter = state.players[state.voterIndex];
        voterIndicator.innerText = `ุฏูุฑ ุงููุตููุช: ${currentVoter.avatar} ${currentVoter.name}`;
        voterIndicator.classList.remove('hidden');
        instruction.innerText = "ุงุฎุชุฑ ุงูุดุฎุต ุงูุฐู ุชุนุชูุฏ ุฃูู ุงูุถุงูุน";
      } else {
        voterIndicator.classList.add('hidden');
        instruction.innerText = "ุงุชูููุง ุนูู ุดุฎุต ูุงุญุฏ ูุงุถุบุทูุง ุนููู ูุจุงุดุฑุฉ";
      }

      state.players.forEach(p => {
        if (state.votingMode === 'individual' && state.players[state.voterIndex].id === p.id) return;
        grid.innerHTML += `<button onclick="handleVoteClick(${p.id})" class="p-4 bg-white/5 border border-white/10 rounded-3xl flex flex-col items-center gap-2 active:bg-indigo-500/20 transition-all text-center">
                    <span class="text-4xl text-center">${p.avatar}</span>
                    <span class="font-black text-xs text-white text-center">${p.name}</span>
                </button>`;
      });
    }

    function handleVoteClick(accusedId) {
      if (state.votingMode === 'group') {
        processVoteResult(accusedId);
      } else {
        state.votesAccumulated[accusedId]++;
        state.voterIndex++;
        sounds.tick();
        if (state.voterIndex < state.players.length) {
          updateVotingGrid();
        } else {
          let mostVotedId = null;
          let maxVotes = -1;
          for (const id in state.votesAccumulated) {
            if (state.votesAccumulated[id] > maxVotes) {
              maxVotes = state.votesAccumulated[id];
              mostVotedId = parseInt(id);
            } else if (state.votesAccumulated[id] === maxVotes && maxVotes > 0) {
              const role = state.currentRoles.find(r => r.id === parseInt(id)).role;
              if (role === 'out' || role === 'undercover') mostVotedId = parseInt(id);
            }
          }
          processVoteResult(mostVotedId);
        }
      }
    }

    function triggerPanic() {
      clearInterval(state.interval);
      state.panicMode = true; // ุชูุนูู ูุถุน ุงูููุน

      // ุฌูุจ ุงุณู ุงูุถุงูุน ุงูุญุงูู
      const outPlayerId = state.outPlayerIds.length > 0 ? state.outPlayerIds[0] : null;
      let name = "ุงูุถุงูุน";

      if (outPlayerId !== null) {
        const outPlayer = state.players.find(p => p.id === outPlayerId);
        name = outPlayer ? outPlayer.name : "ุงูุถุงูุน";
      } else if (state.blindRoundType === 'all_out') {
        name = "ุงููู";
      }

      startGuessingPhase(name, true);
    }

    function processVoteResult(id) {
      // ุงูุชุญูู ูู "ุงูุชุญุฏู ุงูุฃุนูู" ุฃููุงู
      if (state.blindRoundType) {
        const accusedPlayer = state.players.find(p => p.id === id);
        const name = accusedPlayer ? accusedPlayer.name : "";

        let msg = "";
        if (state.blindRoundType === 'all_in') {
          msg = `ูููุจ! ๐คฃ ${name} ุจุฑูุก ูุงููู ุจุฑูุก! ูุง ูุงู ููู ุถุงูุน!`;
        } else {
          msg = `ูุงุฑุซุฉ! ๐คก ${name} ุถุงูุน ูุงููู ุถุงูุน! ูุญุฏ ูุนุฑู ุงูุณุงููุฉ!`;
        }

        // ุชุดุบูู ุงูุตูุช ุงููุถุญู
        sounds.funny();
        showFinalResults('blind_win', msg);
        return;
      }

      const isActualOut = state.outPlayerIds.includes(id);
      const isUndercover = (id === state.undercoverPlayerId);

      if (isActualOut) {
        // Check if guessing is enabled
        if (state.guessingEnabled) {
          const caughtPlayer = state.players.find(p => p.id === id);
          startGuessingPhase(caughtPlayer ? caughtPlayer.name : null);
        } else {
          // Immediate Game Over - Group Wins with Name
          const caughtPlayer = state.players.find(p => p.id === id);
          const name = caughtPlayer ? caughtPlayer.name : "";
          showFinalResults('group_win', `ุชู ูุดู ุงูุถุงูุน (${name})! ูุง ููุฌุฏ ูุฑุตุฉ ููุชุฎููู ๐ซ`);
        }
      } else if (isUndercover) {
        showFinalResults('out_win', "ุงููููู ุฎุฏุนูู ุจูุฌุงุญ! ๐คซ ูุงุฒ ูุฑูู ุงูุถุงูุน");
      } else {
        sounds.wrong();
        document.body.classList.add('wrong-flash-active');
        document.getElementById('app').classList.add('shake-effect');
        setTimeout(() => {
          document.body.classList.remove('wrong-flash-active');
          document.getElementById('app').classList.remove('shake-effect');
          showFinalResults('out_win', "ุงูุงุฎุชูุงุฑ ูุงู ุฎุงุทุฆุงู! ๐ซ๏ธ ูุงุฒ ูุฑูู ุงูุถุงูุน");
        }, 600);
      }
    }

    function startGuessingPhase(caughtName, isPanic = false) {
      const container = document.getElementById('guess-options');
      if (!container) return;
      container.innerHTML = '';

      const titleElement = document.getElementById('guess-title');
      const subtitleElement = document.getElementById('guess-subtitle');

      if (titleElement) {
        if (isPanic) {
          // Panic Mode
          titleElement.innerText = "๐จ ุชุฎููู ุงูููุน! ๐จ";
          titleElement.className = "text-2xl sm:text-3xl font-black mb-6 text-orange-500";
          if (subtitleElement) {
            subtitleElement.innerText = `ูุฏูู ุจุนุถ ุงูุดุฌุงุนุฉ ูุง ${caughtName || 'ุจุทู'}! ๐`;
            subtitleElement.classList.remove('hidden');
          }
        } else {
          // Caught Mode
          const namePart = caughtName ? ` ูุง ${caughtName}` : "";
          titleElement.innerText = `ูุฏูู ูุฑุตุฉ ุฃุฎูุฑุฉ ูุชุณุฑู ุงูููุฒ${namePart}..`;
          titleElement.className = "text-xl sm:text-2xl font-black mb-4 text-red-400 leading-normal";
          if (subtitleElement) {
            subtitleElement.innerText = "ุฎูู ุงูุณุงููุฉ ูู ุงูุฎูุงุฑุงุช ุงูุชุงููุฉ!";
            subtitleElement.classList.remove('hidden');
          }
        }
      }

      // Handle Timer for Panic Mode
      const timerContainer = document.getElementById('guess-timer-container');
      const timerEl = document.getElementById('guess-timer');

      if (state.guessInterval) clearInterval(state.guessInterval);

      if (isPanic) {
        timerContainer.classList.remove('hidden');
        let timeLeft = 30;
        timerEl.innerText = timeLeft;

        state.guessInterval = setInterval(() => {
          timeLeft--;
          timerEl.innerText = timeLeft;
          if (timeLeft <= 5 && timeLeft > 0) sounds.tick();

          if (timeLeft <= 0) {
            clearInterval(state.guessInterval);
            showFinalResults('group_win', "ุงูุชูู ุงูููุช! (ุนูุงุจ ูุถุงุนู) โณ");
          }
        }, 1000);
      } else {
        timerContainer.classList.add('hidden');
      }

      let pool = wordBank[state.currentRoundCategory] || wordBank["ุทุนุงู"];
      let finalDistractors = [];

      if (state.smartDistractors) {
        // --- ุงูุฐูุงุก ูู ุงูุชุฎููู (Smart Distractors) ---
        let potentialDistractors = [];

        // 1. ุงูุฃููููุฉ ุงูุฃููู: ุงููููุฉ ุงููุฑุชุจุทุฉ ูุจุงุดุฑุฉ
        const directRelated = pool.find(w => w.word === state.secretData.related);
        if (directRelated) potentialDistractors.push(directRelated);

        // 2. ุงูุฃููููุฉ ุงูุซุงููุฉ: ุงููููุงุช ุงูุชู ุชุฑุชุจุท ุจุงูุณุงููุฉ
        const reverseRelated = pool.filter(w => w.related === state.secretData.word);
        potentialDistractors.push(...reverseRelated);

        // 3. ุงูุฃููููุฉ ุงูุซุงูุซุฉ: ูุฑุชุจุท ุงููุฑุชุจุท
        if (directRelated) {
          const chainedRelated = pool.find(w => w.word === directRelated.related);
          if (chainedRelated) potentialDistractors.push(chainedRelated);
        }

        // 4. ููุชุฑุฉ ูุชูููุฉ ุงูุนุฏุฏ ูู ููุณ ุงููุฆุฉ
        const seenWords = new Set();
        seenWords.add(state.secretData.word);

        for (const item of potentialDistractors) {
          if (!seenWords.has(item.word)) {
            finalDistractors.push(item);
            seenWords.add(item.word);
          }
        }

        if (finalDistractors.length > 3) {
          finalDistractors = finalDistractors.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        if (finalDistractors.length < 3) {
          let remainder = pool.filter(w => !seenWords.has(w.word));
          remainder = remainder.sort(() => 0.5 - Math.random());
          while (finalDistractors.length < 3 && remainder.length > 0) {
            finalDistractors.push(remainder.pop());
          }
        }
      } else {
        // --- ุนุดูุงุฆู (Random) ---
        let distractors = pool.filter(w => w.word !== state.secretData.word);
        finalDistractors = distractors.sort(() => 0.5 - Math.random()).slice(0, 3);
      }

      let options = [...finalDistractors, state.secretData];
      options = options.sort(() => 0.5 - Math.random());

      options.forEach(opt => {
        container.innerHTML += `<button onclick="checkGuess('${opt.word}')" class="w-full py-4 bg-white/5 rounded-2xl text-lg font-black border border-white/5 text-white">${opt.word}</button>`;
      });
      showScreen('guess');
    }

    function checkGuess(word) {
      if (state.guessInterval) clearInterval(state.guessInterval);

      if (word === state.secretData.word) {
        if (state.panicMode) {
          showFinalResults('out_win', "ุชุฎููู ุฃุณุทูุฑู! (ููุงุท ูุถุงุนูุฉ) ๐ฅ");
        } else {
          showFinalResults('out_win', "ุชุฎููู ุตุญ! ุงูุถุงูุน ูุงุฒ ๐ง");
        }
      } else {
        if (state.panicMode) {
          showFinalResults('group_win', "ูุญุงููุฉ ูุงุดูุฉ! (ุนูุงุจ ูุถุงุนู) ๐ซ");
        } else {
          showFinalResults('group_win', "ุงููุญูููู ููุชุตุฑูู! โ๏ธ");
        }
      }
    }

    function showFinalResults(type, title) {
      state.lastWinner = type === 'group_win' ? 'group' : 'out';

      if (type === 'blind_win') {
        document.getElementById('final-status-emoji').innerText = '๐คก';
        // ูู ุงูููุฒ ุงูุฃุนููุ ุงูุฌููุน ูุญุตู ุนูู ููุทุฉ ูุงุญุฏุฉ (ุฌุงุฆุฒุฉ ุชุฑุถูุฉ)
        state.lastWinner = 'blind';
        // ูุง ูููุถ ุฃุญูุฑ
      } else {
        document.getElementById('final-status-emoji').innerText = type === 'group_win' ? '๐' : '๐';
      }

      document.getElementById('final-result-title').innerText = title;
      document.getElementById('final-secret-word').innerText = state.secretData.word;
      document.getElementById('final-word-emoji').innerText = state.secretData.emoji;
      document.getElementById('topic-description').innerText = state.secretData.desc || "";

      if (type === 'group_win') { sounds.win(); createConfetti(); }
      else if (type === 'blind_win') { createConfetti(true); } // Confetti with clowns - Sound played before
      else { sounds.lose(); }

      awardPoints(state.lastWinner);
      showScreen('final');
    }

    function awardPoints(winner) {
      let saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');

      const roleToStatKey = {
        'in': 'det',
        'out': 'out',
        'agent': 'agt',
        'undercover': 'und'
      };

      saved = saved.map((p) => {
        const roleData = state.currentRoles.find(r => r.id === p.id);
        if (!roleData) return p;

        // ุชููุฆุฉ ุงูุฅุญุตุงุฆูุงุช ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ
        if (!p.stats) p.stats = { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } };

        const statKey = roleToStatKey[roleData.role];
        const isOutSide = (roleData.role === 'out' || roleData.role === 'agent' || roleData.role === 'undercover');

        if (winner === 'blind') {
          p.points += 1;
          if (statKey && p.stats[statKey]) {
            p.stats[statKey].w++;
          }
        }
        else if (winner === 'group') {
          if (!isOutSide) {
            p.points += (state.panicMode ? 2 : 1);
            p.stats.det.w++;
          } else {
            if (statKey) p.stats[statKey].l++;
          }
        }
        else if (winner === 'out' || winner === 'out_win') {
          if (isOutSide) {
            let pts = 2;
            if (roleData.role === 'out' && state.panicMode) pts = 4;
            p.points += pts;

            if (statKey) p.stats[statKey].w++;
          }
          else {
            p.stats.det.l++;
          }
        }
        return p;
      });
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(saved));
      state.players = saved;
    }

    function updateFinalResultsUI() {
      const list = document.getElementById('final-leaderboard');
      if (!list) return;
      list.innerHTML = '';
      state.players.forEach(p => {
        const roleData = state.currentRoles.find(r => r.id === p.id);
        if (!roleData) return;
        const isOutSide = (roleData.role === 'out' || roleData.role === 'agent' || roleData.role === 'undercover');

        let didWin = false;
        if (state.lastWinner === 'group' && !isOutSide) didWin = true;
        if ((state.lastWinner === 'out' || state.lastWinner === 'out_win') && isOutSide) didWin = true;
        if (state.lastWinner === 'blind') didWin = true; // ุงูุฌููุน ูุงุฆุฒ ูู ุงููุถุน ุงูุฃุนูู

        const colorClass = didWin ? 'bg-emerald-500/20 border-emerald-500/40 text-emerald-100' : 'bg-red-500/20 border-red-500/40 text-red-100';
        const roleLabel = roleNamesMap[roleData.role] || 'ูุญูู';

        list.innerHTML += `<div class="flex items-center justify-between p-3 rounded-2xl border ${colorClass} mb-2 shadow-inner text-right"><div class="flex items-center gap-3"><span class="text-2xl">${p.avatar}</span><div class="text-right"><p class="font-black text-white text-sm text-right">${p.name}</p><p class="text-[8px] uppercase opacity-60 text-white text-right">${roleLabel}</p></div></div><span class="font-mono text-xs font-black text-white">${p.points}</span></div>`;
      });
    }

    function updateLeaderboardUI(containerId) {
      const list = document.getElementById('leaderboard-list');
      if (!list) return;
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const sorted = [...saved].sort((a, b) => b.points - a.points);
      list.innerHTML = '';
      sorted.forEach((p, idx) => {
        const title = funnyTitles[Math.min(Math.floor(p.points / 3), funnyTitles.length - 1)];
        list.innerHTML += `<div onclick="openStatsModal(${p.id})" class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 cursor-pointer text-right"><div class="flex items-center gap-4 text-right"><span class="text-3xl">${p.avatar}</span><div class="text-right"><p class="font-black text-white text-right">${p.name}</p><p class="text-[10px] text-indigo-400 font-bold text-right">${title}</p></div></div><span class="bg-indigo-500/20 px-3 py-1 rounded-full font-mono text-sm font-black text-indigo-200">${p.points}</span></div>`;
      });
    }

    function openStatsModal(playerId) {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const p = saved.find(x => x.id === playerId);
      if (!p) return;
      // Ensure stats exist
      const s = p.stats || { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } };

      const wins = (s.det?.w || 0) + (s.out?.w || 0) + (s.agt?.w || 0) + (s.und?.w || 0);
      const loss = (s.det?.l || 0) + (s.out?.l || 0) + (s.agt?.l || 0) + (s.und?.l || 0);

      document.getElementById('player-stat-avatar').innerText = p.avatar;
      document.getElementById('player-stat-name').innerText = p.name;
      document.getElementById('stat-total-games').innerText = wins + loss;
      document.getElementById('stat-total-points').innerText = p.points;
      document.getElementById('stat-total-wins').innerText = wins;
      document.getElementById('stat-total-losses').innerText = loss;
      document.getElementById('stat-det-w').innerText = s.det.w; document.getElementById('stat-det-l').innerText = s.det.l;
      document.getElementById('stat-out-w').innerText = s.out.w; document.getElementById('stat-out-l').innerText = s.out.l;
      document.getElementById('stat-agt-w').innerText = s.agt?.w || 0; document.getElementById('stat-agt-l').innerText = s.agt?.l || 0;
      document.getElementById('stat-und-w').innerText = s.und?.w || 0; document.getElementById('stat-und-l').innerText = s.und?.l || 0;
      document.getElementById('modal-stats').classList.remove('hidden'); document.getElementById('modal-stats').classList.add('flex');
    }

    function resetPoints() {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const reset = saved.map(p => ({ ...p, points: 0, stats: { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } } }));
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(reset));
      state.players = reset;
      closeModal(); updateLeaderboardUI('leaderboard-list'); checkResetButtonVisibility();
    }

    function checkResetButtonVisibility() {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const has = saved.some(p => p.points > 0);
      const btn = document.getElementById('btn-reset-points-trigger');
      if (btn) btn.classList.toggle('hidden', !has);
    }

    function openCategoryModal() {
      const modal = document.getElementById('modal-category');
      if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        renderCategories('modal-categories-grid');
      }
    }

    function closeCategoryModal() {
      const m = document.getElementById('modal-category');
      if (m) { m.classList.add('hidden'); m.classList.remove('flex'); }
    }

    function showAlert(msg) {
      const alertMsg = document.getElementById('alert-message');
      const modal = document.getElementById('modal-alert');
      if (alertMsg && modal) {
        alertMsg.innerText = msg;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }
    }

    function restartSameGame() {
      state.timer = state.initialTimer;
      setupRoles();
      state.revealIndex = 0;
      state.panicMode = false;
      startRevealSequence();
    }

    function pauseTimer() { state.isPaused = !state.isPaused; document.getElementById('btn-pause').innerText = state.isPaused ? "ุงุณุชุฆูุงู" : "ุฅููุงู ูุคูุช"; }
    function endGameEarly() { clearInterval(state.interval); startVoting(); }

    // ุชู ุชุญุฏูุซ ุงูุฏุงูุฉ ูุชุฏุนู "ูุทุฑ ุงูููุฑุฌูู"
    function createConfetti(isClown = false) {
      const container = document.getElementById('confetti-container');
      if (!container) return;
      // Clear previous confetti
      container.innerHTML = '';

      const colors = ['#6366f1', '#10b981', '#ef4444', '#fbbf24', '#f472b6'];
      const clowns = ['๐คก', '๐คฃ', '๐คช', '๐ช', '๐'];

      // ุฒูุงุฏุฉ ุงูุนุฏุฏ ููููุฑุฌูู
      const count = isClown ? 100 : 80;

      for (let i = 0; i < count; i++) {
        const c = document.createElement('div');
        c.style.left = Math.random() * 100 + 'vw';

        if (isClown) {
          c.className = 'emoji-drop text-4xl';
          c.innerText = clowns[Math.floor(Math.random() * clowns.length)];
        } else {
          c.className = 'confetti-piece';
          c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          // Use standard confetti animation for non-clowns
          c.style.top = '-20px';
          c.animate([{ transform: 'translateY(0) rotate(0deg)', opacity: 1 }, { transform: `translateY(100vh) rotate(720deg)`, opacity: 0 }], { duration: 2000 + Math.random() * 2000 });
        }

        container.appendChild(c);

        if (isClown) {
          // Set random animation duration for CSS animation
          c.style.animationDuration = (2 + Math.random() * 3) + 's';
          c.style.animationDelay = (Math.random() * 2) + 's';
        }
      }

      // Remove after 5 seconds
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateSetupInfo();
      renderCustomWords();
    });
  </script>
</body>

</html>