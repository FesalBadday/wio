<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Ù…Ù† Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">

  <style>
    /* --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Themes) --- */
    :root {
      /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) */
      --bg-gradient-start: #1e293b;
      --bg-gradient-end: #0f172a;
      --text-main: #f8fafc;
      /* Ø£Ø¨ÙŠØ¶ */
      --text-muted: #94a3b8;
      /* Ø±ØµØ§ØµÙŠ ÙØ§ØªØ­ */
      --glass-bg: rgba(30, 41, 59, 0.95);
      --glass-border: rgba(255, 255, 255, 0.1);
      --card-bg: rgba(255, 255, 255, 0.05);
      --card-border: rgba(255, 255, 255, 0.1);
      --btn-sec-bg: transparent;
      --btn-sec-text: #fff;
      --btn-sec-border: rgba(255, 255, 255, 0.1);

      --primary: #6366f1;
    }

    body.light-mode {
      /* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ - ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨Ø§ÙŠÙ† ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ */
      --bg-gradient-start: #f1f5f9;
      --bg-gradient-end: #e2e8f0;
      --text-main: #0f172a;
      /* ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© */
      --text-muted: #475569;
      /* Ø±ØµØ§ØµÙŠ ØºØ§Ù…Ù‚ */
      --glass-bg: rgba(255, 255, 255, 0.85);
      /* Ø®Ù„ÙÙŠØ© Ø²Ø¬Ø§Ø¬ÙŠØ© Ø£ÙØªØ­ */

      /* --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: Ø²ÙŠØ§Ø¯Ø© ÙˆØ¶ÙˆØ­ Ø§Ù„Ø­Ø¯ÙˆØ¯ --- */
      --glass-border: rgba(0, 0, 0, 0.15);
      /* Ø­Ø¯ÙˆØ¯ Ø£ØºÙ…Ù‚ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
      --card-bg: rgba(255, 255, 255, 0.6);
      --card-border: rgba(0, 0, 0, 0.15);
      /* Ø­Ø¯ÙˆØ¯ Ø£ØºÙ…Ù‚ Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
      --btn-sec-bg: rgba(255, 255, 255, 1);
      --btn-sec-text: #334155;
      --btn-sec-border: rgba(0, 0, 0, 0.2);
      /* Ø­Ø¯ÙˆØ¯ Ø£ØºÙ…Ù‚ Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© */
    }

    /* ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª */
    body {
      font-family: 'Cairo', sans-serif;
      background-color: var(--bg-gradient-end);
      background: radial-gradient(circle at center, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0;
      overflow: hidden;
      touch-action: manipulation;
      transition: background 0.5s ease, color 0.3s ease;
      padding: env(safe-area-inset-top) 1rem env(safe-area-inset-bottom) 1rem;
    }

    /* ÙØ¦Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø«ÙŠÙ… */
    .text-theme-main {
      color: var(--text-main) !important;
    }

    .text-theme-muted {
      color: var(--text-muted) !important;
    }

    .bg-card-theme {
      background-color: var(--card-bg);
      border: 1px solid var(--card-border);
    }

    .border-theme {
      border-color: var(--glass-border);
    }

    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø²Ø¬Ø§Ø¬ */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      border-radius: 2.5rem;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
      max-height: 94vh;
      width: 100%;
      max-width: 550px;
      overflow-y: auto;
      position: relative;
      padding: 1.5rem;
      z-index: 10;
      transition: all 0.3s ease;
    }

    .btn-gradient {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn-gradient:active {
      transform: scale(0.96);
    }

    .btn-secondary-theme {
      background: var(--btn-sec-bg);
      color: var(--btn-sec-text);
      border: 1px solid var(--btn-sec-border);
      transition: all 0.2s;
    }

    .btn-secondary-theme:active {
      transform: scale(0.96);
    }

    /* Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    * {
      scrollbar-width: none;
      -ms-overflow-style: none;
      -webkit-tap-highlight-color: transparent;
    }

    *::-webkit-scrollbar {
      display: none;
    }

    body.wrong-flash-active {
      background: #450a0a !important;
    }

    @keyframes shake {

      0%,
      100% {
        transform: translateX(0);
      }

      20% {
        transform: translateX(-12px) rotate(-1deg);
      }

      40% {
        transform: translateX(12px) rotate(1deg);
      }

      60% {
        transform: translateX(-12px) rotate(-1deg);
      }

      80% {
        transform: translateX(12px) rotate(1deg);
      }
    }

    .shake-effect {
      animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
    }

    /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ */
    .card-scene {
      perspective: 1000px;
      width: 100%;
      max-width: 320px;
      height: 420px;
      margin: 0 auto 2rem auto;
      cursor: pointer;
      position: relative;
      z-index: 10;
    }

    .card-object {
      width: 100%;
      height: 100%;
      position: relative;
      transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
      transform-style: preserve-3d;
    }

    .card-object.is-flipped {
      transform: rotateY(180deg);
    }

    .card-face {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      border-radius: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.15);
      overflow: hidden;
    }

    .card-face-front {
      background: linear-gradient(135deg, var(--bg-gradient-end) 0%, var(--bg-gradient-start) 100%);
      border: 2px solid var(--glass-border);
    }

    .card-face-back {
      background: var(--glass-bg);
      /* Ø§Ù„Ø¢Ù† ØªØ£Ø®Ø° Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø«ÙŠÙ… */
      border: 4px solid rgba(99, 102, 241, 0.3);
      transform: rotateY(180deg);
      padding: 1.5rem;
    }

    @keyframes space-float {

      0%,
      100% {
        transform: translateY(0px) rotate(0deg);
        opacity: 0.1;
      }

      50% {
        transform: translateY(-15px) rotate(5deg);
        opacity: 0.4;
      }
    }

    .space-floater {
      position: absolute;
      font-weight: 900;
      animation: space-float 6s ease-in-out infinite;
      user-select: none;
    }

    @keyframes fall {
      0% {
        transform: translateY(-10vh) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
      }
    }

    .emoji-drop {
      position: absolute;
      top: -50px;
      animation-name: fall;
      animation-timing-function: linear;
      animation-fill-mode: forwards;
      z-index: 9999;
      pointer-events: none;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      top: -20px;
    }

    .category-card {
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      padding: 1rem 0.5rem;
      border-radius: 1.5rem;
      background: var(--card-bg);
      text-align: center;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
      color: var(--text-main);
      border: 1px solid var(--card-border);
      /* Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ÙˆØ¯ ÙˆØ§Ø¶Ø­Ø© */
    }

    .category-card.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.25);
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 10px;
      background: #334155;
      border-radius: 15px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 28px;
      height: 28px;
      background: var(--primary);
      border: 4px solid #fff;
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }

    .custom-checkbox {
      appearance: none;
      width: 58px;
      height: 30px;
      background-color: #334155;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .custom-checkbox:checked {
      background-color: var(--primary);
      box-shadow: 0 0 15px rgba(99, 102, 241, 0.5);
    }

    .custom-checkbox::before {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background-color: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: all 0.3s;
    }

    .custom-checkbox:checked::before {
      transform: translateX(28px);
    }

    #orientation-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-dark);
      z-index: 10000;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem;
    }

    @media screen and (orientation: landscape) and (pointer: coarse) {
      #orientation-overlay {
        display: flex;
      }
    }
  </style>
</head>

<body>

  <div id="orientation-overlay">
    <div class="text-6xl mb-6 animate-bounce text-center">ğŸ“±</div>
    <h2 class="text-2xl font-black text-white mb-4 text-center">ÙŠØ±Ø¬Ù‰ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ù…ÙˆØ¯ÙŠ</h2>
  </div>

  <div id="confetti-container"></div>

  <!-- Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯ -->
  <div id="global-controls" class="fixed top-6 left-6 z-50">
    <button onclick="openSettingsModal()"
      class="p-3 bg-card-theme rounded-full border border-theme text-2xl shadow-lg hover:bg-white/20 transition-all active:scale-95 text-theme-main">
      âš™ï¸
    </button>
  </div>

  <div id="app" class="w-full flex justify-center items-center p-4">

    <!-- Start Screen -->
    <div id="screen-start" class="glass-panel text-center">
      <div class="mb-14 detective-float text-8xl sm:text-9xl text-center">ğŸ•µï¸â€â™‚ï¸</div>
      <h1
        class="text-4xl sm:text-6xl font-black mb-8 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 via-purple-400 to-emerald-400 leading-normal">
        Ù…Ù† Ø¨Ø±Ø§ Ø§Ù„Ø³Ø§Ù„ÙØ©ØŸ</h1>
      <p class="text-theme-muted text-base sm:text-xl mb-14 font-bold opacity-90 px-4 mt-6 leading-relaxed text-center">
        Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„ÙƒØ´Ù "Ø§Ù„Ø¶Ø§ÙŠØ¹" Ø¨ÙŠÙ†ÙƒÙ…!</p>
      <div class="space-y-4 text-center">
        <button onclick="showScreen('setup')"
          class="btn-gradient w-full py-6 rounded-3xl text-2xl font-black shadow-2xl">Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
        <div class="grid grid-cols-2 gap-4 text-center">
          <button onclick="showScreen('leaderboard')"
            class="btn-secondary-theme py-4 rounded-2xl font-bold shadow-sm">ğŸ† Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
          <button onclick="showScreen('rules')" class="btn-secondary-theme py-4 rounded-2xl font-bold shadow-sm">ğŸ“– ÙƒÙŠÙ
            Ù†Ù„Ø¹Ø¨ØŸ</button>
        </div>
      </div>
    </div>

    <!-- Setup Screen -->
    <div id="screen-setup" class="glass-panel hidden text-right">
      <h2 class="text-2xl sm:text-3xl font-black mb-6 text-center text-theme-main">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</h2>
      <div class="space-y-6">
        <div>
          <label class="text-theme-muted font-bold block mb-4 text-right">Ø§Ø®ØªØ± ÙØ¦Ø© Ø§Ù„Ø³ÙˆØ§Ù„Ù:</label>
          <div id="categories-grid" class="grid grid-cols-3 gap-2 text-center"></div>
        </div>

        <div id="custom-words-ui"
          class="bg-indigo-500/10 p-5 rounded-3xl border border-indigo-500/20 hidden text-right">
          <label class="text-indigo-500 font-bold block mb-3 text-right text-sm">Ø£Ø¶Ù ÙƒÙ„Ù…Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ© (4 ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰):</label>
          <div class="flex gap-2">
            <input type="text" id="custom-word-input"
              class="flex-1 bg-card-theme border-none rounded-xl p-4 text-theme-main outline-none focus:ring-2 ring-indigo-500 text-sm text-right"
              placeholder="ÙƒÙ„Ù…Ø© Ø³Ø±ÙŠØ©...">
            <button onclick="addCustomWord()"
              class="bg-indigo-600 px-6 rounded-2xl font-black text-white text-sm">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
          <div id="custom-words-list" class="flex flex-wrap gap-2 mt-4 max-h-32 overflow-y-auto justify-end text-right">
          </div>
        </div>

        <div class="p-4 bg-card-theme rounded-2xl flex items-center justify-between transition-all">
          <div class="text-right">
            <h4 class="font-bold text-sm text-theme-main">âš–ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙˆÙŠØª</h4>
            <p class="text-[10px] text-theme-muted italic">Ø·Ø±ÙŠÙ‚Ø© ÙƒØ´Ù Ø§Ù„Ø¶Ø§ÙŠØ¹</p>
          </div>
          <div class="flex bg-slate-900/10 p-1 rounded-xl border border-theme">
            <button id="btn-vote-group" onclick="setVotingMode('group')"
              class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-indigo-600 text-white shadow-lg">Ø¬Ù…Ø§Ø¹ÙŠ</button>
            <button id="btn-vote-individual" onclick="setVotingMode('individual')"
              class="px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-theme-main">ÙØ±Ø¯ÙŠ</button>
          </div>
        </div>

        <div class="grid grid-cols-1 gap-4 text-right">
          <div class="bg-card-theme p-4 rounded-2xl text-right shadow-inner">
            <div class="flex justify-between mb-3 flex-row-reverse">
              <label class="text-theme-muted font-bold text-sm text-right">Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</label>
              <span class="text-indigo-500 font-mono font-black text-xl" id="val-players">3</span>
            </div>
            <input type="range" id="input-players" min="3" max="15" value="3" oninput="updateSetupInfo()">
          </div>
          <div class="bg-card-theme p-4 rounded-2xl text-right shadow-inner">
            <div class="flex justify-between mb-3 flex-row-reverse">
              <label class="text-theme-muted font-bold text-sm text-right">ÙˆÙ‚Øª Ø§Ù„Ù†Ù‚Ø§Ø´</label>
              <span class="text-emerald-500 font-black text-lg" id="val-time-label">Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©</span>
            </div>
            <input type="range" id="input-time" min="30" max="300" step="30" value="60" oninput="updateSetupInfo()">
          </div>
        </div>

        <div class="space-y-3">
          <div id="blind-mode-container"
            class="p-4 bg-card-theme rounded-2xl flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-theme-main">ğŸ™ˆ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø¹Ù…Ù‰</h4>
              <p class="text-[10px] text-theme-muted italic">Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¶Ø§ÙŠØ¹!</p>
            </div>
            <input type="checkbox" id="check-blind-mode" class="custom-checkbox" onchange="updateSetupInfo()">
          </div>

          <div id="guessing-container"
            class="p-4 bg-card-theme rounded-2xl flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-theme-main">ğŸ¯ ÙØ±ØµØ© Ø§Ù„ØªØ®Ù…ÙŠÙ†</h4>
              <p class="text-[10px] text-theme-muted italic">Ù‡Ù„ ÙŠØ­Ù‚ Ù„Ù„Ø¶Ø§ÙŠØ¹ Ø§Ù„ØªØ®Ù…ÙŠÙ†ØŸ</p>
            </div>
            <input type="checkbox" id="check-guessing" class="custom-checkbox" checked onchange="toggleSmartSettings()">
          </div>

          <div id="smart-distractors-container"
            class="p-4 bg-card-theme rounded-2xl flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-theme-main">ğŸ§  Ø®ÙŠØ§Ø±Ø§Øª Ø°ÙƒÙŠØ©</h4>
              <p class="text-[10px] text-theme-muted italic">ÙƒÙ„Ù…Ø§Øª Ù…ØªØ±Ø§Ø¨Ø·Ø© ÙˆØ²Ø± "Ø£Ù†Ø§ Ø¹Ø±ÙØªÙ‡Ø§!"</p>
            </div>
            <input type="checkbox" id="check-smart-distractors" class="custom-checkbox">
          </div>

          <div id="double-agent-container"
            class="p-4 bg-card-theme rounded-2xl flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-theme-main">ğŸ­ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬</h4>
              <p class="text-[10px] text-theme-muted italic">Ù…ØªØ§Ø­ Ù„Ù€ 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙØ£ÙƒØ«Ø±</p>
            </div>
            <input type="checkbox" id="check-double-agent" class="custom-checkbox">
          </div>

          <div id="undercover-container"
            class="p-4 bg-card-theme rounded-2xl flex items-center justify-between transition-all">
            <div class="text-right">
              <h4 class="font-bold text-sm text-theme-main">ğŸ•µï¸ Ø§Ù„Ù…Ù…ÙˆÙ‡</h4>
              <p class="text-[10px] text-theme-muted italic">ÙŠÙ…Ù„Ùƒ ÙƒÙ„Ù…Ø© Ù…Ø´Ø§Ø¨Ù‡Ø©</p>
            </div>
            <input type="checkbox" id="check-undercover" class="custom-checkbox">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 pt-4 text-center">
          <button onclick="showScreen('start')"
            class="py-5 rounded-3xl btn-secondary-theme font-bold text-lg">Ø±Ø¬ÙˆØ¹</button>
          <button onclick="checkAndNext()"
            class="py-5 rounded-3xl btn-gradient font-black text-white text-lg shadow-xl">Ø§Ù„ØªØ§Ù„ÙŠ</button>
        </div>
      </div>
    </div>

    <!-- Names Screen -->
    <div id="screen-names" class="glass-panel hidden text-right">
      <h2 class="text-2xl sm:text-3xl font-black mb-8 text-center text-theme-main">ØªØ¬Ù‡ÙŠØ² ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ† ğŸ”</h2>
      <div id="names-container" class="space-y-4 mb-8 max-h-[50vh] overflow-y-auto px-1"></div>
      <button onclick="startGame()"
        class="btn-gradient w-full py-6 rounded-3xl font-black text-white text-xl shadow-2xl">Ø§Ù†Ø·Ù„Ø§Ù‚! ğŸš€</button>
    </div>

    <!-- Reveal Screen -->
    <div id="screen-reveal" class="glass-panel hidden text-center">
      <div class="text-7xl sm:text-8xl mb-6">ğŸ“±</div>
      <p class="text-theme-muted mb-2 text-xl font-bold">Ù…Ø±Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ù‚Ù‚:</p>
      <h2 id="reveal-player-name" class="text-4xl sm:text-6xl font-black mb-10 text-indigo-500"></h2>

      <div class="card-scene" onclick="flipCard()">
        <div class="card-object" id="role-card">
          <div class="card-face card-face-front relative">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -60%); z-index: 0;">
              <span class="font-black text-theme-muted opacity-10"
                style="font-size: 10rem; display: block; animation: space-float 8s ease-in-out infinite;">?</span>
            </div>
            <span class="space-floater text-6xl text-indigo-500 opacity-40"
              style="top: 2rem; left: 2rem; animation-delay: 1s;">?</span>
            <span class="space-floater text-6xl text-purple-500 opacity-40"
              style="top: 2rem; right: 2rem; animation-delay: 2s;">?</span>
            <span class="space-floater text-6xl text-pink-500 opacity-40"
              style="bottom: 6rem; left: 2rem; animation-delay: 3s;">?</span>
            <span class="space-floater text-6xl text-emerald-500 opacity-40"
              style="bottom: 6rem; right: 2rem; animation-delay: 4s;">?</span>
            <p class="text-theme-muted mt-auto mb-10 font-bold animate-pulse z-10">Ø§Ø¶ØºØ· Ù„Ù„ÙƒØ´Ù</p>
          </div>
          <div class="card-face card-face-back flex flex-col items-center justify-center">
            <p id="reveal-role-text" class="text-xl sm:text-2xl font-bold mb-4"></p>
            <div id="reveal-img-placeholder" class="text-7xl sm:text-8xl mb-4"></div>
            <p id="reveal-secret-word"
              class="text-3xl sm:text-4xl font-black text-theme-main tracking-widest uppercase break-word-custom"></p>
            <p id="reveal-word-desc" class="text-base sm:text-lg text-theme-muted mt-4 italic font-bold"></p>
          </div>
        </div>
      </div>
      <button id="btn-reveal-action" onclick="toggleReveal()"
        class="btn-gradient w-full py-7 rounded-3xl font-black text-2xl text-white shadow-2xl">ÙƒØ´Ù Ø§Ù„Ø¯ÙˆØ±</button>
    </div>

    <!-- Game Screen -->
    <div id="screen-game" class="glass-panel hidden text-center">
      <div class="flex justify-center mb-10">
        <div class="relative w-56 h-56 sm:w-72 sm:h-72 flex items-center justify-center">
          <svg class="absolute inset-0 w-full h-full -rotate-90" viewBox="0 0 200 200">
            <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(128,128,128,0.1)" stroke-width="12"></circle>
            <circle id="timer-progress" cx="100" cy="100" r="90" fill="none" stroke="url(#timer-grad)" stroke-width="12"
              stroke-dasharray="565.48" stroke-dashoffset="0" stroke-linecap="round"
              class="transition-all duration-1000"></circle>
            <defs>
              <linearGradient id="timer-grad">
                <stop offset="0%" stop-color="#6366f1" />
                <stop offset="100%" stop-color="#10b981" />
              </linearGradient>
            </defs>
          </svg>
          <div id="game-timer" class="text-6xl sm:text-8xl font-black font-mono tracking-tighter text-theme-main">00:00
          </div>
        </div>
      </div>
      <p class="text-2xl sm:text-3xl text-theme-muted mb-12 font-bold px-4">ØªÙ†Ø§Ù‚Ø´ÙˆØ§ Ø¨Ø°ÙƒØ§Ø¡.. Ù„Ø§ ØªÙƒØ´ÙÙˆØ§ Ø§Ù„Ø³Ø§Ù„ÙØ© Ù„Ù„Ø¶Ø§ÙŠØ¹!
      </p>
      <button id="btn-panic" onclick="triggerPanic()"
        class="hidden w-full py-4 bg-orange-600/20 border-2 border-orange-500 text-orange-500 rounded-2xl font-black text-xl animate-pulse shadow-[0_0_20px_rgba(249,115,22,0.3)] hover:bg-orange-600/30 transition-all mb-4">ğŸš¨
        Ø£Ù†Ø§ Ø¹Ø±ÙØªÙ‡Ø§!</button>
      <div class="grid grid-cols-2 gap-4">
        <button onclick="endGameEarly()"
          class="py-5 bg-red-500/10 text-red-500 border-2 border-red-500/20 rounded-3xl font-black text-lg">Ø¥Ù†Ù‡Ø§Ø¡
          Ø§Ù„ÙˆÙ‚Øª</button>
        <button onclick="pauseTimer()" id="btn-pause"
          class="py-5 btn-secondary-theme rounded-3xl font-black text-lg">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
      </div>
    </div>

    <!-- Voting Screen -->
    <div id="screen-voting" class="glass-panel hidden text-center">
      <h2 class="text-3xl sm:text-5xl font-black mb-4 text-theme-main">Ù…Ù† Ø§Ù„Ø¶Ø§ÙŠØ¹ØŸ âš–ï¸</h2>
      <div id="voter-indicator" class="text-indigo-500 font-bold mb-4 hidden text-xl"></div>
      <p id="voting-instruction" class="text-theme-muted mb-8 text-lg font-semibold underline decoration-indigo-500">
        Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…ØªÙ‡Ù… Ù…Ø¨Ø§Ø´Ø±Ø©</p>
      <div id="voting-grid" class="grid grid-cols-2 gap-4 mb-8 max-h-[50vh] overflow-y-auto px-2 text-theme-main"></div>
    </div>

    <!-- Guess Screen -->
    <div id="screen-guess" class="glass-panel hidden text-center">
      <h2 id="guess-title" class="text-3xl sm:text-4xl font-black mb-6 text-red-500">Ù„Ù‚Ø¯ ÙƒØ´ÙÙˆÙƒ! ğŸ¯</h2>
      <div id="guess-timer-container" class="hidden mb-6 flex justify-center w-full">
        <div
          class="w-20 h-20 rounded-full border-4 border-orange-500 flex items-center justify-center bg-orange-900/50 shadow-[0_0_25px_rgba(249,115,22,0.4)]">
          <span id="guess-timer" class="text-3xl font-black text-theme-main tabular-nums">30</span>
        </div>
      </div>
      <p id="guess-subtitle" class="text-theme-muted mb-10 text-xl font-bold leading-relaxed">Ø®Ù…Ù† Ø§Ù„Ø³Ø§Ù„ÙØ© Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
        Ø§Ù„ØªØ§Ù„ÙŠØ©!</p>
      <div id="guess-options" class="grid grid-cols-1 gap-4 mb-8"></div>
    </div>

    <!-- Final Result Screen -->
    <div id="screen-final" class="glass-panel hidden text-center overflow-y-auto">
      <div id="final-status-emoji" class="text-8xl sm:text-9xl mb-6">ğŸ†</div>
      <h2 id="final-result-title" class="text-3xl sm:text-5xl font-black mb-6 text-theme-main"></h2>
      <div class="bg-card-theme p-8 rounded-[2.5rem] mb-8 border border-white/10 shadow-2xl">
        <p class="text-theme-muted mb-3 font-bold text-sm uppercase tracking-widest">Ø§Ù„Ø³Ø§Ù„ÙØ© ÙƒØ§Ù†Øª:</p>
        <div id="final-word-emoji" class="text-7xl sm:text-8xl mb-3"></div>
        <p id="final-secret-word"
          class="text-5xl sm:text-7xl font-black text-emerald-500 mb-4 tracking-wider break-word-custom"></p>
        <p id="topic-description" class="text-lg sm:text-xl text-theme-muted opacity-80 italic"></p>
      </div>
      <div class="mb-10 text-right">
        <h3 class="text-2xl sm:text-3xl font-black mb-6 text-center text-theme-main">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØ§Ù„Ø£Ø¯ÙˆØ§Ø±</h3>
        <div id="final-leaderboard" class="space-y-3 text-right"></div>
      </div>
      <div class="grid grid-cols-1 gap-4 text-center">
        <button onclick="restartSameGame()"
          class="btn-gradient py-6 rounded-[2rem] font-black text-white text-2xl shadow-2xl">Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ğŸ”</button>
        <button onclick="openCategoryModal()"
          class="btn-secondary-theme py-5 rounded-2xl font-bold text-lg shadow-md">ØªØºÙŠÙŠØ± Ø§Ù„ÙØ¦Ø© ÙÙ‚Ø· âš™ï¸</button>
        <button onclick="showScreen('start')" class="py-3 text-theme-muted underline text-base font-bold">Ø§Ù„Ø¹ÙˆØ¯Ø©
          Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      </div>
    </div>

    <!-- Leaderboard Screen -->
    <div id="screen-leaderboard" class="glass-panel hidden text-center text-right">
      <h2 class="text-3xl font-black mb-10 text-center text-theme-main">ğŸ† Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø³ÙˆØ§Ù„Ù</h2>
      <p class="text-theme-muted text-xs mb-4 text-center">(Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡)</p>
      <div id="leaderboard-list" class="space-y-4 mb-10 max-h-[60vh] overflow-y-auto px-2 text-right"></div>
      <div id="leaderboard-buttons" class="flex justify-center gap-4 text-center">
        <button onclick="showScreen('start')" id="btn-close-lb"
          class="flex-1 py-5 btn-secondary-theme rounded-3xl font-black border border-theme min-w-[140px]">Ø¥ØºÙ„Ø§Ù‚</button>
        <button id="btn-reset-points-trigger" onclick="confirmReset()"
          class="flex-1 py-5 bg-red-600/20 text-red-500 rounded-3xl font-black border border-red-500/20 text-sm hidden min-w-[140px]">ØªØµÙÙŠØ±
          Ø§Ù„Ù†Ù‚Ø§Ø·</button>
      </div>
    </div>

    <!-- Rules Screen -->
    <div id="screen-rules" class="glass-panel hidden text-right">
      <h2
        class="text-3xl sm:text-4xl font-black mb-10 text-center text-indigo-500 border-b-4 border-indigo-500/10 pb-6">
        ğŸ“œ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø³Ø§Ù„ÙØ© Ø§Ù„Ø´Ø§Ù…Ù„</h2>
      <div class="space-y-6 text-right">
        <div class="rule-card text-right">
          <h4 class="font-black text-indigo-500 mb-3 flex items-center justify-start gap-3 text-xl"><span
              class="order-first">â“</span> Ù…Ø§ Ù‡ÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ</h4>
          <p class="text-base leading-relaxed text-theme-muted font-semibold italic">Ù„Ø¹Ø¨Ø© Ø°ÙƒØ§Ø¡ ÙˆØªÙ…ÙˆÙŠÙ‡ Ø¬Ù…Ø§Ø¹ÙŠØ©.</p>
        </div>
        <div class="rule-card text-right">
          <h4 class="font-black text-indigo-500 mb-3 flex items-center justify-start gap-3 text-xl font-black"><span
              class="order-first">ğŸ­</span> Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ´Ø±ÙˆØ· Ø§Ù„ÙÙˆØ²</h4>
          <ul class="text-sm space-y-4 font-bold text-theme-muted">
            <li>ğŸ•µï¸ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ†: ÙŠÙÙˆØ²ÙˆÙ† Ø¥Ø°Ø§ ÙƒØ´ÙÙˆØ§ Ø§Ù„Ø¶Ø§ÙŠØ¹.</li>
            <li>ğŸŒ«ï¸ Ø§Ù„Ø¶Ø§ÙŠØ¹: ÙŠÙÙˆØ² Ø¥Ø°Ø§ Ù„Ù… ÙŠÙÙƒØ´Ù.</li>
            <li>ğŸ­ Ø§Ù„Ø¹Ù…ÙŠÙ„: ÙŠÙÙˆØ² Ø¥Ø°Ø§ ÙØ§Ø² Ø§Ù„Ø¶Ø§ÙŠØ¹.</li>
            <li>ğŸ¤« Ø§Ù„Ù…Ù…ÙˆÙ‡: ÙŠÙ…Ù„Ùƒ ÙƒÙ„Ù…Ø© Ù‚Ø±ÙŠØ¨Ø©.</li>
          </ul>
        </div>
        <div class="rule-card text-right">
          <h4 class="font-black text-indigo-500 mb-3 flex items-center justify-start gap-3 text-xl font-black"><span
              class="order-first">âš–ï¸</span> Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙˆÙŠØª</h4>
          <ul class="text-sm space-y-4 font-bold text-theme-muted">
            <li>ğŸ—³ï¸ <span class="text-theme-main">ØªØµÙˆÙŠØª Ø¬Ù…Ø§Ø¹ÙŠ:</span> ÙŠØªÙÙ‚ Ø§Ù„Ø¬Ù…ÙŠØ¹.</li>
            <li>ğŸ‘¤ <span class="text-theme-main">ØªØµÙˆÙŠØª ÙØ±Ø¯ÙŠ:</span> ÙƒÙ„ Ø´Ø®Øµ ÙŠØµÙˆØª Ø³Ø±Ø§Ù‹.</li>
          </ul>
        </div>
        <div class="rule-card text-right">
          <h4 class="font-black text-indigo-500 mb-3 flex items-center justify-start gap-3 text-xl font-black"><span
              class="order-first">ğŸ“Š</span> Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·ÙˆØ±</h4>
          <div class="text-xs space-y-3 font-bold text-right leading-relaxed">
            <div class="p-3 bg-emerald-500/10 rounded-xl border border-emerald-500/20 text-right">
              <p class="text-emerald-500 mb-1">ğŸ•µï¸ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ†:</p>
              <p class="text-theme-muted">Ø§Ù„ÙÙˆØ²: <span class="text-theme-main">+1 Ù†Ù‚Ø·Ø©</span> | Ø§Ù„Ø®Ø³Ø§Ø±Ø©: <span
                  class="text-theme-main">0 Ù†Ù‚Ø·Ø©</span></p>
            </div>
            <div class="p-3 bg-indigo-500/10 rounded-xl border border-indigo-500/20 text-right">
              <p class="text-indigo-500 mb-1">ğŸŒ«ï¸ Ø§Ù„Ø¶Ø§ÙŠØ¹ / ğŸ­ Ø§Ù„Ø¹Ù…ÙŠÙ„ / ğŸ¤« Ø§Ù„Ù…Ù…ÙˆÙ‡:</p>
              <p class="text-theme-muted">Ø§Ù„ÙÙˆØ²: <span class="text-theme-main">+2 Ù†Ù‚Ø·Ø©</span> | Ø§Ù„Ø®Ø³Ø§Ø±Ø©: <span
                  class="text-theme-main">0 Ù†Ù‚Ø·Ø©</span></p>
            </div>
            <div class="p-3 bg-orange-500/10 rounded-xl border border-orange-500/20 text-right mt-2">
              <p class="text-orange-500 mb-1">ğŸš¨ Ø²Ø± "Ø£Ù†Ø§ Ø¹Ø±ÙØªÙ‡Ø§!" (Ù„Ù„Ø¶Ø§ÙŠØ¹):</p>
              <p class="text-theme-muted">ØªØ®Ù…ÙŠÙ† ØµØ­ÙŠØ­: <span class="text-theme-main">+4 Ù„Ù„Ø¶Ø§ÙŠØ¹</span></p>
              <p class="text-theme-muted">ØªØ®Ù…ÙŠÙ† Ø®Ø§Ø·Ø¦: <span class="text-theme-main">Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ† +2</span></p>
            </div>
            <div class="p-3 bg-purple-500/10 rounded-xl border border-purple-500/20 text-right mt-2">
              <p class="text-purple-500 mb-1">ğŸ™ˆ Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø¹Ù…Ù‰:</p>
              <p class="text-theme-muted">Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø¶Ø§ÙŠØ¹! <span class="text-theme-main">Ø§Ù„ÙƒÙ„ ÙŠÙƒØ³Ø¨ Ù†Ù‚Ø·Ø©!</span></p>
            </div>
          </div>
        </div>
      </div>
      <button onclick="showScreen('start')"
        class="btn-gradient w-full py-6 rounded-3xl mt-10 font-black text-white shadow-2xl text-2xl text-center">ØªÙ…ØŒ
        Ù„Ù†Ù„Ø¹Ø¨! ğŸ”¥</button>
    </div>
  </div>

  <!-- Modals -->
  <!-- Settings -->
  <div id="modal-settings"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[2000] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full text-center">
      <h3 class="text-2xl font-black mb-8 text-theme-main">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© âš™ï¸</h3>
      <div class="space-y-4">
        <button onclick="toggleMute()" id="btn-toggle-mute"
          class="w-full py-4 bg-white/5 rounded-2xl border border-white/10 text-xl font-bold text-theme-main flex justify-between px-6 items-center">
          <span>Ø§Ù„ØµÙˆØª</span> <span id="lbl-mute">ğŸ”Š</span>
        </button>
        <button onclick="toggleVibration()" id="btn-toggle-vibe"
          class="w-full py-4 bg-white/5 rounded-2xl border border-white/10 text-xl font-bold text-theme-main flex justify-between px-6 items-center">
          <span>Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²</span> <span id="lbl-vibe">ğŸ“³</span>
        </button>
        <button onclick="toggleTheme()" id="btn-toggle-theme"
          class="w-full py-4 bg-white/5 rounded-2xl border border-white/10 text-xl font-bold text-theme-main flex justify-between px-6 items-center">
          <span>Ø§Ù„Ù…Ø¸Ù‡Ø±</span> <span id="lbl-theme">ğŸŒ™</span>
        </button>
      </div>
      <button onclick="closeSettingsModal()"
        class="w-full py-4 mt-8 btn-gradient rounded-3xl font-black text-white text-xl">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- Stats -->
  <div id="modal-stats"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[500] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full text-center">
      <div id="player-stat-avatar" class="text-6xl mb-4 text-center"></div>
      <h3 id="player-stat-name" class="text-2xl font-black text-theme-main mb-4 text-center"></h3>
      <div class="bg-card-theme p-4 rounded-3xl mb-6 text-center">
        <p class="text-theme-muted text-xs mb-2 font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø§Ø·</p>
        <div class="grid grid-cols-2 gap-y-4 gap-x-2 text-center">
          <div class="text-center border-b border-l border-white/5 pb-2">
            <p class="text-indigo-500 text-lg font-black" id="stat-total-games">0</p>
            <p class="text-[10px] text-theme-muted uppercase">Ù„Ø¹Ø¨Ø©</p>
          </div>
          <div class="text-center border-b border-white/5 pb-2">
            <p class="text-yellow-500 text-lg font-black" id="stat-total-points">0</p>
            <p class="text-[10px] text-theme-muted uppercase">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
          </div>
          <div class="text-center border-l border-white/5 pt-2">
            <p class="text-emerald-500 text-lg font-black" id="stat-total-wins">0</p>
            <p class="text-[10px] text-theme-muted uppercase">ÙÙˆØ²</p>
          </div>
          <div class="text-center pt-2">
            <p class="text-red-500 text-lg font-black" id="stat-total-losses">0</p>
            <p class="text-[10px] text-theme-muted uppercase">Ø®Ø³Ø§Ø±Ø©</p>
          </div>
        </div>
      </div>
      <p class="text-theme-muted text-[10px] mb-3 text-right font-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±:</p>
      <div class="grid grid-cols-2 gap-4 mb-8 text-right">
        <div class="bg-emerald-500/10 p-3 rounded-2xl border border-emerald-500/20 text-right">
          <p class="text-[10px] text-emerald-500 font-bold mb-1 text-right">ğŸ•µï¸ Ù…Ø­Ù‚Ù‚</p>
          <div class="flex justify-between text-xs font-black text-right text-theme-main"><span>ÙÙˆØ²: <span
                id="stat-det-w">0</span></span><span>Ø®Ø³Ø§Ø±Ø©: <span id="stat-det-l">0</span></span></div>
        </div>
        <div class="bg-indigo-500/10 p-3 rounded-2xl border border-indigo-500/20 text-right">
          <p class="text-[10px] text-indigo-500 font-bold mb-1 text-right">ğŸŒ«ï¸ Ø¶Ø§ÙŠØ¹</p>
          <div class="flex justify-between text-xs font-black text-right text-theme-main"><span>ÙÙˆØ²: <span
                id="stat-out-w">0</span></span><span>Ø®Ø³Ø§Ø±Ø©: <span id="stat-out-l">0</span></span></div>
        </div>
        <!-- ... -->
      </div>
      <button onclick="closeStatsModal()"
        class="w-full py-4 btn-secondary-theme rounded-2xl font-black text-center">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- Alert -->
  <div id="modal-alert"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[200] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full text-center">
      <h3 class="text-2xl font-black mb-4 text-yellow-500">ØªÙ†Ø¨ÙŠÙ‡! âš ï¸</h3>
      <p id="alert-message" class="text-theme-muted font-bold mb-8 text-center"></p>
      <button onclick="closeAlert()"
        class="w-full py-4 btn-gradient rounded-3xl font-black text-white text-xl text-center">Ù…ÙˆØ§ÙÙ‚</button>
    </div>
  </div>

  <!-- Confirm -->
  <div id="modal-confirm"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[100] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full text-center">
      <h3 class="text-3xl font-black mb-4 text-red-500 text-center">ØªØ£ÙƒÙŠØ¯! âš ï¸</h3>
      <p class="mb-10 text-theme-muted text-lg font-bold text-center">Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·ØŸ</p>
      <div class="flex gap-4 text-center">
        <button onclick="closeModal()"
          class="flex-1 py-5 btn-secondary-theme rounded-3xl font-bold text-xl text-center">ØªØ±Ø§Ø¬Ø¹</button>
        <button onclick="resetPoints()"
          class="flex-1 py-5 bg-red-600 rounded-3xl font-black text-white shadow-2xl text-xl text-center">Ù†Ø¹Ù…</button>
      </div>
    </div>
  </div>

  <!-- Category -->
  <div id="modal-category"
    class="fixed inset-0 bg-slate-950/95 hidden items-center justify-center z-[2000] p-6 backdrop-blur-md text-center">
    <div class="glass-panel max-w-sm w-full shadow-2xl text-center font-black">
      <h3 class="text-2xl font-black mb-8 text-theme-main underline decoration-indigo-500 text-center">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙØ¦Ø© âš™ï¸
      </h3>
      <div id="modal-categories-grid" class="grid grid-cols-2 gap-4 mb-10 text-center text-white"></div>
      <button onclick="closeCategoryModal()"
        class="w-full py-5 btn-gradient rounded-3xl font-black text-white text-xl text-center">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isMuted = false;
    let isVibrationEnabled = true;
    let isDarkMode = true;

    // Settings
    function openSettingsModal() { document.getElementById('modal-settings').classList.remove('hidden'); document.getElementById('modal-settings').classList.add('flex'); updateSettingsUI(); }
    function closeSettingsModal() { document.getElementById('modal-settings').classList.add('hidden'); document.getElementById('modal-settings').classList.remove('flex'); }
    function toggleMute() { isMuted = !isMuted; updateSettingsUI(); }
    function toggleVibration() { isVibrationEnabled = !isVibrationEnabled; if (isVibrationEnabled) triggerVibrate(50); updateSettingsUI(); }
    function toggleTheme() { isDarkMode = !isDarkMode; document.body.classList.toggle('light-mode', !isDarkMode); updateSettingsUI(); }
    function updateSettingsUI() {
      document.getElementById('lbl-mute').innerText = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      document.getElementById('lbl-vibe').innerText = isVibrationEnabled ? 'ğŸ“³' : 'ğŸ“´';
      document.getElementById('lbl-theme').innerText = isDarkMode ? 'ğŸŒ™' : 'â˜€ï¸';
    }

    // Helpers
    function formatTimeLabel(s) { const m = Math.floor(s / 60); const sc = s % 60; return sc === 0 ? `${m} Ø¯Ù‚Ø§Ø¦Ù‚` : `${m} Ø¯Ù‚ÙŠÙ‚Ø© Ùˆ${sc} Ø«Ø§Ù†ÙŠØ©`; }
    function triggerVibrate(p) { if (isVibrationEnabled && navigator.vibrate) navigator.vibrate(p); }
    function playTone(f, d, t = 'sine', v = 0.1) { if (isMuted) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = t; o.frequency.setValueAtTime(f, audioCtx.currentTime); g.gain.setValueAtTime(v, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + d); o.start(); o.stop(audioCtx.currentTime + d); }
    function playFlipSound() { if (isMuted) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'triangle'; o.frequency.setValueAtTime(400, audioCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2); o.start(); o.stop(audioCtx.currentTime + 0.2); }
    function playFunnySound() { if (isMuted) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.type = 'sawtooth'; o.frequency.setValueAtTime(300, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(150, audioCtx.currentTime + 0.2); o.frequency.linearRampToValueAtTime(300, audioCtx.currentTime + 0.4); o.frequency.linearRampToValueAtTime(150, audioCtx.currentTime + 0.6); g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.6); o.start(); o.stop(audioCtx.currentTime + 0.6); }

    const sounds = {
      tick: () => { playTone(800, 0.05, 'sine', 0.03); triggerVibrate(15); },
      win: () => { playTone(523, 0.1); setTimeout(() => playTone(659, 0.1), 100); setTimeout(() => playTone(783, 0.3), 200); triggerVibrate([100, 50, 100]); },
      lose: () => { playTone(150, 0.6, 'sawtooth', 0.15); triggerVibrate([200, 100, 200]); },
      wrong: () => { playTone(100, 0.5, 'square', 0.2); triggerVibrate(300); },
      flip: () => { playFlipSound(); triggerVibrate(40); },
      funny: () => { playFunnySound(); triggerVibrate([50, 50, 50, 50, 50]); }
    };

    const wordBank = {
      "Ø·Ø¹Ø§Ù…": [{ word: "Ø¨ÙŠØªØ²Ø§", emoji: "ğŸ•", desc: "Ø£ÙƒÙ„Ø© Ø¥ÙŠØ·Ø§Ù„ÙŠØ©.", related: "ÙØ·ÙŠØ±Ø©" }, { word: "ÙƒØ¨Ø³Ø©", emoji: "ğŸ›", desc: "Ø±Ø² ÙˆÙ„Ø­Ù….", related: "Ù…Ù†Ø¯ÙŠ" }, { word: "Ø¨Ø±Ø¬Ø±", emoji: "ğŸ”", desc: "Ù„Ø­Ù… Ù…Ø´ÙˆÙŠ.", related: "Ø³Ø§Ù†Ø¯ÙˆØªØ´" }, { word: "Ø´Ø§ÙˆØ±Ù…Ø§", emoji: "ğŸŒ¯", desc: "Ù„Ø­Ù… Ø¨Ø®Ø¨Ø² ØµØ§Ø¬.", related: "ÙÙ„Ø§ÙÙ„" }, { word: "Ø³ÙˆØ´ÙŠ", emoji: "ğŸ£", desc: "Ø³Ù…Ùƒ ÙŠØ§Ø¨Ø§Ù†ÙŠ.", related: "Ø±ÙˆØ¨ÙŠØ§Ù†" }],
      "Ø£Ø¯ÙˆØ§Øª": [{ word: "Ø´Ø§Ø­Ù†", emoji: "ğŸ”Œ", desc: "ÙŠØ´Ø­Ù† Ø§Ù„Ø·Ø§Ù‚Ø©.", related: "ØªÙˆØµÙŠÙ„Ø©" }, { word: "Ù…ÙƒÙŠÙ", emoji: "â„ï¸", desc: "ÙŠØ¨Ø±Ø¯ Ø§Ù„Ø¬Ùˆ.", related: "Ù…Ø±ÙˆØ­Ø©" }],
      "Ù…Ø§Ø±ÙƒØ§Øª": [{ word: "Ø£Ø¨Ù„", emoji: "ğŸ", desc: "Ø¢ÙŠÙÙˆÙ†.", related: "Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬" }, { word: "Ù†Ø§ÙŠÙƒÙŠ", emoji: "âœ”ï¸", desc: "Ø±ÙŠØ§Ø¶Ø©.", related: "Ø£Ø¯ÙŠØ¯Ø§Ø³" }],
      "Ø­ÙŠÙˆØ§Ù†Ø§Øª": [{ word: "Ø£Ø³Ø¯", emoji: "ğŸ¦", desc: "Ù…Ù„Ùƒ Ø§Ù„ØºØ§Ø¨Ø©.", related: "Ù†Ù…Ø±" }, { word: "Ø¬Ù…Ù„", emoji: "ğŸª", desc: "Ø³ÙÙŠÙ†Ø© Ø§Ù„ØµØ­Ø±Ø§Ø¡.", related: "Ù†Ø§Ù‚Ø©" }],
      "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§": [{ word: "Ø¬ÙˆØ§Ù„", emoji: "ğŸ“±", desc: "Ø§ØªØµØ§Ù„.", related: "Ø§ÙŠØ¨Ø§Ø¯" }, { word: "Ù„Ø§Ø¨ØªÙˆØ¨", emoji: "ğŸ’»", desc: "ÙƒÙ…Ø¨ÙŠÙˆØªØ± Ù…Ø­Ù…ÙˆÙ„.", related: "Ø¨ÙŠ Ø³ÙŠ" }],
      "Ø£Ù„Ø¹Ø§Ø¨": [{ word: "Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†", emoji: "ğŸ®", desc: "Ø¬Ù‡Ø§Ø² Ø£Ù„Ø¹Ø§Ø¨ Ø³ÙˆÙ†ÙŠ.", related: "Ø§ÙƒØ³ Ø¨ÙˆÙƒØ³" }, { word: "ÙÙŠÙØ§", emoji: "âš½", desc: "Ù„Ø¹Ø¨Ø© ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù….", related: "Ø¨ÙŠØ³" }],
      "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": [{ word: "Ù‚Ù‡ÙˆØ©", emoji: "â˜•", desc: "Ù…Ø´Ø±ÙˆØ¨ ÙŠØ¹Ø¯Ù„ Ø§Ù„Ù…Ø²Ø§Ø¬.", related: "Ø´Ø§ÙŠ" }, { word: "Ø­Ù…Ø¶ÙŠØ§Øª", emoji: "ğŸŠ", desc: "Ù…Ø´Ø±ÙˆØ¨ ØºØ§Ø²ÙŠ Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ.", related: "Ù…ÙŠØ±Ù†Ø¯Ø§" }],
      "Ø£Ù…Ø§ÙƒÙ†": [{ word: "Ù…ÙƒØ©", emoji: "ğŸ•‹", desc: "Ø§Ù„ÙƒØ¹Ø¨Ø©.", related: "Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©" }, { word: "Ø¨Ø§Ø±ÙŠØ³", emoji: "ğŸ—¼", desc: "ÙØ±Ù†Ø³Ø§.", related: "Ù„Ù†Ø¯Ù†" }],
      "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©": []
    };
    const avatars = ["ğŸ•µï¸", "ğŸ‘¤", "ğŸ‘®", "ğŸ§‘â€ğŸš€", "ğŸ§™", "ğŸ¦", "ğŸ¦Š", "ğŸ¼", "ğŸ¤–", "ğŸ¦‰", "ğŸ¦’"];
    const funnyTitles = ["Ù…Ø¨ØªØ¯Ø¦", "Ù‡Ø§ÙˆÙŠ", "Ù…Ø­ØªØ±Ù", "Ø®Ø¨ÙŠØ±", "Ø£Ø³Ø·ÙˆØ±Ø©"];
    const roleNamesMap = { 'in': 'ğŸ•µï¸ Ù…Ø­Ù‚Ù‚', 'out': 'ğŸŒ«ï¸ Ø§Ù„Ø¶Ø§ÙŠØ¹', 'agent': 'ğŸ­ Ø¹Ù…ÙŠÙ„', 'undercover': 'ğŸ¤« Ø§Ù„Ù…Ù…ÙˆÙ‡' };

    let state = {
      players: [], currentRoles: [], secretData: null, timer: 60, initialTimer: 60, interval: null,
      revealIndex: 0, isPaused: false, doubleAgentActive: false, undercoverActive: false, guessingEnabled: true,
      outPlayerIds: [], agentPlayerId: null, undercoverPlayerId: null, selectedCategory: "Ø¹Ø´ÙˆØ§Ø¦ÙŠ",
      customWords: [], lastWinner: null, votingMode: 'group', voterIndex: 0, votesAccumulated: {}, panicMode: false,
      smartDistractors: false, blindModeActive: false, blindRoundType: null, guessInterval: null
    };

    function showScreen(screenId) {
      document.querySelectorAll('#app > div').forEach(div => div.classList.add('hidden'));
      const target = document.getElementById(`screen-${screenId}`);
      if (target) { target.classList.remove('hidden'); target.scrollTop = 0; window.scrollTo(0, 0); }
      if (screenId === 'setup') renderCategories('categories-grid');
      if (screenId === 'leaderboard') { updateLeaderboardUI(); checkResetButtonVisibility(); }
      if (screenId === 'final') updateFinalResultsUI();
    }

    function closeModal() {
      ['modal-stats', 'modal-alert', 'modal-confirm', 'modal-category', 'modal-settings'].forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.classList.add('hidden'); el.classList.remove('flex'); }
      });
    }
    function closeStatsModal() { document.getElementById('modal-stats').classList.add('hidden'); }
    function closeAlert() { document.getElementById('modal-alert').classList.add('hidden'); }
    function openCategoryModal() { const m = document.getElementById('modal-category'); if (m) { m.classList.remove('hidden'); m.classList.add('flex'); renderCategories('modal-categories-grid'); } }
    function closeCategoryModal() { const m = document.getElementById('modal-category'); if (m) { m.classList.add('hidden'); m.classList.remove('flex'); } }
    function checkResetButtonVisibility() {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const hasData = saved.some(p => (p.points || 0) > 0);
      const trigger = document.getElementById('btn-reset-points-trigger');
      if (trigger) trigger.classList.toggle('hidden', !hasData);
    }
    function confirmReset() {
      const modal = document.getElementById('modal-confirm');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function renderCategories(gridId) {
      const grid = document.getElementById(gridId);
      if (!grid) return; grid.innerHTML = '';
      const icons = { "Ø·Ø¹Ø§Ù…": "ğŸ”", "Ø£Ø¯ÙˆØ§Øª": "ğŸ› ï¸", "Ù…Ø§Ø±ÙƒØ§Øª": "ğŸ·ï¸", "Ø­ÙŠÙˆØ§Ù†Ø§Øª": "ğŸ¾", "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§": "ğŸ’»", "Ø£Ù„Ø¹Ø§Ø¨": "ğŸ®", "Ù…Ø´Ø±ÙˆØ¨Ø§Øª": "â˜•", "Ø£Ù…Ø§ÙƒÙ†": "ğŸ•‹", "Ø¯ÙˆÙ„": "ğŸŒ", "Ø¹Ø·ÙˆØ±": "ğŸ§´", "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©": "âœï¸", "Ø¹Ø´ÙˆØ§Ø¦ÙŠ": "ğŸ²" };
      grid.innerHTML += `<div onclick="selectCategory('Ø¹Ø´ÙˆØ§Ø¦ÙŠ', '${gridId}')" class="category-card ${state.selectedCategory === 'Ø¹Ø´ÙˆØ§Ø¦ÙŠ' ? 'active' : ''}"><span>ğŸ²</span><span class="text-xs">Ø¹Ø´ÙˆØ§Ø¦ÙŠ</span></div>`;
      Object.keys(wordBank).forEach(cat => {
        if (gridId === 'modal-categories-grid' && cat === "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©" && state.customWords.length < 4) return;
        const isActive = state.selectedCategory === cat;
        const emoji = icons[cat] || 'ğŸ·ï¸';
        grid.innerHTML += `<div onclick="selectCategory('${cat}', '${gridId}')" class="category-card ${isActive ? 'active' : ''}"><span>${emoji}</span><span class="text-xs font-bold">${cat}</span></div>`;
      });
    }

    function selectCategory(cat, gridId) {
      state.selectedCategory = cat;
      renderCategories(gridId); sounds.tick();
      if (gridId === 'categories-grid') document.getElementById('custom-words-ui').classList.toggle('hidden', cat !== "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©");
    }

    function addCustomWord() {
      const input = document.getElementById('custom-word-input');
      const word = input.value.trim();
      if (word) {
        state.customWords.push({ word, emoji: "âœï¸", desc: "Ø³Ø§Ù„ÙØ© Ø®Ø§ØµØ©." });
        input.value = ''; renderCustomWords(); renderCategories('categories-grid');
      }
    }
    function renderCustomWords() {
      const list = document.getElementById('custom-words-list');
      if (!list) return; list.innerHTML = '';
      state.customWords.forEach((w, i) => { list.innerHTML += `<span class="bg-indigo-500/20 px-2 py-1 rounded-full text-xs text-theme-main">${w.word} <button onclick="state.customWords.splice(${i},1);renderCustomWords();">Ã—</button></span>`; });
      wordBank["ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©"] = state.customWords;
    }

    function setVotingMode(mode) {
      state.votingMode = mode;
      const groupBtn = document.getElementById('btn-vote-group');
      const indivBtn = document.getElementById('btn-vote-individual');
      if (mode === 'group') {
        groupBtn.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-indigo-600 text-white shadow-lg";
        indivBtn.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-theme-main";
      } else {
        indivBtn.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all bg-indigo-600 text-white shadow-lg";
        groupBtn.className = "px-4 py-1.5 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-theme-main";
      }
      sounds.tick();
    }

    function updateSetupInfo() {
      const pVal = document.getElementById('input-players').value;
      const tVal = document.getElementById('input-time').value;
      document.getElementById('val-players').innerText = pVal;
      document.getElementById('val-time-label').innerText = formatTimeLabel(tVal);

      const avail = parseInt(pVal) >= 5;
      document.getElementById('double-agent-container').classList.toggle('opacity-30', !avail);
      document.getElementById('undercover-container').classList.toggle('opacity-30', !avail);
      if (!avail) {
        document.getElementById('check-double-agent').checked = false;
        document.getElementById('check-undercover').checked = false;
      }
      toggleSmartSettings();
    }

    function toggleSmartSettings() {
      const guessingEnabled = document.getElementById('check-guessing').checked;
      const blindMode = document.getElementById('check-blind-mode').checked;
      const smartContainer = document.getElementById('smart-distractors-container');

      if (smartContainer) {
        if (guessingEnabled && !blindMode) {
          smartContainer.classList.remove('hidden'); smartContainer.classList.add('flex');
        } else {
          smartContainer.classList.add('hidden'); smartContainer.classList.remove('flex');
        }
      }
    }

    function checkAndNext() { initPlayerNames(); }

    function initPlayerNames() {
      const count = parseInt(document.getElementById('input-players').value);
      const container = document.getElementById('names-container');
      if (!container) return; container.innerHTML = '';
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      for (let i = 0; i < count; i++) {
        const p = saved[i] || { name: `Ø§Ù„Ù…Ø­Ù‚Ù‚ ${i + 1}`, avatar: avatars[i % avatars.length] };
        container.innerHTML += `<div class="bg-card-theme p-4 rounded-3xl border border-white/10 shadow-inner text-right"><div class="flex gap-3 mb-3 flex-row-reverse text-right"><input type="text" id="name-${i}" value="${p.name}" class="player-input flex-1 bg-white/5 border-none rounded-2xl p-3 text-theme-main font-bold outline-none focus:ring-2 ring-indigo-500 text-right"><input type="hidden" id="avatar-${i}" value="${p.avatar}"></div><div class="flex flex-wrap gap-2 justify-center">${avatars.map(a => `<button onclick="setAvatar(${i}, '${a}')" id="av-${i}-${a}" class="avatar-btn ${a === p.avatar ? 'selected' : ''}">${a}</button>`).join('')}</div></div>`;
      }
      showScreen('names');
    }

    function setAvatar(pIdx, av) {
      document.querySelectorAll(`#names-container > div:nth-child(${pIdx + 1}) .avatar-btn`).forEach(b => b.classList.remove('selected'));
      document.getElementById(`av-${pIdx}-${av}`).classList.add('selected');
      document.getElementById(`avatar-${pIdx}`).value = av;
    }

    function startGame() {
      const count = parseInt(document.getElementById('input-players').value);
      state.players = [];
      const savedData = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      for (let i = 0; i < count; i++) {
        const nameInp = document.getElementById(`name-${i}`);
        const name = nameInp ? nameInp.value.trim() : `Ù„Ø§Ø¹Ø¨ ${i + 1}`;
        const avatar = document.getElementById(`avatar-${i}`).value;
        const existing = savedData[i];
        state.players.push({
          id: i, name, avatar,
          points: existing ? (existing.points || 0) : 0,
          stats: existing?.stats || { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } }
        });
      }
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(state.players));

      state.timer = parseInt(document.getElementById('input-time').value);
      state.initialTimer = state.timer;
      state.doubleAgentActive = document.getElementById('check-double-agent').checked;
      state.undercoverActive = document.getElementById('check-undercover').checked;
      state.guessingEnabled = document.getElementById('check-guessing').checked;
      state.blindModeActive = document.getElementById('check-blind-mode').checked;
      // Force disable smart distractors if blind mode is on
      state.smartDistractors = !state.blindModeActive && document.getElementById('check-smart-distractors').checked;

      setupRoles();
      state.revealIndex = 0; state.panicMode = false;

      const panicBtn = document.getElementById('btn-panic');
      if (panicBtn) {
        if (state.guessingEnabled && state.smartDistractors && !state.blindModeActive) panicBtn.classList.remove('hidden');
        else panicBtn.classList.add('hidden');
      }
      startRevealSequence();
    }

    function setupRoles() {
      let cat = state.selectedCategory;
      if (cat === "Ø¹Ø´ÙˆØ§Ø¦ÙŠ") {
        let keys = Object.keys(wordBank).filter(k => k !== "ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©");
        if (state.customWords.length >= 4) keys.push("ÙƒÙ„Ù…Ø§Øª Ø®Ø§ØµØ©");
        cat = keys[Math.floor(Math.random() * keys.length)];
      }
      state.currentRoundCategory = cat;
      let pool = wordBank[cat] || wordBank["Ø·Ø¹Ø§Ù…"];
      state.secretData = pool[Math.floor(Math.random() * pool.length)];

      let ids = state.players.map(p => p.id).sort(() => 0.5 - Math.random());
      state.outPlayerIds = []; state.agentPlayerId = null; state.undercoverPlayerId = null; state.blindRoundType = null;

      if (state.blindModeActive && Math.random() < 0.35) { // 35% chance for blind round
        if (Math.random() < 0.5) state.blindRoundType = 'all_in'; // No outsider
        else { state.blindRoundType = 'all_out'; state.outPlayerIds = state.players.map(p => p.id); }
      } else {
        let outID = ids.splice(0, 1)[0];
        state.outPlayerIds = [outID];
        if (state.doubleAgentActive && ids.length > 0) state.agentPlayerId = ids.splice(0, 1)[0];
        if (state.undercoverActive && ids.length > 0) state.undercoverPlayerId = ids.splice(0, 1)[0];
      }

      state.currentRoles = state.players.map(p => {
        let role = 'in';
        if (state.blindRoundType === 'all_out') role = 'out';
        else if (state.blindRoundType === 'all_in') role = 'in';
        else {
          if (p.id === (state.outPlayerIds[0])) role = 'out';
          else if (p.id === state.agentPlayerId) role = 'agent';
          else if (p.id === state.undercoverPlayerId) role = 'undercover';
        }
        return { id: p.id, role: role };
      });
    }

    function startRevealSequence() {
      if (state.revealIndex >= state.players.length) return showScreen('game'), startTimer();
      const p = state.players[state.revealIndex];
      document.getElementById('reveal-player-name').innerText = `${p.avatar} ${p.name}`;
      const cardObj = document.getElementById('role-card');
      if (cardObj) cardObj.classList.remove('is-flipped');
      document.getElementById('btn-reveal-action').innerText = 'ÙƒØ´Ù Ø§Ù„Ø¯ÙˆØ±';
      populateCardBack(p);
      showScreen('reveal');
    }

    function populateCardBack(player) {
      const roleData = state.currentRoles.find(r => r.id === player.id);
      const txt = document.getElementById('reveal-role-text');
      const word = document.getElementById('reveal-secret-word');
      const img = document.getElementById('reveal-img-placeholder');
      const desc = document.getElementById('reveal-word-desc');

      if (roleData.role === 'in') {
        txt.innerText = "Ø£Ù†Øª ØªØ¹Ø±Ù Ø§Ù„Ø³Ø§Ù„ÙØ©!"; word.innerText = state.secretData.word;
        img.innerText = state.secretData.emoji; desc.innerText = state.secretData.desc || "";
        txt.className = "text-xl font-bold mb-4 text-emerald-500";
      } else if (roleData.role === 'agent') {
        txt.innerText = "Ø£Ù†Øª Ø§Ù„Ø¹Ù…ÙŠÙ„! Ø§Ø­Ù…Ù Ø§Ù„Ø¶Ø§ÙŠØ¹:"; word.innerText = state.secretData.word;
        img.innerText = "ğŸ­"; desc.innerText = "";
        txt.className = "text-xl font-bold mb-4 text-orange-500";
      } else if (roleData.role === 'undercover') {
        txt.innerText = "Ø£Ù†Øª Ø§Ù„Ù…Ù…ÙˆÙ‡! ÙƒÙ„Ù…ØªÙƒ:"; word.innerText = "Ø³Ø§Ù„ÙØ© Ù‚Ø±ÙŠØ¨Ø©";
        img.innerText = "ğŸ¤«"; desc.innerText = "";
        txt.className = "text-xl font-bold mb-4 text-yellow-500";
      } else {
        txt.innerText = "Ø£Ù†Øª Ø§Ù„Ø¶Ø§ÙŠØ¹!"; word.innerText = "ØŸØŸØŸØŸØŸ"; img.innerText = "ğŸ•µï¸â€â™‚ï¸"; desc.innerText = "ØŸØŸØŸØŸØŸ";
        txt.className = "text-xl font-bold mb-4 text-red-500";
      }
    }

    function flipCard() {
      const cardObj = document.getElementById('role-card');
      if (!cardObj.classList.contains('is-flipped')) {
        cardObj.classList.add('is-flipped'); sounds.flip();
        document.getElementById('btn-reveal-action').innerText = "Ø§Ù„ØªØ§Ù„ÙŠ";
      }
    }

    function toggleReveal() {
      const cardObj = document.getElementById('role-card');
      if (!cardObj.classList.contains('is-flipped')) {
        cardObj.classList.add('is-flipped'); sounds.flip();
        document.getElementById('btn-reveal-action').innerText = "Ø§Ù„ØªØ§Ù„ÙŠ";
      } else {
        cardObj.classList.remove('is-flipped'); sounds.flip();
        setTimeout(() => { state.revealIndex++; startRevealSequence(); }, 300);
      }
    }

    function startTimer() {
      state.isPaused = false; clearInterval(state.interval);
      state.interval = setInterval(() => {
        if (state.isPaused) return;
        state.timer--;
        const circumference = 565.48;
        const progressEl = document.getElementById('timer-progress');
        if (progressEl) progressEl.style.strokeDashoffset = circumference * (1 - (state.timer / state.initialTimer));
        const m = Math.floor(state.timer / 60), s = state.timer % 60;
        document.getElementById('game-timer').innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        if (state.timer <= 5 && state.timer > 0) sounds.tick();
        if (state.timer <= 0) { clearInterval(state.interval); startVoting(); }
      }, 1000);
    }
    function pauseTimer() { state.isPaused = !state.isPaused; document.getElementById('btn-pause').innerText = state.isPaused ? "Ø§Ø³ØªØ¦Ù†Ø§Ù" : "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª"; }
    function endGameEarly() { clearInterval(state.interval); startVoting(); }

    function triggerPanic() {
      clearInterval(state.interval); state.panicMode = true;
      let name = "Ø§Ù„Ø¶Ø§ÙŠØ¹";
      if (state.blindRoundType === 'all_out') name = "Ø§Ù„ÙƒÙ„";
      else if (state.outPlayerIds.length > 0) {
        const p = state.players.find(x => x.id === state.outPlayerIds[0]);
        if (p) name = p.name;
      }
      startGuessingPhase(name, true);
    }

    function startVoting() {
      state.voterIndex = 0; state.votesAccumulated = {};
      state.players.forEach(p => state.votesAccumulated[p.id] = 0);
      updateVotingGrid(); showScreen('voting');
    }

    function updateVotingGrid() {
      const grid = document.getElementById('voting-grid'); grid.innerHTML = '';
      if (state.votingMode === 'individual') {
        const voter = state.players[state.voterIndex];
        document.getElementById('voter-indicator').innerText = `Ø¯ÙˆØ±: ${voter.avatar} ${voter.name}`;
        document.getElementById('voter-indicator').classList.remove('hidden');
      } else {
        document.getElementById('voter-indicator').classList.add('hidden');
      }
      state.players.forEach(p => {
        if (state.votingMode === 'individual' && state.players[state.voterIndex].id === p.id) return;
        grid.innerHTML += `<button onclick="handleVoteClick(${p.id})" class="p-4 bg-white/5 border border-white/10 rounded-3xl flex flex-col items-center gap-2 active:bg-indigo-500/20 text-theme-main"><span class="text-4xl">${p.avatar}</span><span class="font-bold text-xs">${p.name}</span></button>`;
      });
    }

    function handleVoteClick(id) {
      if (state.votingMode === 'group') processVoteResult(id);
      else {
        state.votesAccumulated[id]++; state.voterIndex++; sounds.tick();
        if (state.voterIndex < state.players.length) updateVotingGrid();
        else {
          let maxV = -1, winnerId = null;
          for (const pid in state.votesAccumulated) {
            if (state.votesAccumulated[pid] > maxV) { maxV = state.votesAccumulated[pid]; winnerId = parseInt(pid); }
          }
          processVoteResult(winnerId);
        }
      }
    }

    function processVoteResult(id) {
      if (state.blindRoundType) {
        const p = state.players.find(x => x.id === id);
        sounds.funny();
        showFinalResults('blind_win', `Ù…Ù‚Ù„Ø¨! ğŸ¤£ ${p ? p.name : ''} Ø¨Ø±ÙŠØ¡! Ù…Ø§ ÙƒØ§Ù† ÙÙŠÙ‡ Ø¶Ø§ÙŠØ¹!`);
        return;
      }
      const isOut = state.outPlayerIds.includes(id);
      if (isOut) {
        if (state.guessingEnabled) {
          const p = state.players.find(x => x.id === id);
          startGuessingPhase(p ? p.name : null);
        } else showFinalResults('group_win', "ÙƒÙÙˆ! ØµØ¯ØªÙˆØ§ Ø§Ù„Ø¶Ø§ÙŠØ¹ ğŸ•µï¸â€â™‚ï¸");
      } else if (id === state.undercoverPlayerId) {
        showFinalResults('out_win', "Ø§Ù„Ù…Ù…ÙˆÙ‡ Ø®Ø¯Ø¹ÙƒÙ…! ğŸ¤« ÙØ§Ø² Ø§Ù„Ø¶Ø§ÙŠØ¹");
      } else {
        sounds.wrong();
        document.body.classList.add('wrong-flash-active');
        setTimeout(() => { document.body.classList.remove('wrong-flash-active'); showFinalResults('out_win', "Ø®Ø·Ø£! Ø§Ù„Ø¶Ø§ÙŠØ¹ ÙØ§Ø² ğŸ˜ˆ"); }, 600);
      }
    }

    function startGuessingPhase(name, isPanic = false) {
      const container = document.getElementById('guess-options'); container.innerHTML = '';
      const titleEl = document.getElementById('guess-title');
      if (isPanic) {
        titleEl.innerText = "ğŸš¨ ØªØ®Ù…ÙŠÙ† Ø§Ù„Ù‡Ù„Ø¹!";
        titleEl.className = "text-2xl font-black mb-6 text-orange-500";
      } else {
        titleEl.innerText = `ÙØ±ØµØ© Ø£Ø®ÙŠØ±Ø© ÙŠØ§ ${name || 'Ø¶Ø§ÙŠØ¹'}!`;
        titleEl.className = "text-xl font-black mb-4 text-red-500";
      }

      // Timer logic for panic/guess
      if (state.guessInterval) clearInterval(state.guessInterval);
      if (isPanic) {
        document.getElementById('guess-timer-container').classList.remove('hidden');
        let t = 30; document.getElementById('guess-timer').innerText = t;
        state.guessInterval = setInterval(() => {
          t--; document.getElementById('guess-timer').innerText = t;
          if (t <= 5) sounds.tick();
          if (t <= 0) { clearInterval(state.guessInterval); showFinalResults('group_win', "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! â³"); }
        }, 1000);
      } else document.getElementById('guess-timer-container').classList.add('hidden');

      let pool = wordBank[state.currentRoundCategory] || wordBank["Ø·Ø¹Ø§Ù…"];
      let distractors = pool.filter(w => w.word !== state.secretData.word).sort(() => 0.5 - Math.random()).slice(0, 3);
      let options = [...distractors, state.secretData].sort(() => 0.5 - Math.random());

      options.forEach(opt => {
        container.innerHTML += `<button onclick="checkGuess('${opt.word}')" class="w-full py-4 bg-white/5 rounded-2xl text-lg font-bold border border-white/5 text-theme-main">${opt.word}</button>`;
      });
      showScreen('guess');
    }

    function checkGuess(word) {
      if (state.guessInterval) clearInterval(state.guessInterval);
      if (word === state.secretData.word) {
        if (state.panicMode) showFinalResults('out_win', "ØªØ®Ù…ÙŠÙ† Ø£Ø³Ø·ÙˆØ±ÙŠ! (Ù†Ù‚Ø§Ø· Ù…Ø¶Ø§Ø¹ÙØ©) ğŸ”¥");
        else showFinalResults('out_win', "ØªØ®Ù…ÙŠÙ† ØµØ­! Ø§Ù„Ø¶Ø§ÙŠØ¹ ÙØ§Ø² ğŸ§ ");
      } else {
        showFinalResults('group_win', "ØªØ®Ù…ÙŠÙ† Ø®Ø·Ø£! Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ† ÙØ§Ø²ÙˆØ§ âš–ï¸");
      }
    }

    function showFinalResults(type, title) {
      state.lastWinner = type === 'group_win' ? 'group' : (type === 'blind_win' ? 'blind' : 'out');
      document.getElementById('final-result-title').innerText = title;
      document.getElementById('final-status-emoji').innerText = type === 'blind_win' ? 'ğŸ¤¡' : (type === 'group_win' ? 'ğŸ†' : 'ğŸ˜ˆ');
      document.getElementById('final-secret-word').innerText = state.secretData.word;
      document.getElementById('final-word-emoji').innerText = state.secretData.emoji;
      document.getElementById('topic-description').innerText = state.secretData.desc || "";

      if (type === 'group_win') { sounds.win(); createConfetti(); }
      else if (type === 'blind_win') { createConfetti(true); }
      else sounds.lose();

      awardPoints(state.lastWinner);
      showScreen('final');
    }

    function awardPoints(winner) {
      let saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      saved = saved.map(p => {
        const roleData = state.currentRoles.find(r => r.id === p.id);
        if (!roleData) return p;
        const isOutSide = ['out', 'agent', 'undercover'].includes(roleData.role);

        if (winner === 'blind') p.points += 1;
        else if (winner === 'group') {
          if (!isOutSide) { p.points += (state.panicMode ? 2 : 1); if (p.stats) p.stats.det.w++; }
          else if (p.stats) { if (roleData.role == 'out') p.stats.out.l++; if (roleData.role == 'agent') p.stats.agt.l++; }
        } else {
          if (isOutSide) {
            let pts = 2; if (roleData.role === 'out' && state.panicMode) pts = 4;
            p.points += pts;
            if (p.stats) { if (roleData.role == 'out') p.stats.out.w++; if (roleData.role == 'agent') p.stats.agt.w++; }
          } else if (p.stats) p.stats.det.l++;
        }
        return p;
      });
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(saved));
      state.players = saved;
    }

    function updateFinalResultsUI() {
      const list = document.getElementById('final-leaderboard');
      if (!list) return; list.innerHTML = '';
      state.players.forEach(p => {
        const roleData = state.currentRoles.find(r => r.id === p.id);
        if (!roleData) return;
        const isOutSide = ['out', 'agent', 'undercover'].includes(roleData.role);
        let didWin = false;
        if (state.lastWinner === 'group' && !isOutSide) didWin = true;
        if ((state.lastWinner === 'out') && isOutSide) didWin = true;
        if (state.lastWinner === 'blind') didWin = true;

        const colorClass = didWin ? 'bg-emerald-500/20 border-emerald-500/40 text-emerald-500' : 'bg-red-500/20 border-red-500/40 text-red-500';
        list.innerHTML += `<div class="flex items-center justify-between p-3 rounded-2xl border ${colorClass} mb-2 shadow-inner text-right"><div class="flex items-center gap-3"><span class="text-2xl">${p.avatar}</span><div class="text-right"><p class="font-black text-theme-main text-sm text-right">${p.name}</p><p class="text-[8px] uppercase opacity-60 text-theme-main text-right">${roleNamesMap[roleData.role]}</p></div></div><span class="font-mono text-xs font-black text-theme-main">${p.points}</span></div>`;
      });
    }

    function updateLeaderboardUI() {
      const list = document.getElementById('leaderboard-list');
      if (!list) return;
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const sorted = [...saved].sort((a, b) => b.points - a.points);
      list.innerHTML = '';
      sorted.forEach((p, idx) => {
        const title = funnyTitles[Math.min(Math.floor(p.points / 3), 4)];
        list.innerHTML += `<div onclick="openStatsModal(${p.id})" class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 cursor-pointer text-right"><div class="flex items-center gap-4 text-right"><span class="text-3xl">${p.avatar}</span><div class="text-right"><p class="font-black text-theme-main text-right">${p.name}</p><p class="text-[10px] text-indigo-400 font-bold text-right">${title}</p></div></div><span class="bg-indigo-500/20 px-3 py-1 rounded-full font-mono text-sm font-black text-indigo-200">${p.points}</span></div>`;
      });
    }

    function restartSameGame() {
      state.timer = state.initialTimer;
      setupRoles();
      state.revealIndex = 0;
      state.panicMode = false;
      startRevealSequence();
    }

    function resetPoints() {
      const saved = JSON.parse(localStorage.getItem('out_loop_tablet_v4_players') || '[]');
      const reset = saved.map(p => ({ ...p, points: 0, stats: { det: { w: 0, l: 0 }, out: { w: 0, l: 0 }, agt: { w: 0, l: 0 }, und: { w: 0, l: 0 } } }));
      localStorage.setItem('out_loop_tablet_v4_players', JSON.stringify(reset));
      state.players = reset;
      closeModal(); updateLeaderboardUI(); checkResetButtonVisibility();
    }

    function createConfetti(isClown = false) {
      const container = document.getElementById('confetti-container');
      if (!container) return;
      container.innerHTML = '';
      const colors = ['#6366f1', '#10b981', '#ef4444', '#fbbf24', '#f472b6'];
      const clowns = ['ğŸ¤¡', 'ğŸ¤£', 'ğŸ¤ª', 'ğŸª', 'ğŸ™ˆ'];
      const count = isClown ? 100 : 80;
      for (let i = 0; i < count; i++) {
        const c = document.createElement('div');
        c.style.left = Math.random() * 100 + 'vw';
        if (isClown) {
          c.className = 'emoji-drop text-4xl';
          c.innerText = clowns[Math.floor(Math.random() * clowns.length)];
          c.style.animationDuration = (2 + Math.random() * 3) + 's';
        } else {
          c.className = 'confetti-piece';
          c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          c.style.top = '-20px';
          c.animate([{ transform: 'translateY(0) rotate(0deg)', opacity: 1 }, { transform: `translateY(100vh) rotate(720deg)`, opacity: 0 }], { duration: 2000 + Math.random() * 2000 });
        }
        container.appendChild(c);
      }
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    window.addEventListener('DOMContentLoaded', () => {
      updateSetupInfo();
      renderCustomWords();
    });
  </script>
</body>

</html>